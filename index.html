<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Advice Request Form - SOA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
:root {
    --primary: #2c3e50;
    --secondary: #3498db;
    --accent: #1abc9c;
    --light: #ecf0f1;
    --danger: #e74c3c;
    --success: #2ecc71;
    --dark: #34495e;
    --text: #2c3e50;
    --border-radius: 8px;
    --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    --transition: all 0.3s ease;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    background-color: #f5f7fa;
    color: var(--text);
    line-height: 1.6;
    padding: 20px;
}

/* Draft Selector */
.draft-selector {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 15px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 10px;
    max-width: 550px;
}

.draft-selector .btn {
    flex: 1;
    min-width: 90px;
    text-align: center;
    white-space: nowrap;
}

.draft-selector label {
    font-weight: 500;
    margin-bottom: 0;
    white-space: nowrap;
}

.draft-selector select {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    font-size: 14px;
    background: var(--light);
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    padding: 30px;
    position: relative;
    margin-top: 80px;
}

h1 {
    color: var(--primary);
    text-align: center;
    margin-bottom: 30px;
    font-weight: 600;
    position: relative;
    padding-bottom: 15px;
}

h1:after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 4px;
    background: var(--accent);
    border-radius: 2px;
}

h2 {
    color: var(--secondary);
    margin: 25px 0 15px;
    font-weight: 500;
    font-size: 1.4rem;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--light);
}

h2 i {
    margin-right: 10px;
}

h3 {
    margin-top: 20px;
    margin-bottom: 10px;
    color: var(--dark);
}

h4 {
    margin-top: 15px;
    margin-bottom: 10px;
    color: var(--dark);
    font-size: 1.1rem;
}

.section {
    margin-bottom: 30px;
    padding: 20px;
    border-radius: var(--border-radius);
    background: white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    border-left: 4px solid var(--accent);
    opacity: 1;
    height: auto;
    overflow: hidden;
    transition: var(--transition);
    page-break-inside: avoid;
}

.section.hidden {
    opacity: 0;
    height: 0;
    padding: 0;
    margin: 0;
    overflow: hidden;
}

.form-group {
    margin-bottom: 20px;
}

label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--dark);
}

input[type="text"],
input[type="date"],
input[type="number"],
textarea,
select {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    font-size: 16px;
    transition: var(--transition);
    background: var(--light);
}

input[type="text"]:focus,
input[type="date"]:focus,
input[type="number"]:focus,
textarea:focus,
select:focus {
    border-color: var(--secondary);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    outline: none;
}

textarea {
    min-height: 100px;
    resize: vertical;
    font-family: inherit;
    line-height: 1.5;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.btn {
    display: inline-block;
    background: var(--secondary);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: var(--transition);
    text-align: center;
    text-decoration: none;
}

.btn:hover {
    background: var(--primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.btn-success {
    background: var(--success);
}

.btn-success:hover {
    background: #27ae60;
}

.btn-danger {
    background: var(--danger);
}

.btn-primary {
    background: var(--primary);
}

.btn-secondary {
    background: #6c757d;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 14px;
}

.btn-icon {
    padding: 8px 12px;
    font-size: 14px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.btn-group {
    display: flex;
    gap: 10px;
    margin-top: 30px;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 30px;
}

.radio-group {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
}

.radio-item {
    display: flex;
    align-items: center;
    background: var(--light);
    border-radius: var(--border-radius);
    padding: 10px 15px;
    cursor: pointer;
    transition: var(--transition);
}

.radio-item:hover {
    background: rgba(52, 152, 219, 0.1);
}

.radio-item input[type="radio"] {
    margin-right: 10px;
}

.radio-item label {
    display: flex;
    align-items: center;
    margin-bottom: 0;
    cursor: pointer;
}

.radio-item label i {
    margin-right: 8px;
    font-size: 18px;
    color: var(--secondary);
}

.checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.checkbox-group.client-types {
    justify-content: flex-start;
}

.checkbox-group.entity-types {
    justify-content: flex-start;
}

.checkbox-item {
    display: flex;
    align-items: center;
    background: var(--light);
    padding: 10px 15px;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: var(--transition);
    border: 2px solid transparent;
}

.checkbox-item:hover {
    background: rgba(52, 152, 219, 0.1);
}

.checkbox-item.selected {
    border-color: var(--accent);
    background-color: rgba(26, 188, 156, 0.1);
}

.checkbox-item input[type="checkbox"] {
    margin-right: 8px;
}

.checkbox-item label {
    display: flex;
    align-items: center;
    margin-bottom: 0;
    cursor: pointer;
}

.checkbox-item label i {
    margin-right: 8px;
    font-size: 18px;
    color: var(--secondary);
}

.grid-2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.grid-3 {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
}

@media (max-width: 768px) {
    .grid-3 {
        grid-template-columns: 1fr;
    }
}

.grid-3-custom {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    align-items: end;
}

.note {
    background-color: rgba(52, 152, 219, 0.1);
    border-left: 4px solid var(--secondary);
    padding: 15px;
    border-radius: var(--border-radius);
    margin: 20px 0;
}

.note p {
    margin: 0;
}

/* For the checklist */
.checklist-item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    padding: 10px;
    background-color: var(--light);
    border-radius: var(--border-radius);
    page-break-inside: avoid;
}

.checklist-item label {
    margin-bottom: 0;
    margin-left: 10px;
    cursor: pointer;
}

.sub-checklist {
    margin-left: 30px;
    margin-top: 10px;
    padding: 10px;
    background-color: rgba(52, 152, 219, 0.05);
    border-radius: var(--border-radius);
}

/* Toggle Switch for Yes/No */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: var(--success);
}

input:focus + .slider {
    box-shadow: 0 0 1px var(--success);
}

input:checked + .slider:before {
    transform: translateX(26px);
}

.yes-no-label {
    display: flex;
    align-items: center;
    justify-content: flex-start;
}

.yes-no-label label:first-child {
    margin-right: 15px;
}

.yes-no-label span {
    margin-left: 10px;
}

.entity-selector {
    margin-top: 20px;
    display: none;
}

.entity-selector.show {
    display: block;
}

.product-recommendations {
    background-color: rgba(26, 188, 156, 0.05);
    padding: 15px;
    border-radius: var(--border-radius);
    margin-top: 15px;
    page-break-inside: avoid;
}

.product-item {
    background-color: white;
    padding: 15px;
    border-radius: var(--border-radius);
    margin-bottom: 15px;
    border: 1px solid #e0e0e0;
    page-break-inside: avoid;
}

.product-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.add-product-btn {
    margin-top: 10px;
}

.risk-profile-section {
    background-color: rgba(52, 152, 219, 0.05);
    padding: 15px;
    border-radius: var(--border-radius);
    margin-top: 15px;
    page-break-inside: avoid;
}

.inline-checkbox {
    display: inline-flex;
    align-items: center;
    margin-left: 15px;
}

.inline-checkbox input {
    margin-right: 5px;
}

.searchable-select {
    position: relative;
}

.searchable-select input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    font-size: 16px;
    background: var(--light);
}

.dropdown-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 var(--border-radius) var(--border-radius);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    display: none;
}

.dropdown-list.active {
    display: block;
}

.dropdown-item {
    padding: 10px 15px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.dropdown-item:hover {
    background-color: var(--light);
}

.dropdown-item.selected {
    background-color: var(--secondary);
    color: white;
}

.tranching-details {
    margin-top: 10px;
    padding: 10px;
    background-color: rgba(52, 152, 219, 0.05);
    border-radius: var(--border-radius);
}

.mda-section {
    margin-top: 15px;
    padding: 10px;
    background-color: rgba(46, 204, 113, 0.05);
    border-radius: var(--border-radius);
}

.custom-input {
    margin-top: 0;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: none;
    border-radius: var(--border-radius);
    width: 80%;
    max-width: 500px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.3);
}

.modal-content h3 {
    margin-bottom: 20px;
    color: var(--primary);
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.close:hover,
.close:focus {
    color: var(--danger);
    text-decoration: none;
}

.modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
}

/* Auto-save indicator */
.auto-save-indicator {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--success);
    color: white;
    padding: 10px 15px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    display: none;
    align-items: center;
    gap: 8px;
    z-index: 1000;
    font-size: 14px;
}

.auto-save-indicator.show {
    display: flex;
    animation: fadeInOut 2s ease-in-out;
}

@keyframes fadeInOut {
    0% { opacity: 0; transform: translateY(20px); }
    20% { opacity: 1; transform: translateY(0); }
    80% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(-20px); }
}

/* For Word export styling */
.word-export {
    font-family: 'Calibri', 'Arial', sans-serif;
    line-height: 1.5;
    color: #000;
}

.word-export h1 {
    font-size: 24pt;
    margin-bottom: 20pt;
}

.word-export h2 {
    font-size: 18pt;
    margin-top: 20pt;
    margin-bottom: 10pt;
}

.word-export h3 {
    font-size: 14pt;
    margin-top: 15pt;
    margin-bottom: 10pt;
}

.word-export .section {
    margin-bottom: 20pt;
    padding: 15pt;
}

/* New styles for recommendation sections with checkboxes */
.recommendation-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.recommendation-header label {
    margin-bottom: 0;
    flex: 1;
}

.recommendation-checkbox {
    display: flex;
    align-items: center;
    gap: 5px;
    white-space: nowrap;
}

.na-button {
    background: #6c757d;
    margin-left: 10px;
}

.recommendation-section {
    display: flex;
    gap: 20px;
    align-items: flex-start;
}

.recommendation-textarea {
    flex: 2;
}

.risk-profile-inline {
    flex: 1;
    min-width: 250px;
}

.risk-profile-inline .form-group {
    margin-bottom: 0;
}

@media print {
    body {
        background: white;
        padding: 0;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .container {
        box-shadow: none;
        max-width: 100%;
        padding: 20px;
        margin-top: 0;
    }
    
    .btn-group, .no-print, .draft-selector, .auto-save-indicator {
        display: none !important;
    }
    
    .section {
        page-break-inside: avoid;
        box-shadow: none;
        border-left: 2px solid var(--accent);
    }
    
    input, textarea, select {
        border: 1px solid #ddd !important;
        background: white !important;
        min-height: auto !important;
        height: auto !important;
        overflow: visible !important;
        word-wrap: break-word !important;
        white-space: pre-wrap !important;
    }
    
    textarea {
        min-height: 40px !important;
        height: auto !important;
        resize: none !important;
    }
}

/* For responsive design */
@media (max-width: 768px) {
    body {
        padding: 10px;
    }
    
    .container {
        padding: 20px;
        margin-top: 120px;
    }
    
    .draft-selector {
        position: relative;
        top: auto;
        right: auto;
        margin-bottom: 20px;
        max-width: 100%;
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    
    .draft-selector select {
        width: 100%;
    }
    
    .draft-selector .btn {
        width: 100%;
        flex: none;
    }
    
    .grid-2 {
        grid-template-columns: 1fr;
    }
    
    .grid-3 {
        grid-template-columns: 1fr;
    }
    
    .checkbox-group.client-types {
        flex-direction: column;
    }
    
    .radio-group {
        flex-direction: column;
    }
    
    .btn-group {
        flex-direction: column;
        align-items: stretch;
    }
    
    .modal-content {
        width: 95%;
        margin: 10% auto;
    }
    
    .recommendation-section {
        flex-direction: column;
    }
    
    .risk-profile-inline {
        min-width: auto;
    }
}
    </style>
</head>
<body>
    <!-- Draft Selector -->
    <div class="draft-selector">
        <label for="draftSelector">Load Draft:</label>
        <select id="draftSelector">
            <option value="">Select a saved draft...</option>
        </select>
        <button type="button" class="btn btn-sm" id="loadDraftBtn">Load</button>
        <button type="button" class="btn btn-success btn-sm" id="shareAsLinkBtn">Share as Link</button>
        <button type="button" class="btn btn-danger btn-sm" id="deleteDraftBtn">Delete</button>
    </div>

    <div class="container">
        <h1>Statement of Advice Request Form</h1>
        
        <!-- Client Type Section -->
        <section class="section" id="clientTypeSection">
            <h2><i class="fas fa-user-circle"></i> Client Details</h2>
            
            <!-- New/Existing Client Selector -->
            <div class="form-group">
                <label>Client Status:</label>
                <div class="radio-group">
                    <div class="radio-item">
                        <input type="radio" id="newClient" name="clientStatus" value="new">
                        <label for="newClient">
                            <i class="fas fa-plus-circle"></i>
                            New Client
                        </label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="existingClient" name="clientStatus" value="existing">
                        <label for="existingClient">
                            <i class="fas fa-user-check"></i>
                            Existing Client
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Client Type Selector -->
            <div class="form-group">
                <label>Select Client Type (multiple selections allowed):</label>
                <div class="checkbox-group client-types">
                    <div class="checkbox-item">
                        <input type="checkbox" id="singleClient" name="clientType" value="single">
                        <label for="singleClient">
                            <i class="fas fa-user"></i>
                            Single Client
                        </label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="coupleClient" name="clientType" value="couple">
                        <label for="coupleClient">
                            <i class="fas fa-users"></i>
                            Couple
                        </label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="dependantsClient" name="clientType" value="dependants">
                        <label for="dependantsClient">
                            <i class="fas fa-child"></i>
                            Dependants
                        </label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="entityClient" name="clientType" value="entity">
                        <label for="entityClient">
                            <i class="fas fa-building"></i>
                            Entity
                        </label>
                    </div>
                </div>
                
                <!-- Entity Type Selector (shows only when entity is selected) -->
                <div class="entity-selector" id="entitySelector">
                    <label>Select Entity Type:</label>
                    <div class="checkbox-group entity-types">
                        <div class="checkbox-item">
                            <input type="checkbox" id="entitySMSF" name="entityType" value="SMSF">
                            <label for="entitySMSF">SMSF</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="entityTrust" name="entityType" value="Trust">
                            <label for="entityTrust">Trust</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="entityCompany" name="entityType" value="Company">
                            <label for="entityCompany">Company</label>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Strategy Details Section -->
        <section class="section" id="strategyDetailsSection">
            <h2><i class="fas fa-info-circle"></i> Strategy Details</h2>
            
            <div class="grid-2">
                <div class="form-group" id="clientNameGroup">
                    <label for="clientName">Client 1 Name:</label>
                    <input type="text" id="clientName" name="clientName" placeholder="Enter client name">
                </div>
                
                <div class="form-group" id="partnerNameGroup" style="display: none;">
                    <label for="partnerName">Client 2 Name (Spouse):</label>
                    <input type="text" id="partnerName" name="partnerName" placeholder="Enter partner name">
                </div>
            </div>
            
            <div class="form-group" id="entityNameGroup" style="display: none;">
                <label for="entityName">Entity Name:</label>
                <input type="text" id="entityName" name="entityName" placeholder="Enter entity name">
            </div>
            
            <!-- Separate entity name fields -->
            <div class="form-group" id="smsfNameGroup" style="display: none;">
                <label for="smsfName">SMSF Name:</label>
                <input type="text" id="smsfName" name="smsfName" placeholder="Enter SMSF name">
            </div>
            
            <div class="form-group" id="trustNameGroup" style="display: none;">
                <label for="trustName">Trust Name:</label>
                <input type="text" id="trustName" name="trustName" placeholder="Enter Trust name">
            </div>
            
            <div class="form-group" id="companyNameGroup" style="display: none;">
                <label for="companyName">Company Name:</label>
                <input type="text" id="companyName" name="companyName" placeholder="Enter Company name">
            </div>
            
            <div class="grid-2">
                <div class="form-group">
                    <label for="xplanId">Xplan ID (if applicable):</label>
                    <input type="text" id="xplanId" name="xplanId" placeholder="Enter Xplan ID">
                </div>
                
                <div class="form-group">
                    <label for="adviserName">Adviser Name:</label>
                    <input type="text" id="adviserName" name="adviserName" placeholder="Enter adviser name">
                </div>
            </div>
            
            <div class="grid-2">
                <div class="form-group">
                    <label for="formCompletedBy">Form Completed by:</label>
                    <input type="text" id="formCompletedBy" name="formCompletedBy" placeholder="Enter your name">
                </div>
                
                <div class="form-group">
                    <label for="clientMeetingDate">Client Meeting Date:</label>
                    <input type="date" id="clientMeetingDate" name="clientMeetingDate">
                </div>
            </div>
        </section>
        
        <!-- Strategy Recommendations Section -->
        <section class="section" id="strategyRecommendationsSection">
            <h2><i class="fas fa-lightbulb"></i> Strategy Recommendations</h2>
            
            <div id="recommendationsSectionsContainer">
                <!-- Dynamic recommendation sections will be added here -->
            </div>
            
            <div class="form-group">
                <label for="goalAlignment">How strategy aligns to goals and objectives?</label>
                <textarea id="goalAlignment" name="goalAlignment" placeholder="Explain how the strategy aligns with client goals and objectives"></textarea>
            </div>
            
            <div class="form-group">
                <label for="mdaDetails">MDA Personalisation:</label>
                <textarea id="mdaDetails" name="mdaDetails" placeholder="Enter MDA personalisation details"></textarea>
            </div>
            
            <div class="form-group">
                <label for="tmdDetails">
                    TMD:
                    <span class="inline-checkbox">
                        <input type="checkbox" id="tmdInFilenote" name="tmdInFilenote">
                        <label for="tmdInFilenote">TMD in filenote?</label>
                    </span>
                </label>
                <textarea id="tmdDetails" name="tmdDetails" placeholder="Enter TMD details"></textarea>
            </div>
            
            <div class="form-group">
                <label for="inaccurateInfo">
                    Any potentially inaccurate or incomplete information:
                    <span class="inline-checkbox">
                        <input type="checkbox" id="inaccurateInfoNA" name="inaccurateInfoNA">
                        <label for="inaccurateInfoNA">N/A</label>
                    </span>
                </label>
                <textarea id="inaccurateInfo" name="inaccurateInfo" placeholder="Include reasons why information may be inaccurate or was not provided"></textarea>
            </div>
            
            <div class="form-group">
                <label for="alternativeStrategies">Alternatives - strategies:</label>
                <textarea id="alternativeStrategies" name="alternativeStrategies" placeholder="Enter alternative strategies"></textarea>
            </div>
            
            <div class="form-group">
                <label for="alternativePlatforms">
                    Alternatives - platforms:
                    <span class="inline-checkbox">
                        <input type="checkbox" id="paraplannerCompare" name="paraplannerCompare">
                        <label for="paraplannerCompare">Paraplanner to complete compare</label>
                    </span>
                </label>
                <textarea id="alternativePlatforms" name="alternativePlatforms" placeholder="Enter alternative platforms"></textarea>
            </div>
        </section>
        
        <!-- Flowchart Section -->
        <section class="section" id="flowchartSection">
            <h2><i class="fas fa-project-diagram"></i> Flowchart</h2>
            
            <div class="form-group">
                <div class="yes-no-label">
                    <label for="flowchartRequired">Flowchart required?</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="flowchartRequired" name="flowchartRequired">
                        <span class="slider"></span>
                    </label>
                    <span id="flowchartStatus">No</span>
                </div>
            </div>
        </section>
        
        <!-- SOA Projections Section -->
        <section class="section" id="soaProjectionsSection">
            <h2><i class="fas fa-chart-line"></i> SOA Projections</h2>
            
            <div class="form-group">
                <label for="projectionDateLength">Projection date length:</label>
                <select id="projectionDateLength" name="projectionDateLength">
                    <option value="lifeExpectancy">Life Expectancy (default)</option>
                    <option value="noProjections">No projections needed</option>
                    <option value="lifeExpectancy5">Life Expectancy + 5 years</option>
                    <option value="lifeExpectancy10">Life Expectancy + 10 years</option>
                    <option value="5">5 years</option>
                    <option value="10">10 years</option>
                    <option value="15">15 years</option>
                    <option value="20">20 years</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div class="form-group" id="otherProjectionLength" style="display: none;">
                <label for="otherProjectionLengthValue">Specify other projection length:</label>
                <input type="number" id="otherProjectionLengthValue" name="otherProjectionLengthValue" placeholder="Enter number of years">
            </div>
            
            <div class="form-group" id="customProjectionInstructions">
                <label for="customInstructions">Custom Instructions:</label>
                <textarea id="customInstructions" name="customInstructions" placeholder="Enter any custom projection instructions"></textarea>
            </div>
            
            <div class="form-group" id="projectionOptionsGroup">
                <div class="checklist-item">
                    <input type="checkbox" id="calmChart" name="projectionOptions" value="CALM">
                    <label for="calmChart">CALM to chart, cashflow consolidated table, asset summary chart and table</label>
                </div>
                
                <div class="checklist-item">
                    <input type="checkbox" id="contributionsTable" name="projectionOptions" value="Contributions">
                    <label for="contributionsTable">If contributions advice is relevant, we need a before and after tax table Year 1</label>
                </div>
                
                <div class="checklist-item">
                    <input type="checkbox" id="pensionTable" name="projectionOptions" value="Pension">
                    <label for="pensionTable">If aged pension advice is relevant we need a before and after aged pension table Year 1</label>
                </div>
                
                <div class="checklist-item">
                    <input type="checkbox" id="insuranceProjection" name="projectionOptions" value="Insurance">
                    <label for="insuranceProjection">If insurance advice is relevant we need insurance premiums 10 years with premiums indexed at 10%</label>
                </div>
            </div>
        </section>
        
        <!-- SOA Fees Section -->
        <section class="section" id="soaFeesSection">
            <h2><i class="fas fa-dollar-sign"></i> SOA Fees (including GST)</h2>
            
            <div class="grid-2">
                <div class="form-group">
                    <label for="upfrontFee">Upfront Fee:</label>
                    <input type="text" id="upfrontFee" name="upfrontFee" placeholder="">
                </div>
                
                <div class="form-group">
                    <label for="paymentMethod">Method of payment:</label>
                    <input type="text" id="paymentMethod" name="paymentMethod" placeholder="">
                </div>
            </div>
            
            <div class="grid-2">
                <div class="form-group">
                    <label for="implementationFee">Implementation fee:</label>
                    <input type="text" id="implementationFee" name="implementationFee" placeholder="">
                </div>
                
                <div class="form-group">
                    <label for="ongoingFee">
                        Ongoing Advice Fee:
                        <span class="inline-checkbox">
                            <input type="checkbox" id="ongoingFeeRefer" name="ongoingFeeRefer">
                            <label for="ongoingFeeRefer">Refer to Pricing Calculator</label>
                        </span>
                    </label>
                    <input type="text" id="ongoingFee" name="ongoingFee" placeholder="">
                </div>
            </div>
            
            <div class="form-group">
                <label for="ongoingPcmFee">Ongoing PC&M Fee:</label>
                <input type="text" id="ongoingPcmFee" name="ongoingPcmFee" placeholder="">
            </div>
            
            <div id="dynamicFeesContainer">
                <!-- Dynamic fees will be added here based on entity selections -->
            </div>
            
            <div class="form-group">
                <label for="referralFee">Referral Fee Applicable:</label>
                <input type="text" id="referralFee" name="referralFee" placeholder="Enter referral fee or N/A">
            </div>
        </section>
        
        <!-- Additional Comments Section -->
        <section class="section" id="additionalCommentsSection">
            <h2><i class="fas fa-comment-alt"></i> Additional Comments/Notes</h2>
            
            <div class="form-group">
                <textarea id="additionalComments" name="additionalComments" placeholder="Enter any additional comments or notes"></textarea>
            </div>
        </section>
        
        <!-- Compliance Checklist Section -->
        <section class="section" id="checklistSection">
            <h2><i class="fas fa-tasks"></i> Compliance Checklist</h2>
            
            <div class="note">
                <p>Please ensure the required documents and approvals are obtained and uploaded prior to submitting your request to the paraplanning team.</p>
            </div>
            
            <h3>All Advice documents</h3>
            <div class="form-group">
                <div class="checklist-item">
                    <input type="checkbox" id="factFind" name="requiredDocs" value="FactFind">
                    <label for="factFind">Fact Find (dated within 12 months)</label>
                </div>
                
                <div class="checklist-item">
                    <input type="checkbox" id="filenote" name="requiredDocs" value="Filenote">
                    <label for="filenote">Filenote</label>
                </div>
                
                <div class="checklist-item">
                    <input type="checkbox" id="pricingCalculator" name="requiredDocs" value="PricingCalculator">
                    <label for="pricingCalculator">Pricing Calculator</label>
                </div>
                
                <div class="checklist-item">
                    <input type="checkbox" id="beneficiaryNomination" name="compliance" value="BeneficiaryNomination">
                    <label for="beneficiaryNomination">Beneficiary nomination advice made (if relevant)</label>
                </div>
            </div>
            
            <h3>Compliance Requirements</h3>
            <div id="complianceRequirements">
                <!-- Dynamic compliance requirements will be added here -->
            </div>
        </section>
        
        <!-- Save Draft Modal -->
        <div id="saveDraftModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3>Save Draft</h3>
                <div class="form-group">
                    <label for="draftName">Draft Name:</label>
                    <input type="text" id="draftName" placeholder="Enter draft name (e.g., Client Name ARF)">
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-success" id="confirmSaveDraft">Save</button>
                    <button type="button" class="btn btn-danger" id="cancelSaveDraft">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Button Group -->
        <div class="btn-group">
            <button type="button" class="btn" id="saveBtn">
                <i class="fas fa-save"></i> Save as Draft
            </button>
            <button type="button" class="btn btn-success" id="exportWordBtn">
                <i class="fas fa-file-word"></i> Export to Word
            </button>
            <button type="button" class="btn btn-success" id="exportPdfBtn">
                <i class="fas fa-file-pdf"></i> Export to PDF
            </button>
            <button type="button" class="btn btn-success" id="emailDocumentBtnBottom">
                <i class="fas fa-envelope"></i> Email Document
            </button>
            <button type="button" class="btn btn-danger" id="resetBtn">
                <i class="fas fa-undo"></i> Reset Form
            </button>
        </div>
    </div>

    <!-- Auto-save indicator -->
    <div id="autoSaveIndicator" class="auto-save-indicator">
        <i class="fas fa-save"></i> Auto-saved
    </div>

    <script>
document.addEventListener('DOMContentLoaded', function() {
    // Client Status Radio Buttons
    const newClientRadio = document.getElementById('newClient');
    const existingClientRadio = document.getElementById('existingClient');
    
    // Client Type Checkboxes
    const singleClientCheckbox = document.getElementById('singleClient');
    const coupleClientCheckbox = document.getElementById('coupleClient');
    const dependantsClientCheckbox = document.getElementById('dependantsClient');
    const entityClientCheckbox = document.getElementById('entityClient');
    const entitySelector = document.getElementById('entitySelector');
    
    // Entity Type Checkboxes
    const entitySMSFCheckbox = document.getElementById('entitySMSF');
    const entityTrustCheckbox = document.getElementById('entityTrust');
    const entityCompanyCheckbox = document.getElementById('entityCompany');
    
    // Form Groups that are conditionally shown
    const partnerNameGroup = document.getElementById('partnerNameGroup');
    const entityNameGroup = document.getElementById('entityNameGroup');
    const smsfNameGroup = document.getElementById('smsfNameGroup');
    const trustNameGroup = document.getElementById('trustNameGroup');
    const companyNameGroup = document.getElementById('companyNameGroup');
    
    // Yes/No Toggle
    const flowchartRequiredToggle = document.getElementById('flowchartRequired');
    const flowchartStatus = document.getElementById('flowchartStatus');
    
    // Projection Length Dropdown
    const projectionDateLength = document.getElementById('projectionDateLength');
    const otherProjectionLength = document.getElementById('otherProjectionLength');
    
    // Buttons
    const saveBtn = document.getElementById('saveBtn');
    const exportWordBtn = document.getElementById('exportWordBtn');
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const resetBtn = document.getElementById('resetBtn');
    const emailDocumentBtnBottom = document.getElementById('emailDocumentBtnBottom');
    
    // Draft functionality
    const draftSelector = document.getElementById('draftSelector');
    const loadDraftBtn = document.getElementById('loadDraftBtn');
    const shareAsLinkBtn = document.getElementById('shareAsLinkBtn');
    const deleteDraftBtn = document.getElementById('deleteDraftBtn');
    const saveDraftModal = document.getElementById('saveDraftModal');
    const draftNameInput = document.getElementById('draftName');
    const confirmSaveDraftBtn = document.getElementById('confirmSaveDraft');
    const cancelSaveDraftBtn = document.getElementById('cancelSaveDraft');
    const closeModal = document.querySelector('.close');
    const autoSaveIndicator = document.getElementById('autoSaveIndicator');
    
    // Alternative platforms checkbox
    const paraplannerCompareCheckbox = document.getElementById('paraplannerCompare');
    const alternativePlatformsTextarea = document.getElementById('alternativePlatforms');
    
    // TMD checkbox
    const tmdInFilenoteCheckbox = document.getElementById('tmdInFilenote');
    const tmdDetailsTextarea = document.getElementById('tmdDetails');
    
    // Inaccurate info N/A checkbox
    const inaccurateInfoNACheckbox = document.getElementById('inaccurateInfoNA');
    const inaccurateInfoTextarea = document.getElementById('inaccurateInfo');
    
    // Ongoing Fee checkbox
    const ongoingFeeReferCheckbox = document.getElementById('ongoingFeeRefer');
    const ongoingFeeInput = document.getElementById('ongoingFee');
    const ongoingPcmFeeInput = document.getElementById('ongoingPcmFee');
    
    // Product options
    const productOptions = [
        'Centric IDPS',
        'Centric Super Choice Accumulation',
        'Centric Super One Accumulation',
        'Centric Super Choice Pension',
        'Centric Super One Pension',
        'CFS Edge IDPS',
        'CFS Edge Super',
        'CFS Edge Pension',
        'BT Panorama IDPS',
        'BT Panorama Pension',
        'BT Panorama Super',
        'LifeFocus Wholesale Investment',
        'LifeFocus Wholesale Super',
        'LifeFocus Wholesale Pension',
        'LifeFocus Private Super',
        'LifeFocus Private Pension',
        'LifeFocus Private Investment',
        'Custom'
    ];
    
    // Risk profile options
    const riskProfiles = ['Conservative', 'Defensive', 'Moderate', 'Balanced', 'Growth', 'High Growth', 'Growth Plus', 'Custom'];
    
    // Product counter for unique IDs
    let productCounter = 0;
    let autoSaveTimeout;
    
    // Initialize draft functionality
    initializeDraftFunctionality();
    
    // Check for shared form data in URL
    checkForSharedData();
    
    // Set up auto-save
    setupAutoSave();
    
    // Set up checkbox visual selection effect
    document.querySelectorAll('.checkbox-item').forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        
        if (checkbox) {
            // Update visual selection on checkbox change
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
                updateFormBasedOnSelections();
                triggerAutoSave();
            });
            
            // Also make the label and checkbox item interactive
            item.addEventListener('click', function(e) {
                if (e.target !== checkbox) {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });
        }
    });
    
    // Handle entity checkbox to show entity selector
    entityClientCheckbox.addEventListener('change', function() {
        if (this.checked) {
            entitySelector.style.display = 'block';
        } else {
            entitySelector.style.display = 'none';
            // Uncheck entity type checkboxes when entity is unchecked
            entitySMSFCheckbox.checked = false;
            entityTrustCheckbox.checked = false;
            entityCompanyCheckbox.checked = false;
            
            document.querySelectorAll('.entity-types .checkbox-item').forEach(item => {
                item.classList.remove('selected');
            });
        }
        updateFormBasedOnSelections();
    });
    
    // Function to create searchable dropdown
    function createSearchableDropdown(inputId, options, onChange) {
        const input = document.getElementById(inputId);
        if (!input) return;
        
        const wrapper = document.createElement('div');
        wrapper.className = 'searchable-select';
        input.parentNode.insertBefore(wrapper, input);
        wrapper.appendChild(input);
        
        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown-list';
        wrapper.appendChild(dropdown);
        
        // Populate dropdown
        options.forEach(option => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.textContent = option;
            item.addEventListener('click', function() {
                input.value = option;
                dropdown.classList.remove('active');
                if (onChange) onChange(option);
                triggerAutoSave();
            });
            dropdown.appendChild(item);
        });
        
        // Show/hide dropdown
        input.addEventListener('focus', function() {
            dropdown.classList.add('active');
        });
        
        input.addEventListener('blur', function() {
            setTimeout(() => dropdown.classList.remove('active'), 200);
        });
        
        // Filter options
        input.addEventListener('input', function() {
            const filter = this.value.toLowerCase();
            const items = dropdown.querySelectorAll('.dropdown-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(filter) ? 'block' : 'none';
            });
            dropdown.classList.add('active');
            triggerAutoSave();
        });
    }
    
    // Function to create product recommendation item
    function createProductRecommendation(clientId, clientName, productIndex) {
        const productId = `${clientId}_product_${productIndex}`;
        
        const productHTML = `
            <div class="product-item" id="${productId}">
                <div class="product-header">
                    <h5>Product ${productIndex + 1}</h5>
                    ${productIndex > 0 ? `<button type="button" class="btn btn-danger btn-sm" onclick="removeProduct('${productId}')">Remove</button>` : ''}
                </div>
                
                <div class="grid-3-custom">
                    <div class="form-group">
                        <label for="${productId}_name">Product Name:</label>
                        <input type="text" id="${productId}_name" name="${productId}_name" placeholder="Type to search products">
                    </div>
                    <div class="form-group custom-input" id="${productId}_custom_group" style="display: none;">
                        <label for="${productId}_custom">Custom Product:</label>
                        <input type="text" id="${productId}_custom" name="${productId}_custom" placeholder="Enter custom product name">
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label for="${productId}_investment">Product Investment/s:</label>
                        <textarea id="${productId}_investment" name="${productId}_investment" placeholder="Enter investment details (can list multiple investments)" style="min-height: 60px; resize: vertical;"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="${productId}_cash">Cash Preference:</label>
                        <input type="text" id="${productId}_cash" name="${productId}_cash" placeholder="Enter cash preference amount">
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="yes-no-label">
                        <label for="${productId}_tranching">Tranching:</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="${productId}_tranching" name="${productId}_tranching">
                            <span class="slider"></span>
                        </label>
                        <span id="${productId}_tranching_status">No</span>
                    </div>
                </div>
                
                <div class="tranching-details" id="${productId}_tranching_details" style="display: none;">
                    <div class="form-group">
                        <label for="${productId}_tranching_text">Tranching Details:</label>
                        <textarea id="${productId}_tranching_text" name="${productId}_tranching_text" placeholder="Enter tranching details"></textarea>
                    </div>
                </div>
                
                <div class="mda-section" id="${productId}_mda_section" style="display: none;">
                    <div class="form-group">
                        <div class="yes-no-label">
                            <label for="${productId}_mda">MDA:</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="${productId}_mda" name="${productId}_mda">
                                <span class="slider"></span>
                            </label>
                            <span id="${productId}_mda_status">No</span>
                        </div>
                    </div>
                    
                    <div class="form-group" id="${productId}_investment_options" style="display: none;">
                        <label for="${productId}_investment_option">Investment Option:</label>
                        <select id="${productId}_investment_option" name="${productId}_investment_option">
                            <option value="">Select investment option</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
        
        return productHTML;
    }
    
    // Function to remove product
    window.removeProduct = function(productId) {
        const element = document.getElementById(productId);
        if (element) {
            element.remove();
            triggerAutoSave();
        }
    };
    
    // Function to fill Joint sections with N/A
    window.fillJointNA = function() {
        const jointRecommendations = document.getElementById('jointRecommendations');
        if (jointRecommendations) {
            jointRecommendations.value = 'N/A - No joint recommendations required';
            triggerAutoSave();
        }
    };
    
    window.fillJointProductNA = function() {
        // Hide the joint product section and mark as N/A
        const jointProductCheckbox = document.getElementById('jointProductRecsCheckbox');
        const jointProductSection = document.getElementById('jointProductRecommendationsSection');
        
        if (jointProductCheckbox && jointProductSection) {
            jointProductCheckbox.checked = false;
            jointProductSection.style.display = 'none';
            triggerAutoSave();
        }
    };
    
    window.fillJointRiskNA = function() {
        const jointRiskProfile = document.getElementById('riskProfileJoint');
        if (jointRiskProfile) {
            jointRiskProfile.value = 'na';
            triggerAutoSave();
        }
    };
    
    // Function to add product
    window.addProduct = function(clientId, clientName) {
        const container = document.getElementById(`${clientId}_products`);
        const productCount = container.querySelectorAll('.product-item').length;
        
        const newProductHTML = createProductRecommendation(clientId, clientName, productCount);
        container.insertAdjacentHTML('beforeend', newProductHTML);
        
        // Initialize features for the new product
        setTimeout(() => {
            initializeProductFeatures();
            setupAutoSaveForNewElements();
            triggerAutoSave();
        }, 100);
    };
    
    // Function to update recommendation sections based on selections
    function updateRecommendationSections() {
        const container = document.getElementById('recommendationsSectionsContainer');
        container.innerHTML = '';
        
        // Get client names
        const clientName = document.getElementById('clientName').value || 'Client 1';
        const partnerName = document.getElementById('partnerName').value || 'Client 2';
        
        // Add client recommendations if single or couple is selected
        if (singleClientCheckbox.checked || coupleClientCheckbox.checked) {
            const clientRecommendationHTML = `
                <div class="recommendation-section">
                    <div class="recommendation-textarea">
                        <div class="recommendation-header">
                            <label for="clientRecommendations">${clientName} Recommendations:</label>
                            <div class="recommendation-checkbox">
                                <input type="checkbox" id="client1ProductRecsCheckbox" name="client1ProductRecsCheckbox">
                                <label for="client1ProductRecsCheckbox">Product Recommendations?</label>
                            </div>
                        </div>
                        <textarea id="clientRecommendations" name="clientRecommendations" 
                            placeholder="Enter recommendations for ${clientName}"></textarea>
                    </div>
                    <div class="risk-profile-inline">
                        <div class="form-group">
                            <label for="riskProfile1">Risk Profile - ${clientName}:</label>
                            <select id="riskProfile1" name="riskProfile1">
                                <option value="">Select Risk Profile</option>
                                <option value="conservative">Conservative</option>
                                <option value="defensive">Defensive</option>
                                <option value="moderate">Moderate</option>
                                <option value="balanced">Balanced</option>
                                <option value="growth">Growth</option>
                                <option value="highGrowth">High Growth</option>
                                <option value="growthPlus">Growth Plus</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="product-recommendations" id="client1ProductRecommendationsSection" style="display: none;">
                    <h4>Product Recommendations - ${clientName}</h4>
                    <div id="client1_products">
                        ${createProductRecommendation('client1', clientName, 0)}
                    </div>
                    <button type="button" class="btn btn-success btn-sm add-product-btn" onclick="addProduct('client1', '${clientName}')">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', clientRecommendationHTML);
        }
        
        // Add partner recommendations if couple is selected
        if (coupleClientCheckbox.checked) {
            const partnerRecommendationHTML = `
                <div class="recommendation-section">
                    <div class="recommendation-textarea">
                        <div class="recommendation-header">
                            <label for="partnerRecommendations">${partnerName} Recommendations:</label>
                            <div class="recommendation-checkbox">
                                <input type="checkbox" id="client2ProductRecsCheckbox" name="client2ProductRecsCheckbox">
                                <label for="client2ProductRecsCheckbox">Product Recommendations?</label>
                            </div>
                        </div>
                        <textarea id="partnerRecommendations" name="partnerRecommendations" 
                            placeholder="Enter recommendations for ${partnerName}"></textarea>
                    </div>
                    <div class="risk-profile-inline">
                        <div class="form-group">
                            <label for="riskProfile2">Risk Profile - ${partnerName}:</label>
                            <select id="riskProfile2" name="riskProfile2">
                                <option value="">Select Risk Profile</option>
                                <option value="conservative">Conservative</option>
                                <option value="defensive">Defensive</option>
                                <option value="moderate">Moderate</option>
                                <option value="balanced">Balanced</option>
                                <option value="growth">Growth</option>
                                <option value="highGrowth">High Growth</option>
                                <option value="growthPlus">Growth Plus</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="product-recommendations" id="client2ProductRecommendationsSection" style="display: none;">
                    <h4>Product Recommendations - ${partnerName}</h4>
                    <div id="client2_products">
                        ${createProductRecommendation('client2', partnerName, 0)}
                    </div>
                    <button type="button" class="btn btn-success btn-sm add-product-btn" onclick="addProduct('client2', '${partnerName}')">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                </div>
                
                <div class="recommendation-section">
                    <div class="recommendation-textarea">
                        <div class="recommendation-header">
                            <label for="jointRecommendations">Joint Recommendations:</label>
                            <div class="recommendation-checkbox">
                                <input type="checkbox" id="jointProductRecsCheckbox" name="jointProductRecsCheckbox">
                                <label for="jointProductRecsCheckbox">Product Recommendations?</label>
                            </div>
                        </div>
                        <textarea id="jointRecommendations" name="jointRecommendations" 
                            placeholder="Enter joint recommendations"></textarea>
                        <button type="button" class="btn btn-secondary btn-sm na-button" onclick="fillJointNA()">
                            N/A
                        </button>
                    </div>
                    <div class="risk-profile-inline">
                        <div class="form-group">
                            <label for="riskProfileJoint">Risk Profile - Joint:</label>
                            <select id="riskProfileJoint" name="riskProfileJoint">
                                <option value="">Select Risk Profile</option>
                                <option value="conservative">Conservative</option>
                                <option value="defensive">Defensive</option>
                                <option value="moderate">Moderate</option>
                                <option value="balanced">Balanced</option>
                                <option value="growth">Growth</option>
                                <option value="highGrowth">High Growth</option>
                                <option value="growthPlus">Growth Plus</option>
                                <option value="na">N/A</option>
                                <option value="custom">Custom</option>
                            </select>
                            <button type="button" class="btn btn-secondary btn-sm na-button" onclick="fillJointRiskNA()">
                                N/A
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="product-recommendations" id="jointProductRecommendationsSection" style="display: none;">
                    <h4>Product Recommendations - Joint</h4>
                    <div id="joint_products">
                        ${createProductRecommendation('joint', 'Joint', 0)}
                    </div>
                    <button type="button" class="btn btn-success btn-sm add-product-btn" onclick="addProduct('joint', 'Joint')">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm na-button" onclick="fillJointProductNA()">
                        N/A
                    </button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', partnerRecommendationHTML);
        }
        
        // Add entity recommendations
        if (entityClientCheckbox.checked) {
            if (entitySMSFCheckbox.checked) {
                const smsfName = document.getElementById('smsfName').value || 'SMSF';
                addEntityRecommendation('SMSF', smsfName);
            }
            
            if (entityTrustCheckbox.checked) {
                const trustName = document.getElementById('trustName').value || 'Trust';
                addEntityRecommendation('Trust', trustName);
            }
            
            if (entityCompanyCheckbox.checked) {
                const companyName = document.getElementById('companyName').value || 'Company';
                addEntityRecommendation('Company', companyName);
            }
        }
        
        // Add dependants recommendations if selected
        if (dependantsClientCheckbox.checked) {
            const dependantsRecommendationHTML = `
                <div class="recommendation-section">
                    <div class="recommendation-textarea">
                        <div class="recommendation-header">
                            <label for="dependantsRecommendations">Dependants Recommendations:</label>
                            <div class="recommendation-checkbox">
                                <input type="checkbox" id="dependantsProductRecsCheckbox" name="dependantsProductRecsCheckbox">
                                <label for="dependantsProductRecsCheckbox">Product Recommendations?</label>
                            </div>
                        </div>
                        <textarea id="dependantsRecommendations" name="dependantsRecommendations" 
                            placeholder="Enter recommendations for dependants"></textarea>
                    </div>
                    <div class="risk-profile-inline">
                        <div class="form-group">
                            <label for="riskProfileDependants">Risk Profile - Dependants:</label>
                            <select id="riskProfileDependants" name="riskProfileDependants">
                                <option value="">Select Risk Profile</option>
                                <option value="conservative">Conservative</option>
                                <option value="defensive">Defensive</option>
                                <option value="moderate">Moderate</option>
                                <option value="balanced">Balanced</option>
                                <option value="growth">Growth</option>
                                <option value="highGrowth">High Growth</option>
                                <option value="growthPlus">Growth Plus</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="product-recommendations" id="dependantsProductRecommendationsSection" style="display: none;">
                    <h4>Product Recommendations - Dependants</h4>
                    <div id="dependants_products">
                        ${createProductRecommendation('dependants', 'Dependants', 0)}
                    </div>
                    <button type="button" class="btn btn-success btn-sm add-product-btn" onclick="addProduct('dependants', 'Dependants')">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', dependantsRecommendationHTML);
        }
        
        // Initialize all product dropdowns and event listeners
        setTimeout(() => {
            initializeProductFeatures();
            setupProductRecommendationToggles();
            setupAutoSaveForNewElements();
        }, 100);
    }
    
    // Function to setup product recommendation toggles
    function setupProductRecommendationToggles() {
        // Setup toggles for all product recommendation checkboxes
        document.querySelectorAll('[id$="ProductRecsCheckbox"]').forEach(checkbox => {
            if (!checkbox.hasAttribute('data-initialized')) {
                checkbox.setAttribute('data-initialized', 'true');
                checkbox.addEventListener('change', function() {
                    // Map checkbox IDs to section IDs
                    const checkboxToSectionMap = {
                        'client1ProductRecsCheckbox': 'client1ProductRecommendationsSection',
                        'client2ProductRecsCheckbox': 'client2ProductRecommendationsSection', 
                        'jointProductRecsCheckbox': 'jointProductRecommendationsSection',
                        'smsfProductRecsCheckbox': 'smsfProductRecommendationsSection',
                        'trustProductRecsCheckbox': 'trustProductRecommendationsSection',
                        'companyProductRecsCheckbox': 'companyProductRecommendationsSection',
                        'dependantsProductRecsCheckbox': 'dependantsProductRecommendationsSection'
                    };
                    
                    const sectionId = checkboxToSectionMap[this.id];
                    const section = document.getElementById(sectionId);
                    if (section) {
                        section.style.display = this.checked ? 'block' : 'none';
                    }
                    triggerAutoSave();
                });
            }
        });
    }
    
    // Helper function to add entity recommendation sections
    function addEntityRecommendation(entityType, entityName) {
        const container = document.getElementById('recommendationsSectionsContainer');
        const entityId = entityType.toLowerCase();
        
        const entityRecommendationHTML = `
            <div class="recommendation-section">
                <div class="recommendation-textarea">
                    <div class="recommendation-header">
                        <label for="${entityId}Recommendations">${entityType} - ${entityName} Recommendations:</label>
                        <div class="recommendation-checkbox">
                            <input type="checkbox" id="${entityId}ProductRecsCheckbox" name="${entityId}ProductRecsCheckbox">
                            <label for="${entityId}ProductRecsCheckbox">Product Recommendations?</label>
                        </div>
                    </div>
                    <textarea id="${entityId}Recommendations" name="${entityId}Recommendations" 
                        placeholder="Enter recommendations for ${entityType}"></textarea>
                </div>
                <div class="risk-profile-inline">
                    <div class="form-group">
                        <label for="riskProfile${entityId}">Risk Profile - ${entityType}:</label>
                        <select id="riskProfile${entityId}" name="riskProfile${entityId}">
                            <option value="">Select Risk Profile</option>
                            <option value="conservative">Conservative</option>
                            <option value="defensive">Defensive</option>
                            <option value="moderate">Moderate</option>
                            <option value="balanced">Balanced</option>
                            <option value="growth">Growth</option>
                            <option value="highGrowth">High Growth</option>
                            <option value="growthPlus">Growth Plus</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="product-recommendations" id="${entityId}ProductRecommendationsSection" style="display: none;">
                <h4>Product Recommendations - ${entityType} - ${entityName}</h4>
                <div id="${entityId}_products">
                    ${createProductRecommendation(entityId, entityName, 0)}
                </div>
                <button type="button" class="btn btn-success btn-sm add-product-btn" onclick="addProduct('${entityId}', '${entityName}')">
                    <i class="fas fa-plus"></i> Add Product
                </button>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', entityRecommendationHTML);
    }
    
    // Function to initialize product features
    function initializeProductFeatures() {
        // Initialize all product dropdowns
        document.querySelectorAll('[id$="_name"]').forEach(input => {
            if (!input.parentElement.classList.contains('searchable-select')) {
                createSearchableDropdown(input.id, productOptions, function(selectedProduct) {
                    const productId = input.id.replace('_name', '');
                    const customGroup = document.getElementById(`${productId}_custom_group`);
                    const mdaSection = document.getElementById(`${productId}_mda_section`);
                    const mdaCheckbox = document.getElementById(`${productId}_mda`);
                    
                    if (selectedProduct === 'Custom') {
                        customGroup.style.display = 'block';
                        mdaSection.style.display = 'none';
                        // Clear MDA-related fields for custom products
                        if (mdaCheckbox) {
                            mdaCheckbox.checked = false;
                            const status = document.getElementById(`${productId}_mda_status`);
                            if (status) status.textContent = 'No';
                            const investmentOptions = document.getElementById(`${productId}_investment_options`);
                            if (investmentOptions) investmentOptions.style.display = 'none';
                            const investmentField = document.getElementById(`${productId}_investment`);
                            if (investmentField && investmentField.value === 'Refer to Investment option below') {
                                investmentField.value = '';
                            }
                        }
                    } else {
                        customGroup.style.display = 'none';
                        
                        // Show MDA section for applicable products
                        if (selectedProduct.includes('BT Panorama') || 
                            selectedProduct.includes('Centric Super Choice') || 
                            selectedProduct === 'Centric IDPS') {
                            mdaSection.style.display = 'block';
                            // Enable MDA for applicable products
                            if (mdaCheckbox) {
                                mdaCheckbox.disabled = false;
                            }
                        } else if (selectedProduct.includes('Centric Super One')) {
                            mdaSection.style.display = 'none';
                            // Hide MDA for Centric Super One
                            if (mdaCheckbox) {
                                mdaCheckbox.checked = false;
                                mdaCheckbox.disabled = true;
                                const status = document.getElementById(`${productId}_mda_status`);
                                if (status) status.textContent = 'No';
                                const investmentOptions = document.getElementById(`${productId}_investment_options`);
                                if (investmentOptions) investmentOptions.style.display = 'none';
                            }
                        } else {
                            mdaSection.style.display = 'none';
                        }
                    }
                });
            }
        });
        
        // Initialize tranching toggles
        document.querySelectorAll('[id$="_tranching"]').forEach(toggle => {
            if (!toggle.hasAttribute('data-initialized')) {
                toggle.setAttribute('data-initialized', 'true');
                toggle.addEventListener('change', function() {
                    const productId = this.id.replace('_tranching', '');
                    const status = document.getElementById(`${productId}_tranching_status`);
                    const details = document.getElementById(`${productId}_tranching_details`);
                    
                    status.textContent = this.checked ? 'Yes' : 'No';
                    details.style.display = this.checked ? 'block' : 'none';
                    triggerAutoSave();
                });
            }
        });
        
        // Initialize MDA toggles
        document.querySelectorAll('[id$="_mda"]').forEach(toggle => {
            if (!toggle.hasAttribute('data-initialized')) {
                toggle.setAttribute('data-initialized', 'true');
                toggle.addEventListener('change', function() {
                    const productId = this.id.replace('_mda', '');
                    const status = document.getElementById(`${productId}_mda_status`);
                    const investmentOptions = document.getElementById(`${productId}_investment_options`);
                    const investmentField = document.getElementById(`${productId}_investment`);
                    
                    status.textContent = this.checked ? 'Yes' : 'No';
                    investmentOptions.style.display = this.checked ? 'block' : 'none';
                    
                    if (this.checked) {
                        updateInvestmentOptions(productId);
                        
                        // Update investment field to refer to investment option below
                        if (investmentField) {
                            investmentField.value = 'Refer to Investment option below';
                        }
                    } else {
                        // Clear the investment field if MDA is unchecked
                        if (investmentField && investmentField.value === 'Refer to Investment option below') {
                            investmentField.value = '';
                        }
                    }
                    triggerAutoSave();
                });
            }
        });
    }
    
    // Function to update investment options based on product selection
    function updateInvestmentOptions(productId) {
        const productNameInput = document.getElementById(`${productId}_name`);
        const investmentSelect = document.getElementById(`${productId}_investment_option`);
        
        if (!productNameInput || !investmentSelect) return;
        
        const productName = productNameInput.value;
        investmentSelect.innerHTML = '<option value="">Select investment option</option>';
        
        // Add options based on product
        if (productName.includes('BT Panorama')) {
            // BT Panorama - only Active Unlisted options
            const btRiskProfiles = ['Defensive', 'Moderate', 'Balanced', 'Growth', 'High Growth', 'Growth Plus', 'Custom'];
            btRiskProfiles.forEach(profile => {
                investmentSelect.innerHTML += `<option value="Active Unlisted ${profile}">Active Unlisted - ${profile}</option>`;
            });
        } else if (productName.includes('Centric Super Choice') || productName === 'Centric IDPS') {
            // Centric Choice and IDPS options
            const types = ['Passive', 'Active Unlisted', 'Active DNR HC', 'Active DNR SRI', 'Semi Active DNR HC', 'Semi Active DNR SRI'];
            const centricRiskProfiles = ['Defensive', 'Moderate', 'Balanced', 'Growth', 'High Growth', 'Growth Plus'];
            
            types.forEach(type => {
                centricRiskProfiles.forEach(profile => {
                    investmentSelect.innerHTML += `<option value="${type} ${profile}">${type} - ${profile}</option>`;
                });
            });
        }
        
        // Add event listener to update investment field when option is selected
        investmentSelect.addEventListener('change', function() {
            const investmentField = document.getElementById(`${productId}_investment`);
            const mdaCheckbox = document.getElementById(`${productId}_mda`);
            if (investmentField && mdaCheckbox && mdaCheckbox.checked) {
                investmentField.value = 'Refer to Investment option below';
            }
            triggerAutoSave();
        });
    }
    
    // Update fees based on entity selections
    function updateDynamicFees() {
        const container = document.getElementById('dynamicFeesContainer');
        container.innerHTML = '';
        
        let feesHTML = '<div class="grid-2">';
        
        if (entitySMSFCheckbox.checked) {
            feesHTML += `
                <div class="form-group">
                    <label for="smsfFees">SMSF fees:</label>
                    <input type="text" id="smsfFees" name="smsfFees" placeholder="Enter SMSF fees">
                </div>
            `;
        }
        
        if (entityTrustCheckbox.checked) {
            feesHTML += `
                <div class="form-group">
                    <label for="trustFees">Trust fees:</label>
                    <input type="text" id="trustFees" name="trustFees" placeholder="Enter Trust fees">
                </div>
            `;
        }
        
        if (entityCompanyCheckbox.checked) {
            feesHTML += `
                <div class="form-group">
                    <label for="companyFees">Company fees:</label>
                    <input type="text" id="companyFees" name="companyFees" placeholder="Enter Company fees">
                </div>
            `;
        }
        
        feesHTML += '</div>';
        
        if (entitySMSFCheckbox.checked || entityTrustCheckbox.checked || entityCompanyCheckbox.checked) {
            container.innerHTML = feesHTML;
            setupAutoSaveForNewElements();
        }
    }
    
    // Update compliance requirements based on client status
    function updateComplianceRequirements() {
        const container = document.getElementById('complianceRequirements');
        container.innerHTML = '';
        
        if (newClientRadio.checked) {
            // New client requirements
            const newClientHTML = `
                <div class="form-group">
                    <div class="checklist-item">
                        <input type="checkbox" id="clientIdUploaded" name="compliance" value="ClientID">
                        <label for="clientIdUploaded">Upload copy of ID to XPLAN</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="amlCompletion" name="compliance" value="AML">
                        <label for="amlCompletion">AML to be completed per entity/individual save to XPLAN</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="taskXGreenID" name="compliance" value="GreenID">
                        <label for="taskXGreenID">TaskX - Green ID to be completed</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="initialFN" name="compliance" value="InitialFN">
                        <label for="initialFN">Initial FN</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="riskProfilingEvidence" name="riskProfiling" value="Evidence">
                        <label for="riskProfilingEvidence">Evidence of Risk profiling outcome in filenote</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="clientFFQ" name="compliance" value="ClientFFQ">
                        <label for="clientFFQ">Completed FFQ to XPLAN</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="scopeOfAdvice" name="compliance" value="ScopeOfAdvice">
                        <label for="scopeOfAdvice">Scope of Advice to XPLAN</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="finametricaSigned" name="compliance" value="FinametricaDoc">
                        <label for="finametricaSigned">Signed Finametrica Document to be uploaded to XPLAN</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="finametricaReport" name="compliance" value="FinametricaReport">
                        <label for="finametricaReport">Finametrica Report to be uploaded to XPLAN</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="superResearch" name="compliance" value="SuperResearch">
                        <label for="superResearch">Super research confirmation</label>
                    </div>
                    
                    <div class="checklist-item" id="contributionHistoryItem" style="display: none; margin-left: 30px;">
                        <input type="checkbox" id="contributionHistory" name="compliance" value="ContributionHistory">
                        <label for="contributionHistory">Contribution history obtained</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="taskXNewAdvice" name="compliance" value="TaskXNewAdvice">
                        <label for="taskXNewAdvice">TaskX - New Advice Request</label>
                    </div>
                </div>
            `;
            container.innerHTML = newClientHTML;
        } else if (existingClientRadio.checked) {
            // Existing client requirements
            const existingClientHTML = `
                <div class="form-group">
                    <div class="checklist-item">
                        <input type="checkbox" id="strategicFN" name="compliance" value="StrategicFN">
                        <label for="strategicFN">Strategic FN / Other relevant FN</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="riskProfilingEvidence" name="riskProfiling" value="Evidence">
                        <label for="riskProfilingEvidence">Evidence of Risk profiling outcome in filenote</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="uploadPricingCalc" name="compliance" value="UploadPricing">
                        <label for="uploadPricingCalc">Upload Pricing Calculator</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="workingsResearch" name="compliance" value="WorkingsResearch">
                        <label for="workingsResearch">Workings / Research etc to be uploaded</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="submitJira" name="compliance" value="SubmitJira">
                        <label for="submitJira">Submit JIRA for pricing/or PCR (if applicable)</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="superResearch" name="compliance" value="SuperResearch">
                        <label for="superResearch">Super research confirmation</label>
                    </div>
                    
                    <div class="checklist-item" id="contributionHistoryItem" style="display: none; margin-left: 30px;">
                        <input type="checkbox" id="contributionHistory" name="compliance" value="ContributionHistory">
                        <label for="contributionHistory">Contribution history obtained</label>
                    </div>
                </div>
            `;
            container.innerHTML = existingClientHTML;
        }
        
        // Add SMSF specific items if SMSF is selected
        if (entitySMSFCheckbox.checked) {
            const smsfHTML = `
                <div class="form-group">
                    <div class="checklist-item">
                        <input type="checkbox" id="smsfDocs" name="compliance" value="SMSFDocs">
                        <label for="smsfDocs">SMSF trust deed, financials, investment strategy, costs</label>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', smsfHTML);
        }
        
        // Add event listener for super research checkbox
        setTimeout(() => {
            const superResearchCheckbox = document.getElementById('superResearch');
            const contributionHistoryItem = document.getElementById('contributionHistoryItem');
            
            if (superResearchCheckbox && contributionHistoryItem) {
                superResearchCheckbox.addEventListener('change', function() {
                    contributionHistoryItem.style.display = this.checked ? 'block' : 'none';
                    if (!this.checked) {
                        document.getElementById('contributionHistory').checked = false;
                    }
                    triggerAutoSave();
                });
            }
            setupAutoSaveForNewElements();
        }, 100);
    }
    
    // Function to update form based on selected client types
    function updateFormBasedOnSelections() {
        // Update partner-related fields based on couple selection
        partnerNameGroup.style.display = coupleClientCheckbox.checked ? 'block' : 'none';
        
        // Update entity name fields based on entity selections
        if (entityClientCheckbox.checked) {
            // Show specific entity name fields based on what's selected
            smsfNameGroup.style.display = entitySMSFCheckbox.checked ? 'block' : 'none';
            trustNameGroup.style.display = entityTrustCheckbox.checked ? 'block' : 'none';
            companyNameGroup.style.display = entityCompanyCheckbox.checked ? 'block' : 'none';
            
            // Hide generic entity name field since we have specific ones now
            entityNameGroup.style.display = 'none';
        } else {
            // Hide all entity name fields when entity is not selected
            entityNameGroup.style.display = 'none';
            smsfNameGroup.style.display = 'none';
            trustNameGroup.style.display = 'none';
            companyNameGroup.style.display = 'none';
        }
        
        // Update recommendation sections
        updateRecommendationSections();
        
        // Update dynamic fees
        updateDynamicFees();
        
        // Update compliance requirements
        updateComplianceRequirements();
    }
    
    // Add event listeners for client name changes
    document.getElementById('clientName').addEventListener('input', function() {
        updateRecommendationSections();
        triggerAutoSave();
    });
    document.getElementById('partnerName').addEventListener('input', function() {
        updateRecommendationSections();
        triggerAutoSave();
    });
    document.getElementById('entityName').addEventListener('input', function() {
        updateRecommendationSections();
        triggerAutoSave();
    });
    
    // Add event listeners for specific entity name changes
    document.getElementById('smsfName').addEventListener('input', function() {
        updateRecommendationSections();
        triggerAutoSave();
    });
    document.getElementById('trustName').addEventListener('input', function() {
        updateRecommendationSections();
        triggerAutoSave();
    });
    document.getElementById('companyName').addEventListener('input', function() {
        updateRecommendationSections();
        triggerAutoSave();
    });
    
    // Add event listeners for entity type checkboxes
    entitySMSFCheckbox.addEventListener('change', function() {
        updateFormBasedOnSelections();
    });
    entityTrustCheckbox.addEventListener('change', function() {
        updateFormBasedOnSelections();
    });
    entityCompanyCheckbox.addEventListener('change', function() {
        updateFormBasedOnSelections();
    });
    
    // Add event listeners for client status radio buttons
    newClientRadio.addEventListener('change', function() {
        updateComplianceRequirements();
        triggerAutoSave();
    });
    existingClientRadio.addEventListener('change', function() {
        updateComplianceRequirements();
        triggerAutoSave();
    });
    
    // Handle Flowchart Toggle
    flowchartRequiredToggle.addEventListener('change', function() {
        flowchartStatus.textContent = this.checked ? 'Yes' : 'No';
        triggerAutoSave();
    });
    
    // Handle Projection Length Dropdown
    projectionDateLength.addEventListener('change', function() {
        const otherProjectionLength = document.getElementById('otherProjectionLength');
        const customProjectionInstructions = document.getElementById('customProjectionInstructions');
        const projectionOptionsGroup = document.getElementById('projectionOptionsGroup');
        
        if (this.value === 'other') {
            otherProjectionLength.style.display = 'block';
        } else {
            otherProjectionLength.style.display = 'none';
        }
        
        if (this.value === 'noProjections') {
            // Hide projection options and custom instructions if no projections needed
            projectionOptionsGroup.style.display = 'none';
            customProjectionInstructions.style.display = 'none';
        } else {
            // Show projection options and custom instructions for all other selections
            projectionOptionsGroup.style.display = 'block';
            customProjectionInstructions.style.display = 'block';
        }
        
        triggerAutoSave();
    });
    
    // Handle paraplanner compare checkbox
    paraplannerCompareCheckbox.addEventListener('change', function() {
        if (this.checked) {
            alternativePlatformsTextarea.value = 'Paraplanner to complete compare\n' + alternativePlatformsTextarea.value;
        } else {
            alternativePlatformsTextarea.value = alternativePlatformsTextarea.value.replace('Paraplanner to complete compare\n', '');
        }
        triggerAutoSave();
    });
    
    // Handle TMD in filenote checkbox
    tmdInFilenoteCheckbox.addEventListener('change', function() {
        if (this.checked) {
            tmdDetailsTextarea.value = 'TMD in filenote\n' + tmdDetailsTextarea.value;
        } else {
            tmdDetailsTextarea.value = tmdDetailsTextarea.value.replace('TMD in filenote\n', '');
        }
        triggerAutoSave();
    });
    
    // Handle inaccurate info N/A checkbox
    inaccurateInfoNACheckbox.addEventListener('change', function() {
        if (this.checked) {
            inaccurateInfoTextarea.value = 'N/A - No potentially inaccurate or incomplete information';
        } else {
            if (inaccurateInfoTextarea.value === 'N/A - No potentially inaccurate or incomplete information') {
                inaccurateInfoTextarea.value = '';
            }
        }
        triggerAutoSave();
    });
    
    // Handle ongoing fee refer checkbox
    ongoingFeeReferCheckbox.addEventListener('change', function() {
        if (this.checked) {
            ongoingFeeInput.value = 'Refer to Pricing Calculator';
            ongoingPcmFeeInput.value = 'Refer to Pricing Calculator';
        } else {
            // Clear the text when unchecked
            if (ongoingFeeInput.value === 'Refer to Pricing Calculator') {
                ongoingFeeInput.value = '';
            }
            if (ongoingPcmFeeInput.value === 'Refer to Pricing Calculator') {
                ongoingPcmFeeInput.value = '';
            }
        }
        triggerAutoSave();
    });
    
    // Draft Functionality
    function initializeDraftFunctionality() {
        loadDraftList();
        
        // Save draft modal functionality
        saveBtn.addEventListener('click', function() {
            const clientName = document.getElementById('clientName').value || 'Unnamed Client';
            draftNameInput.value = `${clientName} ARF`;
            saveDraftModal.style.display = 'block';
        });
        
        confirmSaveDraftBtn.addEventListener('click', function() {
            const draftName = draftNameInput.value.trim();
            if (draftName) {
                saveDraft(draftName);
                saveDraftModal.style.display = 'none';
                showAutoSaveIndicator('Draft saved successfully!');
            } else {
                alert('Please enter a draft name.');
            }
        });
        
        cancelSaveDraftBtn.addEventListener('click', function() {
            saveDraftModal.style.display = 'none';
        });
        
        closeModal.addEventListener('click', function() {
            saveDraftModal.style.display = 'none';
        });
        
        window.addEventListener('click', function(event) {
            if (event.target === saveDraftModal) {
                saveDraftModal.style.display = 'none';
            }
        });
        
        // Load draft functionality
        loadDraftBtn.addEventListener('click', function() {
            const selectedDraft = draftSelector.value;
            if (selectedDraft) {
                loadDraft(selectedDraft);
            } else {
                alert('Please select a draft to load.');
            }
        });
        
        // Delete draft functionality
        deleteDraftBtn.addEventListener('click', function() {
            const selectedDraft = draftSelector.value;
            if (selectedDraft) {
                if (confirm(`Are you sure you want to delete the draft "${selectedDraft}"?`)) {
                    deleteDraft(selectedDraft);
                }
            } else {
                alert('Please select a draft to delete.');
            }
        });
        
        // Share as Link functionality
        shareAsLinkBtn.addEventListener('click', function() {
            shareAsLink();
        });
    }
    
    function loadDraftList() {
        const drafts = JSON.parse(localStorage.getItem('financialAdviceFormDrafts') || '{}');
        draftSelector.innerHTML = '<option value="">Select a saved draft...</option>';
        
        Object.keys(drafts).forEach(draftName => {
            const option = document.createElement('option');
            option.value = draftName;
            option.textContent = draftName;
            draftSelector.appendChild(option);
        });
    }
    
    function saveDraft(draftName, isAutoSave = false) {
        const formData = collectFormData();
        const drafts = JSON.parse(localStorage.getItem('financialAdviceFormDrafts') || '{}');
        drafts[draftName] = {
            data: formData,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem('financialAdviceFormDrafts', JSON.stringify(drafts));
        
        // Only refresh dropdown if it's not an auto-save
        if (!isAutoSave) {
            loadDraftList();
        }
    }
    
    function loadDraft(draftName) {
        const drafts = JSON.parse(localStorage.getItem('financialAdviceFormDrafts') || '{}');
        if (drafts[draftName]) {
            populateFormData(drafts[draftName].data);
            showAutoSaveIndicator('Draft loaded successfully!');
        }
    }
    
    function deleteDraft(draftName) {
        const drafts = JSON.parse(localStorage.getItem('financialAdviceFormDrafts') || '{}');
        delete drafts[draftName];
        localStorage.setItem('financialAdviceFormDrafts', JSON.stringify(drafts));
        loadDraftList();
        draftSelector.value = '';
        showAutoSaveIndicator('Draft deleted successfully!');
    }
    
    // Enhanced Share as Link functionality with compression
    function shareAsLink() {
        const formData = collectFormData();
        const clientName = document.getElementById('clientName').value || 'Shared Form';
        
        try {
            // Use LZ-String compression for better URL handling
            const compressedData = LZString.compressToEncodedURIComponent(JSON.stringify(formData));
            
            // Check if the compressed data is still too large for URL
            if (compressedData.length > 8000) {
                // Use a chunked approach with localStorage
                const shareId = 'share_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem(shareId, JSON.stringify(formData));
                
                // Set expiration for 24 hours
                setTimeout(() => {
                    localStorage.removeItem(shareId);
                }, 24 * 60 * 60 * 1000);
                
                const shareUrl = `${window.location.origin}${window.location.pathname}?shareId=${shareId}`;
                copyAndShowShareLink(shareUrl, clientName);
            } else {
                // Use direct URL with compressed data
                const shareUrl = `${window.location.origin}${window.location.pathname}?shared=${compressedData}`;
                copyAndShowShareLink(shareUrl, clientName);
            }
        } catch (error) {
            console.error('Error creating share link:', error);
            showAutoSaveIndicator('Error creating share link');
        }
    }
    
    function copyAndShowShareLink(shareUrl, clientName) {
        // Copy to clipboard
        navigator.clipboard.writeText(shareUrl).then(() => {
            showAutoSaveIndicator('Share link copied to clipboard!');
            
            // Also show a modal with the link for manual copying if needed
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h3><i class="fas fa-share"></i> Share Form: ${clientName}</h3>
                    <p>The link has been copied to your clipboard. Anyone with this link can view and edit this form:</p>
                    <div style="background: #f5f5f5; padding: 10px; border-radius: 4px; word-break: break-all; margin: 15px 0; font-family: monospace; font-size: 12px; max-height: 100px; overflow-y: auto;">
                        ${shareUrl}
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="btn btn-primary" onclick="navigator.clipboard.writeText('${shareUrl}').then(() => alert('Link copied again!'))">
                            <i class="fas fa-copy"></i> Copy Again
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-check"></i> Done
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }).catch(() => {
            // Fallback if clipboard API fails
            showAutoSaveIndicator('Share link ready - check the modal');
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h3><i class="fas fa-share"></i> Share Form: ${clientName}</h3>
                    <p>Copy this link to share the form:</p>
                    <div style="background: #f5f5f5; padding: 10px; border-radius: 4px; word-break: break-all; margin: 15px 0; font-family: monospace; font-size: 12px; max-height: 100px; overflow-y: auto;">
                        ${shareUrl}
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="btn btn-primary" onclick="navigator.clipboard.writeText('${shareUrl}').then(() => alert('Link copied!')).catch(() => alert('Please copy manually'))">
                            <i class="fas fa-copy"></i> Copy Link
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-check"></i> Done
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        });
    }
    
    // Check for shared data in URL
    function checkForSharedData() {
        const urlParams = new URLSearchParams(window.location.search);
        const sharedData = urlParams.get('shared');
        const shareId = urlParams.get('shareId');
        
        if (sharedData) {
            try {
                // Decompress the shared data
                const decodedData = JSON.parse(LZString.decompressFromEncodedURIComponent(sharedData));
                loadSharedData(decodedData);
            } catch (error) {
                console.error('Error loading shared data:', error);
                showAutoSaveIndicator('Error loading shared form data');
            }
        } else if (shareId) {
            try {
                // Load from localStorage using shareId
                const storedData = localStorage.getItem(shareId);
                if (storedData) {
                    const decodedData = JSON.parse(storedData);
                    loadSharedData(decodedData);
                } else {
                    showAutoSaveIndicator('Shared form link has expired or is invalid');
                }
            } catch (error) {
                console.error('Error loading shared data from storage:', error);
                showAutoSaveIndicator('Error loading shared form data');
            }
        }
    }
    
    function loadSharedData(decodedData) {
        // Show notification about shared form
        const clientName = decodedData.clientName || 'Unknown Client';
        showAutoSaveIndicator(`Loading shared form: ${clientName}`);
        
        // Populate the form with shared data
        setTimeout(() => {
            populateFormData(decodedData);
            
            // Clean URL after loading (optional)
            const cleanUrl = window.location.protocol + '//' + window.location.host + window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
            
            showAutoSaveIndicator('Shared form loaded successfully!');
        }, 500);
    }
    
    // Auto-save functionality
    function setupAutoSave() {
        // Add auto-save to all form elements
        document.querySelectorAll('input, textarea, select').forEach(element => {
            if (element.type === 'checkbox' || element.type === 'radio') {
                element.addEventListener('change', triggerAutoSave);
            } else {
                element.addEventListener('input', triggerAutoSave);
                element.addEventListener('change', triggerAutoSave);
            }
        });
    }
    
    function setupAutoSaveForNewElements() {
        // Setup auto-save for dynamically added elements
        setTimeout(() => {
            document.querySelectorAll('input:not([data-autosave]), textarea:not([data-autosave]), select:not([data-autosave])').forEach(element => {
                element.setAttribute('data-autosave', 'true');
                if (element.type === 'checkbox' || element.type === 'radio') {
                    element.addEventListener('change', triggerAutoSave);
                } else {
                    element.addEventListener('input', triggerAutoSave);
                    element.addEventListener('change', triggerAutoSave);
                }
            });
        }, 100);
    }
    
    function triggerAutoSave() {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            const clientName = document.getElementById('clientName').value || 'Auto-Save';
            saveDraft(`${clientName} - Auto Save`, true); // Pass true for silent auto-save
            // Completely silent - no notifications, no dropdown updates
        }, 2000); // Auto-save after 2 seconds of inactivity
    }
    
    function showAutoSaveIndicator(message = 'Auto-saved') {
        autoSaveIndicator.textContent = message;
        autoSaveIndicator.classList.add('show');
        setTimeout(() => {
            autoSaveIndicator.classList.remove('show');
        }, 2000);
    }
    
    function collectFormData() {
        const formData = {};
        document.querySelectorAll('input, textarea, select').forEach(element => {
            if (element.type === 'checkbox' || element.type === 'radio') {
                formData[element.id] = element.checked;
            } else {
                formData[element.id] = element.value;
            }
        });
        return formData;
    }
    
    function populateFormData(formData) {
        Object.keys(formData).forEach(key => {
            const element = document.getElementById(key);
            if (element) {
                if (element.type === 'checkbox' || element.type === 'radio') {
                    element.checked = formData[key];
                    if (element.type === 'checkbox') {
                        const item = element.closest('.checkbox-item');
                        if (item) {
                            item.classList.toggle('selected', element.checked);
                        }
                        
                        // Handle product recommendation checkboxes
                        if (key.endsWith('ProductRecsCheckbox')) {
                            const checkboxToSectionMap = {
                                'client1ProductRecsCheckbox': 'client1ProductRecommendationsSection',
                                'client2ProductRecsCheckbox': 'client2ProductRecommendationsSection', 
                                'jointProductRecsCheckbox': 'jointProductRecommendationsSection',
                                'smsfProductRecsCheckbox': 'smsfProductRecommendationsSection',
                                'trustProductRecsCheckbox': 'trustProductRecommendationsSection',
                                'companyProductRecsCheckbox': 'companyProductRecommendationsSection',
                                'dependantsProductRecsCheckbox': 'dependantsProductRecommendationsSection'
                            };
                            
                            const sectionId = checkboxToSectionMap[key];
                            const section = document.getElementById(sectionId);
                            if (section) {
                                section.style.display = element.checked ? 'block' : 'none';
                            }
                        }
                    }
                } else {
                    element.value = formData[key];
                }
            }
        });
        updateFormBasedOnSelections();
    }
    
    // Email Document functionality - Desktop Outlook only
    emailDocumentBtnBottom.addEventListener('click', function() {
        const clientName = document.getElementById('clientName').value || 'Client';
        const xplanId = document.getElementById('xplanId').value;
        
        // Show popup reminder about PDF attachment
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <h3><i class="fas fa-info-circle"></i> Email Document Reminder</h3>
                <p><strong>Before sending the email:</strong></p>
                <ul style="margin: 15px 0; padding-left: 20px; text-align: left;">
                    <li>Please ensure you have downloaded the ARF PDF using "Export to PDF"</li>
                    <li>You will need to manually attach the PDF file to your email</li>
                    ${xplanId ? `<li style="background-color: yellow; padding: 5px; margin: 5px 0; border-radius: 3px;"><strong>IF YOU WANT TO SAVE TO XPLAN CC: ${xplanId.trim()}@findex.xplan.iress.com.au</strong></li>` : '<li>No Xplan ID entered - manually CC if saving to Xplan</li>'}
                </ul>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-success" id="proceedWithEmail">
                        <i class="fas fa-check"></i> OK - Open Email Client
                    </button>
                    <button type="button" class="btn btn-secondary" id="cancelEmail">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Handle proceed button
        modal.querySelector('#proceedWithEmail').addEventListener('click', function() {
            modal.remove();
            openEmailClient(clientName, xplanId);
        });
        
        // Handle cancel button
        modal.querySelector('#cancelEmail').addEventListener('click', function() {
            modal.remove();
        });
        
        // Handle clicking outside modal
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        });
    });
    
    // Function to open email client - Desktop Outlook only
    function openEmailClient(clientName, xplanId) {
        const subject = `Findex ARF for ${clientName}`;
        
        // Build CC email if Xplan ID is provided
        let ccNote = '';
        if (xplanId && xplanId.trim()) {
            const ccEmail = `${xplanId.trim()}@findex.xplan.iress.com.au`;
            ccNote = `**IF YOU WANT TO SAVE TO XPLAN CC ${ccEmail}**\n\n`;
        }
        
        const body = `${ccNote}Dear Team,

Please find attached the Financial Advice Request Form (ARF) for ${clientName}.

This document has been prepared for your acknowledgment and further processing.

If you have any questions or require additional information, please don't hesitate to contact me.

Best regards,
${document.getElementById('formCompletedBy').value || '[Your Name]'}`;
        
        // Try multiple methods to open desktop Outlook only
        let emailOpened = false;
        
        // Method 1: Try desktop Outlook protocol first (Windows)
        if (navigator.platform.indexOf('Win') > -1) {
            try {
                let outlookDesktopUrl = `outlook:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = outlookDesktopUrl;
                document.body.appendChild(iframe);
                setTimeout(() => document.body.removeChild(iframe), 1000);
                emailOpened = true;
            } catch (error) {
                console.error('Outlook desktop failed:', error);
            }
        }
        
        // Method 2: Try standard mailto as fallback (will use default email client)
        if (!emailOpened) {
            try {
                let mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailtoLink;
                emailOpened = true;
            } catch (error) {
                console.error('Mailto failed:', error);
            }
        }
        
        // Show success message
        let message = 'Email client opening...';
        if (xplanId && xplanId.trim()) {
            message += ` Remember to CC: ${xplanId.trim()}@findex.xplan.iress.com.au`;
        } else {
            message += ' (No Xplan ID - manual CC required if saving to Xplan)';
        }
        showAutoSaveIndicator(message);
        
        // Follow-up message
        setTimeout(() => {
            showAutoSaveIndicator('If email client didn\'t open, please check your default email app settings.');
        }, 3000);
    }
    
    // Export to Word functionality - FIXED to match visible content exactly and reorder sections
    exportWordBtn.addEventListener('click', function() {
        const clientName = document.getElementById('clientName').value || 'Client';
        
        // Build clean Word document content - only include what's actually visible
        let wordContent = `
        <h1 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">Statement of Advice Request Form</h1>
        `;
        
        // Process each visible section in correct order
        document.querySelectorAll('.section').forEach((section, index) => {
            if (section.style.display !== 'none') {
                const h2 = section.querySelector('h2');
                if (h2) {
                    wordContent += `<h2 style="color: #3498db; margin-top: 25px; margin-bottom: 15px; border-bottom: 2px solid #ecf0f1; padding-bottom: 5px;">${h2.textContent}</h2>`;
                }
                
                // Special handling for Strategy Recommendations section to reorder content
                if (section.id === 'strategyRecommendationsSection') {
                    // First add all recommendation sections (Client 1, Client 2, Joint, Entities, etc.)
                    const dynamicContainer = section.querySelector('#recommendationsSectionsContainer');
                    if (dynamicContainer) {
                        // Process recommendation sections with new layout
                        dynamicContainer.querySelectorAll('.recommendation-section').forEach(recSection => {
                            if (recSection.style.display !== 'none') {
                                const textareaDiv = recSection.querySelector('.recommendation-textarea');
                                const riskDiv = recSection.querySelector('.risk-profile-inline');
                                
                                if (textareaDiv) {
                                    const label = textareaDiv.querySelector('label');
                                    const textarea = textareaDiv.querySelector('textarea');
                                    const productCheckbox = textareaDiv.querySelector('input[type="checkbox"]');
                                    
                                    if (label && textarea && textarea.value) {
                                        wordContent += `<h3 style="color: #34495e; margin-top: 20px; margin-bottom: 15px;">${label.textContent}</h3>`;
                                        wordContent += `<p style="border: 1px solid #ccc; padding: 8px; background-color: #f9f9f9; margin-bottom: 15px; white-space: pre-wrap;">${textarea.value}</p>`;
                                    }
                                    
                                    if (productCheckbox) {
                                        const productLabel = productCheckbox.nextElementSibling;
                                        if (productLabel) {
                                            wordContent += `<p style="margin-left: 20px;">${productCheckbox.checked ? '' : ''} ${productLabel.textContent}</p>`;
                                        }
                                    }
                                }
                                
                                if (riskDiv) {
                                    const riskLabel = riskDiv.querySelector('label');
                                    const riskSelect = riskDiv.querySelector('select');
                                    
                                    if (riskLabel && riskSelect && riskSelect.value) {
                                        const selected = riskSelect.options[riskSelect.selectedIndex];
                                        if (selected && selected.text) {
                                            wordContent += `<p><strong>${riskLabel.textContent}</strong> ${selected.text}</p>`;
                                        }
                                    }
                                }
                            }
                        });
                        
                        // Process product recommendations sections - ONLY IF VISIBLE AND CHECKBOX IS CHECKED
                        dynamicContainer.querySelectorAll('.product-recommendations').forEach(productSection => {
                            if (productSection.style.display === 'block') {  // Only visible sections
                                const sectionTitle = productSection.querySelector('h4');
                                if (sectionTitle) {
                                    wordContent += `<h3 style="color: #34495e; margin-top: 20px; margin-bottom: 15px;">${sectionTitle.textContent}</h3>`;
                                }
                                
                                // Process each product item
                                productSection.querySelectorAll('.product-item').forEach(product => {
                                    if (product.style.display !== 'none') {
                                        const productHeader = product.querySelector('h5');
                                        if (productHeader) {
                                            wordContent += `<h4 style="color: #34495e; margin-top: 15px; margin-bottom: 10px;">${productHeader.textContent}</h4>`;
                                        }
                                        
                                        // Process product fields with values
                                        product.querySelectorAll('input, textarea, select').forEach(input => {
                                            if (input.value && input.style.display !== 'none') {
                                                const inputGroup = input.closest('.form-group');
                                                const inputLabel = inputGroup ? inputGroup.querySelector('label') : null;
                                                
                                                if (inputLabel) {
                                                    let value = input.value;
                                                    if (input.tagName === 'SELECT') {
                                                        const selected = input.options[input.selectedIndex];
                                                        value = selected ? selected.text : '';
                                                    }
                                                    if (input.type === 'checkbox') {
                                                        // Handle toggle switches in products
                                                        const statusSpan = input.parentElement.nextElementSibling;
                                                        value = statusSpan ? statusSpan.textContent : (input.checked ? 'Yes' : 'No');
                                                    }
                                                    if (value && value !== 'Select investment option' && value !== '') {
                                                        wordContent += `<p style="margin-left: 20px;"><strong>${inputLabel.textContent}</strong> ${value}</p>`;
                                                    }
                                                }
                                            }
                                        });
                                    }
                                });
                            }
                        });
                    }
                    
                    // Then add the rest of the strategy recommendations fields
                    section.querySelectorAll('.form-group').forEach(group => {
                        if (group.style.display !== 'none' && !group.closest('#recommendationsSectionsContainer')) {
                            // Process regular inputs (avoid duplicates)
                            group.querySelectorAll('input[type="text"], input[type="date"], input[type="number"], textarea, select').forEach(input => {
                                if (input.style.display !== 'none' && !input.closest('.checkbox-group') && !input.closest('.radio-group') && !input.closest('.btn-group') && !input.closest('.product-item') && !input.closest('.recommendation-header')) {
                                    const inputLabel = input.closest('.form-group').querySelector('label');
                                    if (inputLabel && input.value) {
                                        let value = input.value;
                                        if (input.tagName === 'SELECT') {
                                            const selected = input.options[input.selectedIndex];
                                            value = selected ? selected.text : '';
                                        }
                                        if (value) {
                                            wordContent += `<p><strong>${inputLabel.textContent}</strong></p>`;
                                            wordContent += `<p style="border: 1px solid #ccc; padding: 8px; background-color: #f9f9f9; margin-bottom: 15px; white-space: pre-wrap;">${value}</p>`;
                                        }
                                    }
                                }
                            });
                        }
                    });
                } else {
                    // Process form groups for other sections (excluding dynamic recommendations container)
                    section.querySelectorAll('.form-group').forEach(group => {
                        if (group.style.display !== 'none' && !group.closest('#recommendationsSectionsContainer')) {
                            const label = group.querySelector('label');
                            
                            // Process radio groups
                            const radioGroup = group.querySelector('.radio-group');
                            if (radioGroup) {
                                if (label) {
                                    wordContent += `<p><strong>${label.textContent}</strong></p>`;
                                }
                                radioGroup.querySelectorAll('input[type="radio"]').forEach(radio => {
                                    if (radio.checked) {
                                        const radioLabel = radio.nextElementSibling;
                                        if (radioLabel) {
                                            wordContent += `<p style="margin-left: 20px;"> ${radioLabel.textContent}</p>`;
                                        }
                                    }
                                });
                            }
                            
                            // Process checkbox groups
                            const checkboxGroup = group.querySelector('.checkbox-group');
                            if (checkboxGroup) {
                                if (label) {
                                    wordContent += `<p><strong>${label.textContent}</strong></p>`;
                                }
                                checkboxGroup.querySelectorAll('.checkbox-item').forEach(item => {
                                    const checkbox = item.querySelector('input[type="checkbox"]');
                                    const checkboxLabel = item.querySelector('label');
                                    if (checkbox && checkboxLabel) {
                                        wordContent += `<p style="margin-left: 20px;">${checkbox.checked ? '' : ''} ${checkboxLabel.textContent}</p>`;
                                    }
                                });
                            }
                            
                            // Process regular inputs (avoid duplicates)
                            group.querySelectorAll('input[type="text"], input[type="date"], input[type="number"], textarea, select').forEach(input => {
                                if (input.style.display !== 'none' && !input.closest('.checkbox-group') && !input.closest('.radio-group') && !input.closest('.btn-group') && !input.closest('.product-item') && !input.closest('.recommendation-header')) {
                                    const inputLabel = input.closest('.form-group').querySelector('label');
                                    if (inputLabel && input.value) {
                                        let value = input.value;
                                        if (input.tagName === 'SELECT') {
                                            const selected = input.options[input.selectedIndex];
                                            value = selected ? selected.text : '';
                                        }
                                        if (value) {
                                            wordContent += `<p><strong>${inputLabel.textContent}</strong></p>`;
                                            wordContent += `<p style="border: 1px solid #ccc; padding: 8px; background-color: #f9f9f9; margin-bottom: 15px; white-space: pre-wrap;">${value}</p>`;
                                        }
                                    }
                                }
                            });
                            
                            // Process checklist items
                            group.querySelectorAll('.checklist-item').forEach(item => {
                                if (item.style.display !== 'none') {
                                    const checkbox = item.querySelector('input[type="checkbox"]');
                                    const checkboxLabel = item.querySelector('label');
                                    if (checkbox && checkboxLabel) {
                                        wordContent += `<p style="background-color: #f0f0f0; padding: 5px; margin-bottom: 5px;">${checkbox.checked ? '' : ''} ${checkboxLabel.textContent}</p>`;
                                    }
                                }
                            });
                            
                            // Process toggle switches
                            group.querySelectorAll('.yes-no-label').forEach(toggleGroup => {
                                const toggleLabel = toggleGroup.querySelector('label');
                                const toggleInput = toggleGroup.querySelector('input[type="checkbox"]');
                                if (toggleLabel && toggleInput) {
                                    wordContent += `<p><strong>${toggleLabel.textContent}</strong> ${toggleInput.checked ? 'Yes' : 'No'}</p>`;
                                }
                            });
                        }
                    });
                }
            }
        });
        
        // Create complete Word document
        const html = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
            <head>
                <meta charset="utf-8">
                <title>Financial Advice Request Form - ${clientName}</title>
                <style>
                    body { 
                        font-family: Calibri, Arial, sans-serif; 
                        line-height: 1.5; 
                        color: #000; 
                        margin: 20px; 
                        background: white;
                    }
                    h1 { font-size: 24pt; margin-bottom: 20pt; page-break-after: avoid; }
                    h2 { font-size: 18pt; margin-top: 20pt; margin-bottom: 10pt; page-break-after: avoid; }
                    h3, h4 { font-size: 14pt; margin-top: 15pt; margin-bottom: 10pt; page-break-after: avoid; }
                    p { margin-bottom: 10pt; }
                    @page { margin: 1in; }
                </style>
            </head>
            <body>
                ${wordContent}
            </body>
            </html>
        `;
        
        const blob = new Blob([html], { type: 'application/msword' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Financial_Advice_Request_Form_${clientName.replace(/[^a-zA-Z0-9]/g, '_')}.doc`;
        a.click();
        URL.revokeObjectURL(url);
        
        showAutoSaveIndicator('Word document exported successfully!');
    });
    
    // Export to PDF functionality - Enhanced for better text handling
    exportPdfBtn.addEventListener('click', function() {
        const clientName = document.getElementById('clientName').value || 'Client';
        
        // Hide elements that shouldn't be in PDF
        const elementsToHide = document.querySelectorAll('.draft-selector, .auto-save-indicator, .modal, .btn-group');
        const originalDisplays = [];
        
        elementsToHide.forEach(el => {
            originalDisplays.push(el.style.display);
            el.style.display = 'none';
        });
        
        // Add PDF-specific styles for better text handling
        const pdfStyle = document.createElement('style');
        pdfStyle.id = 'pdf-export-style';
        pdfStyle.textContent = `
            @media print {
                body { 
                    background: white !important; 
                    padding: 0 !important; 
                    -webkit-print-color-adjust: exact !important;
                    print-color-adjust: exact !important;
                }
                .container { 
                    box-shadow: none !important; 
                    max-width: 100% !important; 
                    margin: 0 !important; 
                    padding: 20px !important;
                }
                .section { 
                    page-break-inside: avoid !important; 
                    margin-bottom: 20px !important;
                }
                textarea, input[type="text"] {
                    min-height: auto !important;
                    height: auto !important;
                    padding: 8px !important;
                    border: 1px solid #ddd !important;
                    background: white !important;
                    word-wrap: break-word !important;
                    white-space: pre-wrap !important;
                    overflow: visible !important;
                    resize: none !important;
                    box-sizing: border-box !important;
                }
                * { 
                    print-color-adjust: exact !important; 
                    -webkit-print-color-adjust: exact !important;
                    color-adjust: exact !important;
                }
            }
        `;
        document.head.appendChild(pdfStyle);
        
        // Set document title for PDF filename
        const originalTitle = document.title;
        document.title = `Financial_Advice_Request_Form_${clientName.replace(/[^a-zA-Z0-9]/g, '_')}`;
        
        // Use window.print() for guaranteed text handling
        setTimeout(() => {
            window.print();
        }, 100);
        
        // Clean up after print
        const cleanupAfterPrint = () => {
            // Remove PDF styles
            const pdfStyleElement = document.getElementById('pdf-export-style');
            if (pdfStyleElement) {
                pdfStyleElement.remove();
            }
            
            // Restore original title
            document.title = originalTitle;
            
            // Restore hidden elements
            elementsToHide.forEach((el, index) => {
                el.style.display = originalDisplays[index];
            });
            
            showAutoSaveIndicator('PDF ready for save/print!');
        };
        
        // Listen for print events
        window.addEventListener('afterprint', cleanupAfterPrint, { once: true });
        
        // Fallback cleanup after 10 seconds
        setTimeout(cleanupAfterPrint, 10000);
    });
    
    // Reset Form functionality
    resetBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to reset the form? All entered data will be lost.')) {
            // Reset form fields
            document.querySelectorAll('input[type="text"], input[type="date"], input[type="number"], textarea').forEach(field => {
                field.value = '';
                // Reset textarea size
                if (field.tagName === 'TEXTAREA') {
                    field.style.height = 'auto';
                }
            });
            
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
            });
            
            document.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });
            
            // Reset client type selection
            document.querySelectorAll('.checkbox-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Hide conditional sections
            partnerNameGroup.style.display = 'none';
            entityNameGroup.style.display = 'none';
            entitySelector.style.display = 'none';
            smsfNameGroup.style.display = 'none';
            trustNameGroup.style.display = 'none';
            companyNameGroup.style.display = 'none';
            
            // Hide all product recommendation sections
            document.querySelectorAll('[id$="ProductRecommendationsSection"]').forEach(section => {
                section.style.display = 'none';
            });
            
            // Clear dynamic content
            document.getElementById('recommendationsSectionsContainer').innerHTML = '';
            document.getElementById('dynamicFeesContainer').innerHTML = '';
            document.getElementById('complianceRequirements').innerHTML = '';
            
            // Reset other UI elements
            flowchartRequiredToggle.checked = false;
            flowchartStatus.textContent = 'No';
            projectionDateLength.value = 'lifeExpectancy';
            otherProjectionLength.style.display = 'none';
            
            // Reset projection visibility
            const customProjectionInstructions = document.getElementById('customProjectionInstructions');
            const projectionOptionsGroup = document.getElementById('projectionOptionsGroup');
            if (customProjectionInstructions) customProjectionInstructions.style.display = 'block';
            if (projectionOptionsGroup) projectionOptionsGroup.style.display = 'block';
            
            // Reset checkboxes
            paraplannerCompareCheckbox.checked = false;
            tmdInFilenoteCheckbox.checked = false;
            inaccurateInfoNACheckbox.checked = false;
            ongoingFeeReferCheckbox.checked = false;
            
            showAutoSaveIndicator('Form has been reset!');
        }
    });
    
    // Initial form update
    updateFormBasedOnSelections();
    
    // Setup auto-save for existing elements
    setupAutoSave();
});
    </script>
</body>
</html>

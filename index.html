<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Financial Advice Request Form - SOA</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
      :root {
        --primary: #2c3e50;
        --secondary: #3498db;
        --accent: #1abc9c;
        --light: #ecf0f1;
        --danger: #e74c3c;
        --success: #2ecc71;
        --dark: #34495e;
        --text: #2c3e50;
        --border-radius: 8px;
        --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f5f7fa;
        color: var(--text);
        line-height: 1.6;
        padding: 20px;
      }

      /* Draft Selector */
      .draft-selector {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 15px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
        max-width: 400px;
      }

      .draft-selector .btn {
        flex: 1;
        min-width: 90px;
        text-align: center;
        white-space: nowrap;
      }

      .draft-selector label {
        font-weight: 500;
        margin-bottom: 0;
        white-space: nowrap;
      }

      .draft-selector select {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: var(--border-radius);
        font-size: 14px;
        background: var(--light);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        padding: 30px;
        position: relative;
        margin-top: 80px;
      }

      h1 {
        color: var(--primary);
        text-align: center;
        margin-bottom: 30px;
        font-weight: 600;
        position: relative;
        padding-bottom: 15px;
      }

      h1:after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 4px;
        background: var(--accent);
        border-radius: 2px;
      }

      h2 {
        color: var(--secondary);
        margin: 25px 0 15px;
        font-weight: 500;
        font-size: 1.4rem;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--light);
      }

      h2 i {
        margin-right: 10px;
      }

      h3 {
        margin-top: 20px;
        margin-bottom: 10px;
        color: var(--dark);
      }

      h4 {
        margin-top: 15px;
        margin-bottom: 10px;
        color: var(--dark);
        font-size: 1.1rem;
      }

      .section {
        margin-bottom: 30px;
        padding: 20px;
        border-radius: var(--border-radius);
        background: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        border-left: 4px solid var(--accent);
        opacity: 1;
        height: auto;
        overflow: hidden;
        transition: var(--transition);
        page-break-inside: avoid;
      }

      .section.hidden {
        opacity: 0;
        height: 0;
        padding: 0;
        margin: 0;
        overflow: hidden;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--dark);
      }

      input[type="text"],
      input[type="date"],
      input[type="number"],
      textarea,
      select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: var(--border-radius);
        font-size: 16px;
        transition: var(--transition);
        background: var(--light);
      }

      input[type="text"]:focus,
      input[type="date"]:focus,
      input[type="number"]:focus,
      textarea:focus,
      select:focus {
        border-color: var(--secondary);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        outline: none;
      }

      textarea {
        min-height: 100px;
        resize: vertical;
        font-family: inherit;
        line-height: 1.5;
      }

      .btn {
        display: inline-block;
        background: var(--secondary);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: var(--transition);
        text-align: center;
        text-decoration: none;
      }

      .btn:hover {
        background: var(--primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .btn-success {
        background: var(--success);
      }

      .btn-success:hover {
        background: #27ae60;
      }

      .btn-danger {
        background: var(--danger);
      }

      .btn-primary {
        background: var(--primary);
      }

      .btn-secondary {
        background: #6c757d;
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: 14px;
      }

      .btn-icon {
        padding: 8px 12px;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
      }

      .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 30px;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 30px;
      }

      .radio-group {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
      }

      .radio-item {
        display: flex;
        align-items: center;
        background: var(--light);
        border-radius: var(--border-radius);
        padding: 10px 15px;
        cursor: pointer;
        transition: var(--transition);
      }

      .radio-item:hover {
        background: rgba(52, 152, 219, 0.1);
      }

      .radio-item input[type="radio"] {
        margin-right: 10px;
      }

      .radio-item label {
        display: flex;
        align-items: center;
        margin-bottom: 0;
        cursor: pointer;
      }

      .radio-item label i {
        margin-right: 8px;
        font-size: 18px;
        color: var(--secondary);
      }

      .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }

      .checkbox-group.client-types {
        justify-content: flex-start;
      }

      .checkbox-group.entity-types {
        justify-content: flex-start;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        background: var(--light);
        padding: 10px 15px;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: var(--transition);
        border: 2px solid transparent;
      }

      .checkbox-item:hover {
        background: rgba(52, 152, 219, 0.1);
      }

      .checkbox-item.selected {
        border-color: var(--accent);
        background-color: rgba(26, 188, 156, 0.1);
      }

      .checkbox-item input[type="checkbox"] {
        margin-right: 8px;
      }

      .checkbox-item label {
        display: flex;
        align-items: center;
        margin-bottom: 0;
        cursor: pointer;
      }

      .checkbox-item label i {
        margin-right: 8px;
        font-size: 18px;
        color: var(--secondary);
      }

      .grid-2 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      .grid-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
      }

      @media (max-width: 768px) {
        .grid-3 {
          grid-template-columns: 1fr;
        }
      }

      .grid-3-custom {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        align-items: end;
      }

      .note {
        background-color: rgba(52, 152, 219, 0.1);
        border-left: 4px solid var(--secondary);
        padding: 15px;
        border-radius: var(--border-radius);
        margin: 20px 0;
      }

      .note p {
        margin: 0;
      }

      /* For the checklist */
      .checklist-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        padding: 10px;
        background-color: var(--light);
        border-radius: var(--border-radius);
        page-break-inside: avoid;
      }

      .checklist-item label {
        margin-bottom: 0;
        margin-left: 10px;
        cursor: pointer;
      }

      .sub-checklist {
        margin-left: 30px;
        margin-top: 10px;
        padding: 10px;
        background-color: rgba(52, 152, 219, 0.05);
        border-radius: var(--border-radius);
      }

      /* Toggle Switch for Yes/No */
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 34px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: var(--success);
      }

      input:focus + .slider {
        box-shadow: 0 0 1px var(--success);
      }

      input:checked + .slider:before {
        transform: translateX(26px);
      }

      .yes-no-label {
        display: flex;
        align-items: center;
        justify-content: flex-start;
      }

      .yes-no-label label:first-child {
        margin-right: 15px;
      }

      .yes-no-label span {
        margin-left: 10px;
      }

      .entity-selector {
        margin-top: 20px;
        display: none;
      }

      .entity-selector.show {
        display: block;
      }

      .product-recommendations {
        background-color: rgba(26, 188, 156, 0.05);
        padding: 15px;
        border-radius: var(--border-radius);
        margin-top: 15px;
        page-break-inside: avoid;
      }

      .product-item {
        background-color: white;
        padding: 15px;
        border-radius: var(--border-radius);
        margin-bottom: 15px;
        border: 1px solid #e0e0e0;
        page-break-inside: avoid;
      }

      .product-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .add-product-btn {
        margin-top: 10px;
      }

      .risk-profile-section {
        background-color: rgba(52, 152, 219, 0.05);
        padding: 15px;
        border-radius: var(--border-radius);
        margin-top: 15px;
        page-break-inside: avoid;
      }

      .inline-checkbox {
        display: inline-flex;
        align-items: center;
        margin-left: 15px;
      }

      .inline-checkbox input {
        margin-right: 5px;
      }

      .searchable-select {
        position: relative;
      }

      .searchable-select input {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: var(--border-radius);
        font-size: 16px;
        background: var(--light);
      }

      .dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 300px;
        overflow-y: auto;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        display: none;
      }

      .dropdown-list.active {
        display: block;
      }

      .dropdown-item {
        padding: 10px 15px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .dropdown-item:hover {
        background-color: var(--light);
      }

      .dropdown-item.selected {
        background-color: var(--secondary);
        color: white;
      }

      .tranching-details {
        margin-top: 10px;
        padding: 10px;
        background-color: rgba(52, 152, 219, 0.05);
        border-radius: var(--border-radius);
      }

      .mda-section {
        margin-top: 15px;
        padding: 10px;
        background-color: rgba(46, 204, 113, 0.05);
        border-radius: var(--border-radius);
      }

      .custom-input {
        margin-top: 0;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
      }

      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: none;
        border-radius: var(--border-radius);
        width: 80%;
        max-width: 500px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      }

      .modal-content h3 {
        margin-bottom: 20px;
        color: var(--primary);
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
      }

      .close:hover,
      .close:focus {
        color: var(--danger);
        text-decoration: none;
      }

      .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
      }

      /* Auto-save indicator */
      .auto-save-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--success);
        color: white;
        padding: 10px 15px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        display: none;
        align-items: center;
        gap: 8px;
        z-index: 1000;
        font-size: 14px;
      }

      .auto-save-indicator.show {
        display: flex;
        animation: fadeInOut 2s ease-in-out;
      }

      @keyframes fadeInOut {
        0% {
          opacity: 0;
          transform: translateY(20px);
        }
        20% {
          opacity: 1;
          transform: translateY(0);
        }
        80% {
          opacity: 1;
          transform: translateY(0);
        }
        100% {
          opacity: 0;
          transform: translateY(-20px);
        }
      }

      /* For Word export styling */
      .word-export {
        font-family: "Calibri", "Arial", sans-serif;
        line-height: 1.5;
        color: #000;
      }

      .word-export h1 {
        font-size: 24pt;
        margin-bottom: 20pt;
      }

      .word-export h2 {
        font-size: 18pt;
        margin-top: 20pt;
        margin-bottom: 10pt;
      }

      .word-export h3 {
        font-size: 14pt;
        margin-top: 15pt;
        margin-bottom: 10pt;
      }

      .word-export .section {
        margin-bottom: 20pt;
        padding: 15pt;
      }

      /* New styles for recommendation sections with checkboxes */
      .recommendation-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
      }

      .recommendation-header label {
        margin-bottom: 0;
        flex: 1;
      }

      .recommendation-checkbox {
        display: flex;
        align-items: center;
        gap: 5px;
        white-space: nowrap;
      }

      .na-button {
        background: #6c757d;
        margin-left: 10px;
      }

      .na-button:hover {
        background: #5a6268;
      }

      .recommendation-section {
        display: flex;
        gap: 20px;
        align-items: flex-start;
      }

      .recommendation-textarea {
        flex: 2;
      }

      .risk-profile-inline {
        flex: 1;
        min-width: 250px;
      }

      .risk-profile-inline .form-group {
        margin-bottom: 0;
      }

      /* Strikethrough styling for N/A items */
      .strikethrough {
        text-decoration: line-through;
        opacity: 0.6;
      }

      .checklist-item.na-active {
        text-decoration: line-through;
        opacity: 0.6;
      }

      @media print {
        body {
          background: white;
          padding: 0;
        }

        .container {
          box-shadow: none;
          max-width: 100%;
          padding: 20px;
          margin-top: 0;
        }

        .btn-group,
        .no-print,
        .draft-selector,
        .auto-save-indicator {
          display: none !important;
        }

        .section {
          page-break-inside: avoid;
          box-shadow: none;
          border-left: 2px solid var(--accent);
        }

        input,
        textarea,
        select {
          border: 1px solid #ddd !important;
          background: white !important;
        }
      }

      /* For responsive design */
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .container {
          padding: 20px;
          margin-top: 120px;
        }

        .draft-selector {
          position: relative;
          top: auto;
          right: auto;
          margin-bottom: 20px;
          max-width: 100%;
          flex-direction: column;
          align-items: stretch;
          gap: 10px;
        }

        .draft-selector select {
          width: 100%;
        }

        .draft-selector .btn {
          width: 100%;
          flex: none;
        }

        .grid-2 {
          grid-template-columns: 1fr;
        }

        .grid-3 {
          grid-template-columns: 1fr;
        }

        .checkbox-group.client-types {
          flex-direction: column;
        }

        .radio-group {
          flex-direction: column;
        }

        .btn-group {
          flex-direction: column;
          align-items: stretch;
        }

        .modal-content {
          width: 95%;
          margin: 10% auto;
        }

        .recommendation-section {
          flex-direction: column;
        }

        .risk-profile-inline {
          min-width: auto;
        }
      }
    </style>
  </head>
  <body>
    <!-- Draft Selector (Share as Link button removed) -->
    <div class="draft-selector">
      <label for="draftSelector">Load Draft:</label>
      <select id="draftSelector">
        <option value="">Select a saved draft...</option>
      </select>
      <button type="button" class="btn btn-sm" id="loadDraftBtn">Load</button>
      <button type="button" class="btn btn-danger btn-sm" id="deleteDraftBtn">
        Delete
      </button>
    </div>

    <div class="container">
      <h1>Statement of Advice Request Form</h1>

      <!-- Client Type Section -->
      <section class="section" id="clientTypeSection">
        <h2><i class="fas fa-user-circle"></i> Client Details</h2>

        <!-- New/Existing Client Selector -->
        <div class="form-group">
          <label>Client Status:</label>
          <div class="radio-group">
            <div class="radio-item">
              <input
                type="radio"
                id="newClient"
                name="clientStatus"
                value="new"
              />
              <label for="newClient">
                <i class="fas fa-plus-circle"></i>
                New Client
              </label>
            </div>
            <div class="radio-item">
              <input
                type="radio"
                id="existingClient"
                name="clientStatus"
                value="existing"
              />
              <label for="existingClient">
                <i class="fas fa-user-check"></i>
                Existing Client
              </label>
            </div>
          </div>
        </div>

        <!-- Client Type Selector -->
        <div class="form-group">
          <label>Select Client Type (multiple selections allowed):</label>
          <div class="checkbox-group client-types">
            <div class="checkbox-item">
              <input
                type="checkbox"
                id="singleClient"
                name="clientType"
                value="single"
              />
              <label for="singleClient">
                <i class="fas fa-user"></i>
                Single Client
              </label>
            </div>
            <div class="checkbox-item">
              <input
                type="checkbox"
                id="coupleClient"
                name="clientType"
                value="couple"
              />
              <label for="coupleClient">
                <i class="fas fa-users"></i>
                Couple
              </label>
            </div>
            <div class="checkbox-item">
              <input
                type="checkbox"
                id="dependantsClient"
                name="clientType"
                value="dependants"
              />
              <label for="dependantsClient">
                <i class="fas fa-child"></i>
                Dependants
              </label>
            </div>
            <div class="checkbox-item">
              <input
                type="checkbox"
                id="entityClient"
                name="clientType"
                value="entity"
              />
              <label for="entityClient">
                <i class="fas fa-building"></i>
                Entity
              </label>
            </div>
          </div>

          <!-- Entity Type Selector (shows only when entity is selected) -->
          <div class="entity-selector" id="entitySelector">
            <label>Select Entity Type:</label>
            <div class="checkbox-group entity-types">
              <div class="checkbox-item">
                <input
                  type="checkbox"
                  id="entitySMSF"
                  name="entityType"
                  value="SMSF"
                />
                <label for="entitySMSF">SMSF</label>
              </div>
              <div class="checkbox-item">
                <input
                  type="checkbox"
                  id="entityTrust"
                  name="entityType"
                  value="Trust"
                />
                <label for="entityTrust">Trust</label>
              </div>
              <div class="checkbox-item">
                <input
                  type="checkbox"
                  id="entityCompany"
                  name="entityType"
                  value="Company"
                />
                <label for="entityCompany">Company</label>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Strategy Details Section -->
      <section class="section" id="strategyDetailsSection">
        <h2><i class="fas fa-info-circle"></i> Strategy Details</h2>

        <div class="grid-2">
          <div class="form-group" id="clientNameGroup">
            <label for="clientName">Client 1 Name:</label>
            <input
              type="text"
              id="clientName"
              name="clientName"
              placeholder="Enter client name"
            />
          </div>

          <div class="form-group" id="partnerNameGroup" style="display: none">
            <label for="partnerName">Client 2 Name (Spouse):</label>
            <input
              type="text"
              id="partnerName"
              name="partnerName"
              placeholder="Enter partner name"
            />
          </div>
        </div>

        <div class="form-group" id="entityNameGroup" style="display: none">
          <label for="entityName">Entity Name:</label>
          <input
            type="text"
            id="entityName"
            name="entityName"
            placeholder="Enter entity name"
          />
        </div>

        <!-- Separate entity name fields -->
        <div class="form-group" id="smsfNameGroup" style="display: none">
          <label for="smsfName">SMSF Name:</label>
          <input
            type="text"
            id="smsfName"
            name="smsfName"
            placeholder="Enter SMSF name"
          />
        </div>

        <div class="form-group" id="trustNameGroup" style="display: none">
          <label for="trustName">Trust Name:</label>
          <input
            type="text"
            id="trustName"
            name="trustName"
            placeholder="Enter Trust name"
          />
        </div>

        <div class="form-group" id="companyNameGroup" style="display: none">
          <label for="companyName">Company Name:</label>
          <input
            type="text"
            id="companyName"
            name="companyName"
            placeholder="Enter Company name"
          />
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label for="xplanId">Xplan ID (if applicable):</label>
            <input
              type="text"
              id="xplanId"
              name="xplanId"
              placeholder="Enter Xplan ID"
            />
          </div>

          <div class="form-group">
            <label for="adviserName">Adviser Name:</label>
            <input
              type="text"
              id="adviserName"
              name="adviserName"
              placeholder="Enter adviser name"
            />
          </div>
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label for="clientMeetingDate">Client Meeting Date:</label>
            <input
              type="date"
              id="clientMeetingDate"
              name="clientMeetingDate"
            />
          </div>

          <div class="form-group">
            <label for="formCompletedBy">Form Completed by:</label>
            <input
              type="text"
              id="formCompletedBy"
              name="formCompletedBy"
              placeholder="Enter your name"
            />
          </div>
        </div>
      </section>

      <!-- Strategy Recommendations Section -->
      <section class="section" id="strategyRecommendationsSection">
        <h2><i class="fas fa-lightbulb"></i> Strategy Recommendations</h2>

        <div id="recommendationsSectionsContainer">
          <!-- Dynamic recommendation sections will be added here -->
        </div>

        <div class="form-group">
          <label for="goalAlignment"
            >How strategy aligns to goals and objectives?</label
          >
          <textarea
            id="goalAlignment"
            name="goalAlignment"
            placeholder="Explain how the strategy aligns with client goals and objectives"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="mdaDetails">
            MDA Personalisation:
            <button
              type="button"
              class="btn btn-secondary btn-sm na-button"
              id="mdaNABtn"
            >
              N/A
            </button>
          </label>
          <textarea
            id="mdaDetails"
            name="mdaDetails"
            placeholder="Enter MDA personalisation details"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="tmdDetails">
            TMD:
            <span class="inline-checkbox">
              <input type="checkbox" id="tmdInFilenote" name="tmdInFilenote" />
              <label for="tmdInFilenote">TMD in filenote?</label>
            </span>
          </label>
          <textarea
            id="tmdDetails"
            name="tmdDetails"
            placeholder="Enter TMD details"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="inaccurateInfo"
            >Any potentially inaccurate or incomplete information:</label
          >
          <textarea
            id="inaccurateInfo"
            name="inaccurateInfo"
            placeholder="Include reasons why information may be inaccurate or was not provided"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="alternativeStrategies">Alternatives - strategies:</label>
          <textarea
            id="alternativeStrategies"
            name="alternativeStrategies"
            placeholder="Enter alternative strategies"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="alternativePlatforms">
            Alternatives - platforms:
            <span class="inline-checkbox">
              <input
                type="checkbox"
                id="paraplannerCompare"
                name="paraplannerCompare"
              />
              <label for="paraplannerCompare"
                >Paraplanner to complete compare</label
              >
            </span>
          </label>
          <textarea
            id="alternativePlatforms"
            name="alternativePlatforms"
            placeholder="Enter alternative platforms"
          ></textarea>
        </div>
      </section>

      <!-- Flowchart Section -->
      <section class="section" id="flowchartSection">
        <h2><i class="fas fa-project-diagram"></i> Flowchart</h2>

        <div class="form-group">
          <div class="yes-no-label">
            <label for="flowchartRequired">Flowchart required?</label>
            <label class="toggle-switch">
              <input
                type="checkbox"
                id="flowchartRequired"
                name="flowchartRequired"
              />
              <span class="slider"></span>
            </label>
            <span id="flowchartStatus">No</span>
          </div>
        </div>
      </section>

      <!-- SOA Projections Section -->
      <section class="section" id="soaProjectionsSection">
        <h2><i class="fas fa-chart-line"></i> SOA Projections</h2>

        <div class="form-group">
          <label for="projectionDateLength">Projection date length:</label>
          <select id="projectionDateLength" name="projectionDateLength">
            <option value="lifeExpectancy">Life Expectancy (default)</option>
            <option value="noProjections">No projections needed</option>
            <option value="lifeExpectancy5">Life Expectancy + 5 years</option>
            <option value="lifeExpectancy10">Life Expectancy + 10 years</option>
            <option value="5">5 years</option>
            <option value="10">10 years</option>
            <option value="15">15 years</option>
            <option value="20">20 years</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div
          class="form-group"
          id="otherProjectionLength"
          style="display: none"
        >
          <label for="otherProjectionLengthValue"
            >Specify other projection length:</label
          >
          <input
            type="number"
            id="otherProjectionLengthValue"
            name="otherProjectionLengthValue"
            placeholder="Enter number of years"
          />
        </div>

        <div class="form-group" id="customProjectionInstructions">
          <label for="customInstructions">Custom Instructions:</label>
          <textarea
            id="customInstructions"
            name="customInstructions"
            placeholder="Enter any custom projection instructions"
          ></textarea>
        </div>

        <div class="form-group" id="projectionOptionsGroup">
          <div class="checklist-item">
            <input
              type="checkbox"
              id="calmChart"
              name="projectionOptions"
              value="CALM"
            />
            <label for="calmChart"
              >CALM to chart, cashflow consolidated table, asset summary chart
              and table</label
            >
          </div>

          <div class="checklist-item">
            <input
              type="checkbox"
              id="contributionsTable"
              name="projectionOptions"
              value="Contributions"
            />
            <label for="contributionsTable"
              >If contributions advice is relevant, we need a before and after
              tax table Year 1</label
            >
          </div>

          <div class="checklist-item">
            <input
              type="checkbox"
              id="pensionTable"
              name="projectionOptions"
              value="Pension"
            />
            <label for="pensionTable"
              >If aged pension advice is relevant we need a before and after
              aged pension table Year 1</label
            >
          </div>

          <div class="checklist-item">
            <input
              type="checkbox"
              id="insuranceProjection"
              name="projectionOptions"
              value="Insurance"
            />
            <label for="insuranceProjection"
              >If insurance advice is relevant we need insurance premiums 10
              years with premiums indexed at 10%</label
            >
          </div>
        </div>
      </section>

      <!-- SOA Fees Section -->
      <section class="section" id="soaFeesSection">
        <h2><i class="fas fa-dollar-sign"></i> SOA Fees (including GST)</h2>

        <div class="grid-2">
          <div class="form-group">
            <label for="upfrontFee">Upfront Fee:</label>
            <input
              type="text"
              id="upfrontFee"
              name="upfrontFee"
              placeholder=""
            />
          </div>

          <div class="form-group">
            <label for="paymentMethod">Method of payment:</label>
            <input
              type="text"
              id="paymentMethod"
              name="paymentMethod"
              placeholder=""
            />
          </div>
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label for="implementationFee">Implementation fee:</label>
            <input
              type="text"
              id="implementationFee"
              name="implementationFee"
              placeholder=""
            />
          </div>

          <div class="form-group">
            <label for="ongoingFee">
              Ongoing Advice Fee:
              <span class="inline-checkbox">
                <input
                  type="checkbox"
                  id="ongoingFeeRefer"
                  name="ongoingFeeRefer"
                />
                <label for="ongoingFeeRefer">Refer to Pricing Calculator</label>
              </span>
            </label>
            <input
              type="text"
              id="ongoingFee"
              name="ongoingFee"
              placeholder=""
            />
          </div>
        </div>

        <div class="form-group">
          <label for="ongoingPcmFee">Ongoing PC&M Fee:</label>
          <input
            type="text"
            id="ongoingPcmFee"
            name="ongoingPcmFee"
            placeholder=""
          />
        </div>

        <div id="dynamicFeesContainer">
          <!-- Dynamic fees will be added here based on entity selections -->
        </div>

        <div class="form-group">
          <label for="referralFee">Referral Fee Applicable:</label>
          <input
            type="text"
            id="referralFee"
            name="referralFee"
            placeholder="Enter referral fee or N/A"
          />
        </div>
      </section>

      <!-- Additional Comments Section -->
      <section class="section" id="additionalCommentsSection">
        <h2><i class="fas fa-comment-alt"></i> Additional Comments/Notes</h2>

        <div class="form-group">
          <textarea
            id="additionalComments"
            name="additionalComments"
            placeholder="Enter any additional comments or notes"
          ></textarea>
        </div>
      </section>

      <!-- Compliance Checklist Section -->
      <section class="section" id="checklistSection">
        <h2><i class="fas fa-tasks"></i> Compliance Checklist</h2>

        <div class="note">
          <p>
            Please ensure the required documents and approvals are obtained and
            uploaded prior to submitting your request to the paraplanning team.
          </p>
        </div>

        <h3>All Advice documents</h3>
        <div class="form-group">
          <div class="checklist-item">
            <input
              type="checkbox"
              id="factFind"
              name="requiredDocs"
              value="FactFind"
            />
            <label for="factFind">Fact Find (dated within 12 months)</label>
          </div>

          <div class="checklist-item">
            <input
              type="checkbox"
              id="filenote"
              name="requiredDocs"
              value="Filenote"
            />
            <label for="filenote">Filenote</label>
          </div>

          <div class="checklist-item" id="pricingCalculatorItem">
            <input
              type="checkbox"
              id="pricingCalculator"
              name="requiredDocs"
              value="PricingCalculator"
            />
            <label for="pricingCalculator">Pricing Calculator</label>
            <button
              type="button"
              class="btn btn-secondary btn-sm na-button"
              id="pricingCalculatorNABtn"
            >
              N/A
            </button>
          </div>

          <div class="checklist-item" id="beneficiaryNominationItem">
            <input
              type="checkbox"
              id="beneficiaryNomination"
              name="compliance"
              value="BeneficiaryNomination"
            />
            <label for="beneficiaryNomination"
              >Beneficiary nomination advice made (if relevant)</label
            >
            <button
              type="button"
              class="btn btn-secondary btn-sm na-button"
              id="beneficiaryNominationNABtn"
            >
              N/A
            </button>
          </div>
        </div>

        <h3>Compliance Requirements</h3>
        <div id="complianceRequirements">
          <!-- Dynamic compliance requirements will be added here -->
        </div>
      </section>

      <!-- Save Draft Modal -->
      <div id="saveDraftModal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h3>Save Draft</h3>
          <div class="form-group">
            <label for="draftName">Draft Name:</label>
            <input
              type="text"
              id="draftName"
              placeholder="Enter draft name (e.g., Client Name ARF)"
            />
          </div>
          <div class="modal-buttons">
            <button type="button" class="btn btn-success" id="confirmSaveDraft">
              Save
            </button>
            <button type="button" class="btn btn-danger" id="cancelSaveDraft">
              Cancel
            </button>
          </div>
        </div>
      </div>

      <!-- Button Group -->
      <div class="btn-group">
        <button type="button" class="btn" id="saveBtn">
          <i class="fas fa-save"></i> Save as Draft
        </button>
        <button type="button" class="btn btn-success" id="exportWordBtn">
          <i class="fas fa-file-word"></i> Export to Word
        </button>
        <button type="button" class="btn btn-success" id="exportPdfBtn">
          <i class="fas fa-file-pdf"></i> Export to PDF
        </button>
        <button
          type="button"
          class="btn btn-success"
          id="emailDocumentBtnBottom"
        >
          <i class="fas fa-envelope"></i> Email Document
        </button>
        <button type="button" class="btn btn-danger" id="resetBtn">
          <i class="fas fa-undo"></i> Reset Form
        </button>
      </div>
    </div>

    <!-- Auto-save indicator -->
    <div id="autoSaveIndicator" class="auto-save-indicator">
      <i class="fas fa-save"></i> Auto-saved
    </div>

    <script>
      // FIXED DRAFT SAVE/LOAD SYSTEM - Comprehensive solution for all dynamic elements
      document.addEventListener("DOMContentLoaded", function () {
        // Client Status Radio Buttons
        const newClientRadio = document.getElementById("newClient");
        const existingClientRadio = document.getElementById("existingClient");

        // Client Type Checkboxes
        const singleClientCheckbox = document.getElementById("singleClient");
        const coupleClientCheckbox = document.getElementById("coupleClient");
        const dependantsClientCheckbox =
          document.getElementById("dependantsClient");
        const entityClientCheckbox = document.getElementById("entityClient");
        const entitySelector = document.getElementById("entitySelector");

        // Entity Type Checkboxes
        const entitySMSFCheckbox = document.getElementById("entitySMSF");
        const entityTrustCheckbox = document.getElementById("entityTrust");
        const entityCompanyCheckbox = document.getElementById("entityCompany");

        // Form Groups that are conditionally shown
        const partnerNameGroup = document.getElementById("partnerNameGroup");
        const entityNameGroup = document.getElementById("entityNameGroup");
        const smsfNameGroup = document.getElementById("smsfNameGroup");
        const trustNameGroup = document.getElementById("trustNameGroup");
        const companyNameGroup = document.getElementById("companyNameGroup");

        // Yes/No Toggle
        const flowchartRequiredToggle =
          document.getElementById("flowchartRequired");
        const flowchartStatus = document.getElementById("flowchartStatus");

        // Projection Length Dropdown
        const projectionDateLength = document.getElementById(
          "projectionDateLength",
        );
        const otherProjectionLength = document.getElementById(
          "otherProjectionLength",
        );

        // Buttons
        const saveBtn = document.getElementById("saveBtn");
        const exportWordBtn = document.getElementById("exportWordBtn");
        const exportPdfBtn = document.getElementById("exportPdfBtn");
        const resetBtn = document.getElementById("resetBtn");
        const emailDocumentBtnBottom = document.getElementById(
          "emailDocumentBtnBottom",
        );

        // Draft functionality
        const draftSelector = document.getElementById("draftSelector");
        const loadDraftBtn = document.getElementById("loadDraftBtn");
        const deleteDraftBtn = document.getElementById("deleteDraftBtn");
        const saveDraftModal = document.getElementById("saveDraftModal");
        const draftNameInput = document.getElementById("draftName");
        const confirmSaveDraftBtn = document.getElementById("confirmSaveDraft");
        const cancelSaveDraftBtn = document.getElementById("cancelSaveDraft");
        const closeModal = document.querySelector(".close");
        const autoSaveIndicator = document.getElementById("autoSaveIndicator");

        // Alternative platforms checkbox
        const paraplannerCompareCheckbox =
          document.getElementById("paraplannerCompare");
        const alternativePlatformsTextarea = document.getElementById(
          "alternativePlatforms",
        );

        // TMD checkbox
        const tmdInFilenoteCheckbox = document.getElementById("tmdInFilenote");
        const tmdDetailsTextarea = document.getElementById("tmdDetails");

        // Ongoing Fee checkbox
        const ongoingFeeReferCheckbox =
          document.getElementById("ongoingFeeRefer");
        const ongoingFeeInput = document.getElementById("ongoingFee");
        const ongoingPcmFeeInput = document.getElementById("ongoingPcmFee");

        // N/A buttons
        const pricingCalculatorNABtn = document.getElementById(
          "pricingCalculatorNABtn",
        );
        const pricingCalculatorItem = document.getElementById(
          "pricingCalculatorItem",
        );
        const beneficiaryNominationNABtn = document.getElementById(
          "beneficiaryNominationNABtn",
        );
        const beneficiaryNominationItem = document.getElementById(
          "beneficiaryNominationItem",
        );

        // Product options
        const productOptions = [
          "Centric IDPS",
          "Centric Super Choice Accumulation",
          "Centric Super One Accumulation",
          "Centric Super Choice Pension",
          "Centric Super One Pension",
          "CFS Edge IDPS",
          "CFS Edge Super",
          "CFS Edge Pension",
          "BT Panorama IDPS",
          "BT Panorama Pension",
          "BT Panorama Super",
          "LifeFocus Wholesale Investment",
          "LifeFocus Wholesale Super",
          "LifeFocus Wholesale Pension",
          "LifeFocus Private Super",
          "LifeFocus Private Pension",
          "LifeFocus Private Investment",
          "Custom",
        ];

        // Risk profile options
        const riskProfiles = [
          "Conservative",
          "Defensive",
          "Moderate",
          "Balanced",
          "Growth",
          "High Growth",
          "Growth Plus",
          "Custom",
        ];

        // Product counter for unique IDs
        let productCounter = 0;
        let autoSaveTimeout;

        // Initialize draft functionality
        initializeDraftFunctionality();

        // Check for shared form data in URL
        checkForSharedData();

        // Set up auto-save
        setupAutoSave();

        // Set up checkbox visual selection effect
        document.querySelectorAll(".checkbox-item").forEach((item) => {
          const checkbox = item.querySelector('input[type="checkbox"]');

          if (checkbox) {
            // Update visual selection on checkbox change
            checkbox.addEventListener("change", function () {
              if (this.checked) {
                item.classList.add("selected");
              } else {
                item.classList.remove("selected");
              }
              updateFormBasedOnSelections();
              triggerAutoSave();
            });

            // Also make the label and checkbox item interactive
            item.addEventListener("click", function (e) {
              if (e.target !== checkbox) {
                checkbox.checked = !checkbox.checked;
                checkbox.dispatchEvent(new Event("change"));
              }
            });
          }
        });

        // Handle entity checkbox to show entity selector
        entityClientCheckbox.addEventListener("change", function () {
          if (this.checked) {
            entitySelector.style.display = "block";
          } else {
            entitySelector.style.display = "none";
            // Uncheck entity type checkboxes when entity is unchecked
            entitySMSFCheckbox.checked = false;
            entityTrustCheckbox.checked = false;
            entityCompanyCheckbox.checked = false;

            document
              .querySelectorAll(".entity-types .checkbox-item")
              .forEach((item) => {
                item.classList.remove("selected");
              });
          }
          updateFormBasedOnSelections();
        });

        // Function to create searchable dropdown - FIXED to prevent unwanted visibility
        function createSearchableDropdown(inputId, options, onChange) {
          const input = document.getElementById(inputId);
          if (!input) return;

          // Check if dropdown already exists to prevent duplicates
          if (input.parentElement.classList.contains("searchable-select")) {
            return;
          }

          const wrapper = document.createElement("div");
          wrapper.className = "searchable-select";
          input.parentNode.insertBefore(wrapper, input);
          wrapper.appendChild(input);

          const dropdown = document.createElement("div");
          dropdown.className = "dropdown-list";
          wrapper.appendChild(dropdown);

          // Populate dropdown
          options.forEach((option) => {
            const item = document.createElement("div");
            item.className = "dropdown-item";
            item.textContent = option;
            item.addEventListener("click", function () {
              input.value = option;
              dropdown.classList.remove("active");
              if (onChange) onChange(option);
              triggerAutoSave();
            });
            dropdown.appendChild(item);
          });

          // Show/hide dropdown
          input.addEventListener("focus", function () {
            dropdown.classList.add("active");
          });

          input.addEventListener("blur", function () {
            setTimeout(() => dropdown.classList.remove("active"), 200);
          });

          // Filter options
          input.addEventListener("input", function () {
            const filter = this.value.toLowerCase();
            const items = dropdown.querySelectorAll(".dropdown-item");
            items.forEach((item) => {
              const text = item.textContent.toLowerCase();
              item.style.display = text.includes(filter) ? "block" : "none";
            });
            
            // FIXED: Only show dropdown when user is actively typing, not during load
            if (document.activeElement === this) {
              dropdown.classList.add("active");
            }
            triggerAutoSave();
          });

          // FIXED: Ensure dropdown is hidden initially and during load
          dropdown.classList.remove("active");
        }

        // Function to create product recommendation item
        function createProductRecommendation(
          clientId,
          clientName,
          productIndex,
        ) {
          const productId = `${clientId}_product_${productIndex}`;

          const productHTML = `
            <div class="product-item" id="${productId}">
                <div class="product-header">
                    <h5>Product ${productIndex + 1}</h5>
                    ${productIndex > 0 ? `<button type="button" class="btn btn-danger btn-sm" onclick="removeProduct('${productId}')">Remove</button>` : ""}
                </div>
                
                <div class="grid-3-custom">
                    <div class="form-group">
                        <label for="${productId}_name">Product Name:</label>
                        <input type="text" id="${productId}_name" name="${productId}_name" placeholder="Type to search products">
                    </div>
                    <div class="form-group custom-input" id="${productId}_custom_group" style="display: none;">
                        <label for="${productId}_custom">Custom Product:</label>
                        <input type="text" id="${productId}_custom" name="${productId}_custom" placeholder="Enter custom product name">
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label for="${productId}_investment">Product Investment/s:</label>
                        <textarea id="${productId}_investment" name="${productId}_investment" placeholder="Enter investment details (can list multiple investments)" style="min-height: 60px; resize: vertical;"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="${productId}_cash">Cash Preference:</label>
                        <input type="text" id="${productId}_cash" name="${productId}_cash" placeholder="Enter cash preference amount">
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="yes-no-label">
                        <label for="${productId}_tranching">Tranching:</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="${productId}_tranching" name="${productId}_tranching">
                            <span class="slider"></span>
                        </label>
                        <span id="${productId}_tranching_status">No</span>
                    </div>
                </div>
                
                <div class="tranching-details" id="${productId}_tranching_details" style="display: none;">
                    <div class="form-group">
                        <label for="${productId}_tranching_text">Tranching Details:</label>
                        <textarea id="${productId}_tranching_text" name="${productId}_tranching_text" placeholder="Enter tranching details"></textarea>
                    </div>
                </div>
                
                <div class="mda-section" id="${productId}_mda_section" style="display: none;">
                    <div class="form-group">
                        <div class="yes-no-label">
                            <label for="${productId}_mda">MDA:</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="${productId}_mda" name="${productId}_mda">
                                <span class="slider"></span>
                            </label>
                            <span id="${productId}_mda_status">No</span>
                        </div>
                    </div>
                    
                    <div class="form-group" id="${productId}_investment_options" style="display: none;">
                        <label for="${productId}_investment_option">Investment Option:</label>
                        <select id="${productId}_investment_option" name="${productId}_investment_option">
                            <option value="">Select investment option</option>
                        </select>
                    </div>
                </div>
            </div>
        `;

          return productHTML;
        }

        // Function to remove product
        window.removeProduct = function (productId) {
          const element = document.getElementById(productId);
          if (element) {
            element.remove();
            triggerAutoSave();
          }
        };

        // Function to fill Joint sections with N/A
        window.fillJointNA = function () {
          const jointRecommendations = document.getElementById(
            "jointRecommendations",
          );
          if (jointRecommendations) {
            jointRecommendations.value =
              "N/A - No joint recommendations required";
            triggerAutoSave();
          }
        };

        window.fillJointProductNA = function () {
          // Hide the joint product section and mark as N/A
          const jointProductCheckbox = document.getElementById(
            "jointProductRecsCheckbox",
          );
          const jointProductSection = document.getElementById(
            "jointProductRecommendationsSection",
          );

          if (jointProductCheckbox && jointProductSection) {
            jointProductCheckbox.checked = false;
            jointProductSection.style.display = "none";
            triggerAutoSave();
          }
        };

        window.fillJointRiskNA = function () {
          const jointRiskProfile = document.getElementById("riskProfileJoint");
          if (jointRiskProfile) {
            jointRiskProfile.value = "na";
            triggerAutoSave();
          }
        };

        // Function to add product - FIXED to save properly
        window.addProduct = function (clientId, clientName) {
          console.log(`=== ADDING PRODUCT FOR ${clientId} ===`);
          
          const container = document.getElementById(`${clientId}_products`);
          const productCount = container.querySelectorAll(".product-item").length;

          const newProductHTML = createProductRecommendation(
            clientId,
            clientName,
            productCount,
          );
          container.insertAdjacentHTML("beforeend", newProductHTML);

          console.log(`Added product ${productCount} for ${clientId}`);

          // IMMEDIATE initialization and save
          setTimeout(() => {
            console.log("Initializing new product features...");
            initializeProductFeatures();
            setupAutoSaveForNewElements();
            
            // FORCE SAVE the updated structure immediately
            console.log("Force saving after adding product...");
            const clientName = document.getElementById("clientName").value || "Client";
            saveDraft(`${clientName} - Auto Save`, true);
            
            console.log("Product addition complete and saved");
          }, 150); // Slightly longer timeout to ensure DOM is ready
        };

        // Function to update recommendation sections based on selections
        function updateRecommendationSections() {
          const container = document.getElementById(
            "recommendationsSectionsContainer",
          );
          container.innerHTML = "";

          // Get client names
          const clientName =
            document.getElementById("clientName").value || "Client 1";
          const partnerName =
            document.getElementById("partnerName").value || "Client 2";

          // Add client recommendations if single or couple is selected
          if (singleClientCheckbox.checked || coupleClientCheckbox.checked) {
            const clientRecommendationHTML = `
                <div class="recommendation-section">
                    <div class="recommendation-textarea">
                        <div class="recommendation-header">
                            <label for="clientRecommendations">${clientName} Recommendations:</label>
                            <div class="recommendation-checkbox">
                                <input type="checkbox" id="client1ProductRecsCheckbox" name="client1ProductRecsCheckbox">
                                <label for="client1ProductRecsCheckbox">Product Recommendations?</label>
                            </div>
                        </div>
                        <textarea id="clientRecommendations" name="clientRecommendations" 
                            placeholder="Enter recommendations for ${clientName}"></textarea>
                    </div>
                    <div class="risk-profile-inline">
                        <div class="form-group">
                            <label for="riskProfile1">Risk Profile - ${clientName}:</label>
                            <select id="riskProfile1" name="riskProfile1">
                                <option value="">Select Risk Profile</option>
                                <option value="conservative">Conservative</option>
                                <option value="defensive">Defensive</option>
                                <option value="moderate">Moderate</option>
                                <option value="balanced">Balanced</option>
                                <option value="growth">Growth</option>
                                <option value="highGrowth">High Growth</option>
                                <option value="growthPlus">Growth Plus</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="product-recommendations" id="client1ProductRecommendationsSection" style="display: none;">
                    <h4>Product Recommendations - ${clientName}</h4>
                    <div id="client1_products">
                        ${createProductRecommendation("client1", clientName, 0)}
                    </div>
                    <button type="button" class="btn btn-success btn-sm add-product-btn" onclick="addProduct('client1', '${clientName}')">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                </div>
            `;

            container.insertAdjacentHTML("beforeend", clientRecommendationHTML);
          }

          // Add partner recommendations if couple is selected
          if (coupleClientCheckbox.checked) {
            const partnerRecommendationHTML = `
                <div class="recommendation-section">
                    <div class="recommendation-textarea">
                        <div class="recommendation-header">
                            <label for="partnerRecommendations">${partnerName} Recommendations:</label>
                            <div class="recommendation-checkbox">
                                <input type="checkbox" id="client2ProductRecsCheckbox" name="client2ProductRecsCheckbox">
                                <label for="client2ProductRecsCheckbox">Product Recommendations?</label>
                            </div>
                        </div>
                        <textarea id="partnerRecommendations" name="partnerRecommendations" 
                            placeholder="Enter recommendations for ${partnerName}"></textarea>
                    </div>
                    <div class="risk-profile-inline">
                        <div class="form-group">
                            <label for="riskProfile2">Risk Profile - ${partnerName}:</label>
                            <select id="riskProfile2" name="riskProfile2">
                                <option value="">Select Risk Profile</option>
                                <option value="conservative">Conservative</option>
                                <option value="defensive">Defensive</option>
                                <option value="moderate">Moderate</option>
                                <option value="balanced">Balanced</option>
                                <option value="growth">Growth</option>
                                <option value="highGrowth">High Growth</option>
                                <option value="growthPlus">Growth Plus</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="product-recommendations" id="client2ProductRecommendationsSection" style="display: none;">
                    <h4>Product Recommendations - ${partnerName}</h4>
                    <div id="client2_products">
                        ${createProductRecommendation("client2", partnerName, 0)}
                    </div>
                    <button type="button" class="btn btn-success btn-sm add-product-btn" onclick="addProduct('client2', '${partnerName}')">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                </div>
                
                <div class="recommendation-section">
                    <div class="recommendation-textarea">
                        <div class="recommendation-header">
                            <label for="jointRecommendations">Joint Recommendations:</label>
                            <div class="recommendation-checkbox">
                                <input type="checkbox" id="jointProductRecsCheckbox" name="jointProductRecsCheckbox">
                                <label for="jointProductRecsCheckbox">Product Recommendations?</label>
                            </div>
                        </div>
                        <textarea id="jointRecommendations" name="jointRecommendations" 
                            placeholder="Enter joint recommendations"></textarea>
                        <button type="button" class="btn btn-secondary btn-sm na-button" onclick="fillJointNA()">
                            N/A
                        </button>
                    </div>
                    <div class="risk-profile-inline">
                        <div class="form-group">
                            <label for="riskProfileJoint">Risk Profile - Joint:</label>
                            <select id="riskProfileJoint" name="riskProfileJoint">
                                <option value="">Select Risk Profile</option>
                                <option value="conservative">Conservative</option>
                                <option value="defensive">Defensive</option>
                                <option value="moderate">Moderate</option>
                                <option value="balanced">Balanced</option>
                                <option value="growth">Growth</option>
                                <option value="highGrowth">High Growth</option>
                                <option value="growthPlus">Growth Plus</option>
                                <option value="na">N/A</option>
                                <option value="custom">Custom</option>
                            </select>
                            <button type="button" class="btn btn-secondary btn-sm na-button" onclick="fillJointRiskNA()">
                                N/A
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="product-recommendations" id="jointProductRecommendationsSection" style="display: none;">
                    <h4>Product Recommendations - Joint</h4>
                    <div id="joint_products">
                        ${createProductRecommendation("joint", "Joint", 0)}
                    </div>
                    <button type="button" class="btn btn-success btn-sm add-product-btn" onclick="addProduct('joint', 'Joint')">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm na-button" onclick="fillJointProductNA()">
                        N/A
                    </button>
                </div>
            `;

            container.insertAdjacentHTML(
              "beforeend",
              partnerRecommendationHTML,
            );
          }

          // Add entity recommendations
          if (entityClientCheckbox.checked) {
            if (entitySMSFCheckbox.checked) {
              const smsfName =
                document.getElementById("smsfName").value || "SMSF";
              addEntityRecommendation("SMSF", smsfName);
            }

            if (entityTrustCheckbox.checked) {
              const trustName =
                document.getElementById("trustName").value || "Trust";
              addEntityRecommendation("Trust", trustName);
            }

            if (entityCompanyCheckbox.checked) {
              const companyName =
                document.getElementById("companyName").value || "Company";
              addEntityRecommendation("Company", companyName);
            }
          }

          // Add dependants recommendations if selected
          if (dependantsClientCheckbox.checked) {
            const dependantsRecommendationHTML = `
                <div class="recommendation-section">
                    <div class="recommendation-textarea">
                        <div class="recommendation-header">
                            <label for="dependantsRecommendations">Dependants Recommendations:</label>
                            <div class="recommendation-checkbox">
                                <input type="checkbox" id="dependantsProductRecsCheckbox" name="dependantsProductRecsCheckbox">
                                <label for="dependantsProductRecsCheckbox">Product Recommendations?</label>
                            </div>
                        </div>
                        <textarea id="dependantsRecommendations" name="dependantsRecommendations" 
                            placeholder="Enter recommendations for dependants"></textarea>
                    </div>
                    <div class="risk-profile-inline">
                        <div class="form-group">
                            <label for="riskProfileDependants">Risk Profile - Dependants:</label>
                            <select id="riskProfileDependants" name="riskProfileDependants">
                                <option value="">Select Risk Profile</option>
                                <option value="conservative">Conservative</option>
                                <option value="defensive">Defensive</option>
                                <option value="moderate">Moderate</option>
                                <option value="balanced">Balanced</option>
                                <option value="growth">Growth</option>
                                <option value="highGrowth">High Growth</option>
                                <option value="growthPlus">Growth Plus</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="product-recommendations" id="dependantsProductRecommendationsSection" style="display: none;">
                    <h4>Product Recommendations - Dependants</h4>
                    <div id="dependants_products">
                        ${createProductRecommendation("dependants", "Dependants", 0)}
                    </div>
                    <button type="button" class="btn btn-success btn-sm add-product-btn" onclick="addProduct('dependants', 'Dependants')">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                </div>
            `;

            container.insertAdjacentHTML(
              "beforeend",
              dependantsRecommendationHTML,
            );
          }

          // Initialize all product dropdowns and event listeners
          setTimeout(() => {
            console.log("Starting product features initialization...");
            initializeProductFeatures();
            setupProductRecommendationToggles();
            setupAutoSaveForNewElements();

            // Ensure product recommendation sections are properly displayed based on saved state
            document
              .querySelectorAll('[id$="ProductRecsCheckbox"]')
              .forEach((checkbox) => {
                if (checkbox.checked) {
                  // Trigger the change event to show the section
                  const event = new Event("change");
                  checkbox.dispatchEvent(event);
                }
              });

            console.log(
              "Initialized recommendation sections with",
              document.querySelectorAll('[id$="ProductRecsCheckbox"]').length,
              "product checkboxes",
            );
            console.log(
              "Found",
              document.querySelectorAll('[id$="_mda"]').length,
              "MDA toggles",
            );
            console.log(
              "Found",
              document.querySelectorAll('[id$="_tranching"]').length,
              "tranching toggles",
            );
          }, 200); // Increased timeout for better reliability
        }

        // Function to setup product recommendation toggles
        function setupProductRecommendationToggles() {
          // Setup toggles for all product recommendation checkboxes
          const productRecsCheckboxes = document.querySelectorAll(
            '[id$="ProductRecsCheckbox"]',
          );

          productRecsCheckboxes.forEach((checkbox) => {
            if (!checkbox.hasAttribute("data-initialized")) {
              checkbox.setAttribute("data-initialized", "true");
              checkbox.addEventListener("change", function () {
                // Map checkbox IDs to section IDs
                const checkboxToSectionMap = {
                  client1ProductRecsCheckbox:
                    "client1ProductRecommendationsSection",
                  client2ProductRecsCheckbox:
                    "client2ProductRecommendationsSection",
                  jointProductRecsCheckbox:
                    "jointProductRecommendationsSection",
                  smsfProductRecsCheckbox: "smsfProductRecommendationsSection",
                  trustProductRecsCheckbox:
                    "trustProductRecommendationsSection",
                  companyProductRecsCheckbox:
                    "companyProductRecommendationsSection",
                  dependantsProductRecsCheckbox:
                    "dependantsProductRecommendationsSection",
                };

                const sectionId = checkboxToSectionMap[this.id];
                const section = document.getElementById(sectionId);
                if (section) {
                  section.style.display = this.checked ? "block" : "none";
                  console.log(
                    "Toggled",
                    sectionId,
                    "to",
                    this.checked ? "visible" : "hidden",
                  );
                }
                triggerAutoSave();
              });
            }
          });

          console.log(
            "Setup product recommendation toggles for",
            productRecsCheckboxes.length,
            "checkboxes",
          );
        }

        // Helper function to add entity recommendation sections
        function addEntityRecommendation(entityType, entityName) {
          const container = document.getElementById(
            "recommendationsSectionsContainer",
          );
          const entityId = entityType.toLowerCase();

          const entityRecommendationHTML = `
            <div class="recommendation-section">
                <div class="recommendation-textarea">
                    <div class="recommendation-header">
                        <label for="${entityId}Recommendations">${entityType} - ${entityName} Recommendations:</label>
                        <div class="recommendation-checkbox">
                            <input type="checkbox" id="${entityId}ProductRecsCheckbox" name="${entityId}ProductRecsCheckbox">
                            <label for="${entityId}ProductRecsCheckbox">Product Recommendations?</label>
                        </div>
                    </div>
                    <textarea id="${entityId}Recommendations" name="${entityId}Recommendations" 
                        placeholder="Enter recommendations for ${entityType}"></textarea>
                </div>
                <div class="risk-profile-inline">
                    <div class="form-group">
                        <label for="riskProfile${entityId}">Risk Profile - ${entityType}:</label>
                        <select id="riskProfile${entityId}" name="riskProfile${entityId}">
                            <option value="">Select Risk Profile</option>
                            <option value="conservative">Conservative</option>
                            <option value="defensive">Defensive</option>
                            <option value="moderate">Moderate</option>
                            <option value="balanced">Balanced</option>
                            <option value="growth">Growth</option>
                            <option value="highGrowth">High Growth</option>
                            <option value="growthPlus">Growth Plus</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="product-recommendations" id="${entityId}ProductRecommendationsSection" style="display: none;">
                <h4>Product Recommendations - ${entityType} - ${entityName}</h4>
                <div id="${entityId}_products">
                    ${createProductRecommendation(entityId, entityName, 0)}
                </div>
                <button type="button" class="btn btn-success btn-sm add-product-btn" onclick="addProduct('${entityId}', '${entityName}')">
                    <i class="fas fa-plus"></i> Add Product
                </button>
            </div>
        `;

          container.insertAdjacentHTML("beforeend", entityRecommendationHTML);
        }

        // Function to initialize product features
        function initializeProductFeatures() {
          console.log("Initializing product features...");

          // Initialize all product dropdowns
          document.querySelectorAll('[id$="_name"]').forEach((input) => {
            if (!input.parentElement.classList.contains("searchable-select")) {
              console.log("Setting up dropdown for:", input.id);
              createSearchableDropdown(
                input.id,
                productOptions,
                function (selectedProduct) {
                  const productId = input.id.replace("_name", "");
                  const customGroup = document.getElementById(
                    `${productId}_custom_group`,
                  );
                  const mdaSection = document.getElementById(
                    `${productId}_mda_section`,
                  );
                  const mdaCheckbox = document.getElementById(
                    `${productId}_mda`,
                  );

                  if (selectedProduct === "Custom") {
                    if (customGroup) customGroup.style.display = "block";
                    if (mdaSection) mdaSection.style.display = "none";
                    // Clear MDA-related fields for custom products
                    if (mdaCheckbox) {
                      mdaCheckbox.checked = false;
                      const status = document.getElementById(
                        `${productId}_mda_status`,
                      );
                      if (status) status.textContent = "No";
                      const investmentOptions = document.getElementById(
                        `${productId}_investment_options`,
                      );
                      if (investmentOptions)
                        investmentOptions.style.display = "none";
                      const investmentField = document.getElementById(
                        `${productId}_investment`,
                      );
                      if (
                        investmentField &&
                        investmentField.value ===
                          "Refer to Investment option below"
                      ) {
                        investmentField.value = "";
                      }
                    }
                  } else {
                    if (customGroup) customGroup.style.display = "none";

                    // Show MDA section for applicable products
                    if (
                      selectedProduct.includes("BT Panorama") ||
                      selectedProduct.includes("Centric Super Choice") ||
                      selectedProduct === "Centric IDPS"
                    ) {
                      if (mdaSection) mdaSection.style.display = "block";
                      // Enable MDA for applicable products
                      if (mdaCheckbox) {
                        mdaCheckbox.disabled = false;
                      }
                    } else if (selectedProduct.includes("Centric Super One")) {
                      if (mdaSection) mdaSection.style.display = "none";
                      // Hide MDA for Centric Super One
                      if (mdaCheckbox) {
                        mdaCheckbox.checked = false;
                        mdaCheckbox.disabled = true;
                        const status = document.getElementById(
                          `${productId}_mda_status`,
                        );
                        if (status) status.textContent = "No";
                        const investmentOptions = document.getElementById(
                          `${productId}_investment_options`,
                        );
                        if (investmentOptions)
                          investmentOptions.style.display = "none";
                      }
                    } else {
                      if (mdaSection) mdaSection.style.display = "none";
                    }
                  }
                },
              );
            }
          });

          // Initialize tranching toggles with ROBUST handling
          document.querySelectorAll('[id$="_tranching"]').forEach((toggle) => {
            if (!toggle.hasAttribute("data-initialized")) {
              toggle.setAttribute("data-initialized", "true");
              toggle.addEventListener("change", function () {
                const productId = this.id.replace("_tranching", "");
                const status = document.getElementById(
                  `${productId}_tranching_status`,
                );
                const details = document.getElementById(
                  `${productId}_tranching_details`,
                );

                if (status) status.textContent = this.checked ? "Yes" : "No";
                if (details) {
                  details.style.display = this.checked ? "block" : "none";
                  console.log(
                    "Tranching details visibility changed for",
                    productId,
                    "to",
                    this.checked ? "visible" : "hidden",
                  );
                }
                triggerAutoSave();
              });
              console.log("Initialized tranching toggle for:", toggle.id);
            }
          });

          // Initialize MDA toggles
          document.querySelectorAll('[id$="_mda"]').forEach((toggle) => {
            if (!toggle.hasAttribute("data-initialized")) {
              toggle.setAttribute("data-initialized", "true");
              toggle.addEventListener("change", function () {
                const productId = this.id.replace("_mda", "");
                const status = document.getElementById(
                  `${productId}_mda_status`,
                );
                const investmentOptions = document.getElementById(
                  `${productId}_investment_options`,
                );
                const investmentField = document.getElementById(
                  `${productId}_investment`,
                );

                if (status) status.textContent = this.checked ? "Yes" : "No";
                if (investmentOptions) {
                  investmentOptions.style.display = this.checked
                    ? "block"
                    : "none";
                }

                if (this.checked) {
                  updateInvestmentOptions(productId);

                  // Update investment field to refer to investment option below
                  if (investmentField) {
                    investmentField.value = "Refer to Investment option below";
                  }
                } else {
                  // Clear the investment field if MDA is unchecked
                  if (
                    investmentField &&
                    investmentField.value === "Refer to Investment option below"
                  ) {
                    investmentField.value = "";
                  }
                }
                triggerAutoSave();
              });
              console.log("Initialized MDA toggle for:", toggle.id);
            }
          });

          console.log("Product features initialization complete");
        }

        // Function to update investment options based on product selection
        function updateInvestmentOptions(productId) {
          const productNameInput = document.getElementById(`${productId}_name`);
          const investmentSelect = document.getElementById(
            `${productId}_investment_option`,
          );

          if (!productNameInput || !investmentSelect) return;

          const productName = productNameInput.value;
          investmentSelect.innerHTML =
            '<option value="">Select investment option</option>';

          // Add options based on product
          if (productName.includes("BT Panorama")) {
            // BT Panorama - only Active Unlisted options
            const btRiskProfiles = [
              "Defensive",
              "Moderate",
              "Balanced",
              "Growth",
              "High Growth",
              "Growth Plus",
              "Custom",
            ];
            btRiskProfiles.forEach((profile) => {
              investmentSelect.innerHTML += `<option value="Active Unlisted ${profile}">Active Unlisted - ${profile}</option>`;
            });
          } else if (
            productName.includes("Centric Super Choice") ||
            productName === "Centric IDPS"
          ) {
            // Centric Choice and IDPS options
            const types = [
              "Passive",
              "Active Unlisted",
              "Active DNR HC",
              "Active DNR SRI",
              "Semi Active DNR HC",
              "Semi Active DNR SRI",
            ];
            const centricRiskProfiles = [
              "Defensive",
              "Moderate",
              "Balanced",
              "Growth",
              "High Growth",
              "Growth Plus",
            ];

            types.forEach((type) => {
              centricRiskProfiles.forEach((profile) => {
                investmentSelect.innerHTML += `<option value="${type} ${profile}">${type} - ${profile}</option>`;
              });
            });
          }

          // Add event listener to update investment field when option is selected
          investmentSelect.addEventListener("change", function () {
            const investmentField = document.getElementById(
              `${productId}_investment`,
            );
            const mdaCheckbox = document.getElementById(`${productId}_mda`);
            if (investmentField && mdaCheckbox && mdaCheckbox.checked) {
              investmentField.value = "Refer to Investment option below";
            }
            triggerAutoSave();
          });
        }

        // Update fees based on entity selections
        function updateDynamicFees() {
          const container = document.getElementById("dynamicFeesContainer");
          container.innerHTML = "";

          let feesHTML = '<div class="grid-2">';

          if (entitySMSFCheckbox.checked) {
            feesHTML += `
                <div class="form-group">
                    <label for="smsfFees">SMSF fees:</label>
                    <input type="text" id="smsfFees" name="smsfFees" placeholder="Enter SMSF fees">
                </div>
            `;
          }

          if (entityTrustCheckbox.checked) {
            feesHTML += `
                <div class="form-group">
                    <label for="trustFees">Trust fees:</label>
                    <input type="text" id="trustFees" name="trustFees" placeholder="Enter Trust fees">
                </div>
            `;
          }

          if (entityCompanyCheckbox.checked) {
            feesHTML += `
                <div class="form-group">
                    <label for="companyFees">Company fees:</label>
                    <input type="text" id="companyFees" name="companyFees" placeholder="Enter Company fees">
                </div>
            `;
          }

          feesHTML += "</div>";

          if (
            entitySMSFCheckbox.checked ||
            entityTrustCheckbox.checked ||
            entityCompanyCheckbox.checked
          ) {
            container.innerHTML = feesHTML;
            setupAutoSaveForNewElements();
          }
        }

        // Update compliance requirements based on client status
        function updateComplianceRequirements() {
          const container = document.getElementById("complianceRequirements");
          container.innerHTML = "";

          if (newClientRadio.checked) {
            // New client requirements
            const newClientHTML = `
                <div class="form-group">
                    <div class="checklist-item">
                        <input type="checkbox" id="clientIdUploaded" name="compliance" value="ClientID">
                        <label for="clientIdUploaded">Upload copy of ID to XPLAN</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="amlCompletion" name="compliance" value="AML">
                        <label for="amlCompletion">AML to be completed per entity/individual save to XPLAN</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="taskXGreenID" name="compliance" value="GreenID">
                        <label for="taskXGreenID">TaskX - Green ID to be completed</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="initialFN" name="compliance" value="InitialFN">
                        <label for="initialFN">Initial FN</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="riskProfilingEvidence" name="riskProfiling" value="Evidence">
                        <label for="riskProfilingEvidence">Evidence of Risk profiling outcome in filenote</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="clientFFQ" name="compliance" value="ClientFFQ">
                        <label for="clientFFQ">Completed FFQ to XPLAN</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="scopeOfAdvice" name="compliance" value="ScopeOfAdvice">
                        <label for="scopeOfAdvice">Scope of Advice to XPLAN</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="finametricaSigned" name="compliance" value="FinametricaDoc">
                        <label for="finametricaSigned">Signed Finametrica Document to be uploaded to XPLAN</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="finametricaReport" name="compliance" value="FinametricaReport">
                        <label for="finametricaReport">Finametrica Report to be uploaded to XPLAN</label>
                    </div>
                    
                    <div class="checklist-item" id="superResearchItem">
                        <input type="checkbox" id="superResearch" name="compliance" value="SuperResearch">
                        <label for="superResearch">Super research confirmation</label>
                        <button type="button" class="btn btn-secondary btn-sm na-button" id="superResearchNABtn">N/A</button>
                    </div>
                    
                    <div class="checklist-item" id="contributionHistoryItem" style="display: none; margin-left: 30px;">
                        <input type="checkbox" id="contributionHistory" name="compliance" value="ContributionHistory">
                        <label for="contributionHistory">Contribution history obtained</label>
                        <button type="button" class="btn btn-secondary btn-sm na-button" id="contributionHistoryNABtn">N/A</button>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="taskXNewAdvice" name="compliance" value="TaskXNewAdvice">
                        <label for="taskXNewAdvice">TaskX - New Advice Request</label>
                    </div>
                </div>
            `;
            container.innerHTML = newClientHTML;
          } else if (existingClientRadio.checked) {
            // Existing client requirements
            const existingClientHTML = `
                <div class="form-group">
                    <div class="checklist-item">
                        <input type="checkbox" id="strategicFN" name="compliance" value="StrategicFN">
                        <label for="strategicFN">Strategic FN / Other relevant FN</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="riskProfilingEvidence" name="riskProfiling" value="Evidence">
                        <label for="riskProfilingEvidence">Evidence of Risk profiling outcome in filenote</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="uploadPricingCalc" name="compliance" value="UploadPricing">
                        <label for="uploadPricingCalc">Upload Pricing Calculator</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="workingsResearch" name="compliance" value="WorkingsResearch">
                        <label for="workingsResearch">Workings / Research etc to be uploaded</label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="submitJira" name="compliance" value="SubmitJira">
                        <label for="submitJira">Submit JIRA for pricing/or PCR (if applicable)</label>
                    </div>
                    
                    <div class="checklist-item" id="superResearchItem">
                        <input type="checkbox" id="superResearch" name="compliance" value="SuperResearch">
                        <label for="superResearch">Super research confirmation</label>
                        <button type="button" class="btn btn-secondary btn-sm na-button" id="superResearchNABtn">N/A</button>
                    </div>
                    
                    <div class="checklist-item" id="contributionHistoryItem" style="display: none; margin-left: 30px;">
                        <input type="checkbox" id="contributionHistory" name="compliance" value="ContributionHistory">
                        <label for="contributionHistory">Contribution history obtained</label>
                        <button type="button" class="btn btn-secondary btn-sm na-button" id="contributionHistoryNABtn">N/A</button>
                    </div>
                </div>
            `;
            container.innerHTML = existingClientHTML;
          }

          // Add SMSF specific items if SMSF is selected
          if (entitySMSFCheckbox.checked) {
            const smsfHTML = `
                <div class="form-group">
                    <div class="checklist-item">
                        <input type="checkbox" id="smsfDocs" name="compliance" value="SMSFDocs">
                        <label for="smsfDocs">SMSF trust deed, financials, investment strategy, costs</label>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML("beforeend", smsfHTML);
          }

          // Add event listener for super research checkbox and N/A buttons
          setTimeout(() => {
            const superResearchCheckbox =
              document.getElementById("superResearch");
            const contributionHistoryItem = document.getElementById(
              "contributionHistoryItem",
            );
            const superResearchNABtn =
              document.getElementById("superResearchNABtn");
            const contributionHistoryNABtn = document.getElementById(
              "contributionHistoryNABtn",
            );
            const superResearchItem =
              document.getElementById("superResearchItem");

            if (superResearchCheckbox && contributionHistoryItem) {
              superResearchCheckbox.addEventListener("change", function () {
                if (this.checked) {
                  contributionHistoryItem.style.display = "block";
                  // Remove N/A state when manually checking
                  if (superResearchItem) {
                    superResearchItem.classList.remove("na-active");
                  }
                } else {
                  contributionHistoryItem.style.display = "none";
                  document.getElementById("contributionHistory").checked =
                    false;
                  // Also remove N/A state from contribution history
                  contributionHistoryItem.classList.remove("na-active");
                }
                triggerAutoSave();
              });
            }

            setupAutoSaveForNewElements();
          }, 100);
        }

        // Function to update form based on selected client types
        function updateFormBasedOnSelections() {
          // Update partner-related fields based on couple selection
          partnerNameGroup.style.display = coupleClientCheckbox.checked
            ? "block"
            : "none";

          // Update entity name fields based on entity selections
          if (entityClientCheckbox.checked) {
            // Show specific entity name fields based on what's selected
            smsfNameGroup.style.display = entitySMSFCheckbox.checked
              ? "block"
              : "none";
            trustNameGroup.style.display = entityTrustCheckbox.checked
              ? "block"
              : "none";
            companyNameGroup.style.display = entityCompanyCheckbox.checked
              ? "block"
              : "none";

            // Hide generic entity name field since we have specific ones now
            entityNameGroup.style.display = "none";
          } else {
            // Hide all entity name fields when entity is not selected
            entityNameGroup.style.display = "none";
            smsfNameGroup.style.display = "none";
            trustNameGroup.style.display = "none";
            companyNameGroup.style.display = "none";
          }

          // Update recommendation sections
          updateRecommendationSections();

          // Update dynamic fees
          updateDynamicFees();

          // Update compliance requirements
          updateComplianceRequirements();
        }

        // Add event listeners for client name changes
        document
          .getElementById("clientName")
          .addEventListener("input", function () {
            updateRecommendationSections();
            triggerAutoSave();
          });
        document
          .getElementById("partnerName")
          .addEventListener("input", function () {
            updateRecommendationSections();
            triggerAutoSave();
          });
        document
          .getElementById("entityName")
          .addEventListener("input", function () {
            updateRecommendationSections();
            triggerAutoSave();
          });

        // Add event listeners for specific entity name changes
        document
          .getElementById("smsfName")
          .addEventListener("input", function () {
            updateRecommendationSections();
            triggerAutoSave();
          });
        document
          .getElementById("trustName")
          .addEventListener("input", function () {
            updateRecommendationSections();
            triggerAutoSave();
          });
        document
          .getElementById("companyName")
          .addEventListener("input", function () {
            updateRecommendationSections();
            triggerAutoSave();
          });

        // Add event listeners for entity type checkboxes
        entitySMSFCheckbox.addEventListener("change", function () {
          updateFormBasedOnSelections();
        });
        entityTrustCheckbox.addEventListener("change", function () {
          updateFormBasedOnSelections();
        });
        entityCompanyCheckbox.addEventListener("change", function () {
          updateFormBasedOnSelections();
        });

        // Add event listeners for client status radio buttons
        newClientRadio.addEventListener("change", function () {
          updateComplianceRequirements();
          triggerAutoSave();
        });
        existingClientRadio.addEventListener("change", function () {
          updateComplianceRequirements();
          triggerAutoSave();
        });

        // Handle Flowchart Toggle
        flowchartRequiredToggle.addEventListener("change", function () {
          flowchartStatus.textContent = this.checked ? "Yes" : "No";
          triggerAutoSave();
        });

        // Handle Projection Length Dropdown
        projectionDateLength.addEventListener("change", function () {
          const otherProjectionLength = document.getElementById(
            "otherProjectionLength",
          );
          const customProjectionInstructions = document.getElementById(
            "customProjectionInstructions",
          );
          const projectionOptionsGroup = document.getElementById(
            "projectionOptionsGroup",
          );

          if (this.value === "other") {
            otherProjectionLength.style.display = "block";
          } else {
            otherProjectionLength.style.display = "none";
          }

          if (this.value === "noProjections") {
            // Hide projection options and custom instructions if no projections needed
            projectionOptionsGroup.style.display = "none";
            customProjectionInstructions.style.display = "none";
          } else {
            // Show projection options and custom instructions for all other selections
            projectionOptionsGroup.style.display = "block";
            customProjectionInstructions.style.display = "block";
          }

          triggerAutoSave();
        });

        // Handle paraplanner compare checkbox
        paraplannerCompareCheckbox.addEventListener("change", function () {
          if (this.checked) {
            alternativePlatformsTextarea.value =
              "Paraplanner to complete compare\n" +
              alternativePlatformsTextarea.value;
          } else {
            alternativePlatformsTextarea.value =
              alternativePlatformsTextarea.value.replace(
                "Paraplanner to complete compare\n",
                "",
              );
          }
          triggerAutoSave();
        });

        // Handle TMD in filenote checkbox
        tmdInFilenoteCheckbox.addEventListener("change", function () {
          if (this.checked) {
            tmdDetailsTextarea.value =
              "TMD in filenote\n" + tmdDetailsTextarea.value;
          } else {
            tmdDetailsTextarea.value = tmdDetailsTextarea.value.replace(
              "TMD in filenote\n",
              "",
            );
          }
          triggerAutoSave();
        });

        // Handle ongoing fee refer checkbox - UPDATED LOGIC
        ongoingFeeReferCheckbox.addEventListener("change", function () {
          if (this.checked) {
            ongoingFeeInput.value = "Refer to Pricing Calculator";
            ongoingPcmFeeInput.value = "Refer to Pricing Calculator";
          } else {
            // Clear the fields when unchecked
            ongoingFeeInput.value = "";
            ongoingPcmFeeInput.value = "";
          }
          triggerAutoSave();
        });

        // Handle MDA N/A button
        function setupMDANAButton() {
          const mdaNAButton = document.getElementById("mdaNABtn");
          const mdaTextarea = document.getElementById("mdaDetails");

          if (
            mdaNAButton &&
            mdaTextarea &&
            !mdaNAButton.hasAttribute("data-initialized")
          ) {
            mdaNAButton.setAttribute("data-initialized", "true");
            mdaNAButton.addEventListener("click", function () {
              if (mdaTextarea.classList.contains("strikethrough")) {
                mdaTextarea.value = mdaTextarea.value
                  .replace("N/A\n", "")
                  .replace("N/A", "");
                mdaTextarea.classList.remove("strikethrough");
              } else {
                if (!mdaTextarea.value.includes("N/A")) {
                  mdaTextarea.value = "N/A\n" + mdaTextarea.value;
                }
                mdaTextarea.classList.add("strikethrough");
              }
              triggerAutoSave();
            });
          }
        }

        // N/A buttons setup function
        function setupNAButtons() {
          console.log("=== SETTING UP N/A BUTTONS ===");

          // Handle Pricing Calculator N/A button - STATIC SECTION
          const pricingCalculatorNABtn = document.getElementById(
            "pricingCalculatorNABtn",
          );
          const pricingCalculatorItem = document.getElementById(
            "pricingCalculatorItem",
          );
          const pricingCalculatorCheckbox =
            document.getElementById("pricingCalculator");

          if (
            pricingCalculatorNABtn &&
            pricingCalculatorItem &&
            pricingCalculatorCheckbox
          ) {
            console.log("Found Pricing Calculator N/A elements - setting up");

            // Remove any existing listeners
            const newPricingBtn = pricingCalculatorNABtn.cloneNode(true);
            pricingCalculatorNABtn.parentNode.replaceChild(
              newPricingBtn,
              pricingCalculatorNABtn,
            );

            newPricingBtn.addEventListener("click", function () {
              console.log("Pricing Calculator N/A clicked!");
              pricingCalculatorItem.classList.toggle("na-active");

              if (pricingCalculatorItem.classList.contains("na-active")) {
                pricingCalculatorCheckbox.checked = false;
                console.log(
                  "Pricing Calculator set to N/A - checkbox unchecked and made transparent",
                );
              } else {
                console.log(
                  "Pricing Calculator N/A removed - item restored to normal",
                );
              }
              triggerAutoSave();
            });

            // Remove N/A state if checkbox is manually clicked
            pricingCalculatorCheckbox.addEventListener("change", function () {
              if (
                this.checked &&
                pricingCalculatorItem.classList.contains("na-active")
              ) {
                pricingCalculatorItem.classList.remove("na-active");
                console.log(
                  "Pricing Calculator manually checked - N/A state removed",
                );
              }
            });
          } else {
            console.log(
              "ERROR: Could not find Pricing Calculator N/A elements",
            );
          }

          // Handle Beneficiary Nomination N/A button - STATIC SECTION
          const beneficiaryNominationNABtn = document.getElementById(
            "beneficiaryNominationNABtn",
          );
          const beneficiaryNominationItem = document.getElementById(
            "beneficiaryNominationItem",
          );
          const beneficiaryNominationCheckbox = document.getElementById(
            "beneficiaryNomination",
          );

          if (
            beneficiaryNominationNABtn &&
            beneficiaryNominationItem &&
            beneficiaryNominationCheckbox
          ) {
            console.log(
              "Found Beneficiary Nomination N/A elements - setting up",
            );

            // Remove any existing listeners
            const newBeneficiaryBtn =
              beneficiaryNominationNABtn.cloneNode(true);
            beneficiaryNominationNABtn.parentNode.replaceChild(
              newBeneficiaryBtn,
              beneficiaryNominationNABtn,
            );

            newBeneficiaryBtn.addEventListener("click", function () {
              console.log("Beneficiary Nomination N/A clicked!");
              beneficiaryNominationItem.classList.toggle("na-active");

              if (beneficiaryNominationItem.classList.contains("na-active")) {
                beneficiaryNominationCheckbox.checked = false;
                console.log(
                  "Beneficiary Nomination set to N/A - checkbox unchecked and made transparent",
                );
              } else {
                console.log(
                  "Beneficiary Nomination N/A removed - item restored to normal",
                );
              }
              triggerAutoSave();
            });

            // Remove N/A state if checkbox is manually clicked
            beneficiaryNominationCheckbox.addEventListener(
              "change",
              function () {
                if (
                  this.checked &&
                  beneficiaryNominationItem.classList.contains("na-active")
                ) {
                  beneficiaryNominationItem.classList.remove("na-active");
                  console.log(
                    "Beneficiary Nomination manually checked - N/A state removed",
                  );
                }
              },
            );
          } else {
            console.log(
              "ERROR: Could not find Beneficiary Nomination N/A elements",
            );
          }

          console.log("=== N/A BUTTONS SETUP COMPLETE ===");
        }

        // Draft Functionality
        function initializeDraftFunctionality() {
          loadDraftList();

          // Save draft modal functionality
          saveBtn.addEventListener("click", function () {
            const clientName =
              document.getElementById("clientName").value || "Unnamed Client";
            draftNameInput.value = `${clientName} ARF`;
            saveDraftModal.style.display = "block";
          });

          confirmSaveDraftBtn.addEventListener("click", function () {
            const draftName = draftNameInput.value.trim();
            if (draftName) {
              saveDraft(draftName);
              saveDraftModal.style.display = "none";
              showAutoSaveIndicator("Draft saved successfully!");
            } else {
              alert("Please enter a draft name.");
            }
          });

          cancelSaveDraftBtn.addEventListener("click", function () {
            saveDraftModal.style.display = "none";
          });

          closeModal.addEventListener("click", function () {
            saveDraftModal.style.display = "none";
          });

          window.addEventListener("click", function (event) {
            if (event.target === saveDraftModal) {
              saveDraftModal.style.display = "none";
            }
          });

          // Load draft functionality
          loadDraftBtn.addEventListener("click", function () {
            const selectedDraft = draftSelector.value;
            if (selectedDraft) {
              loadDraft(selectedDraft);
            } else {
              alert("Please select a draft to load.");
            }
          });

          // Delete draft functionality
          deleteDraftBtn.addEventListener("click", function () {
            const selectedDraft = draftSelector.value;
            if (selectedDraft) {
              if (
                confirm(
                  `Are you sure you want to delete the draft "${selectedDraft}"?`,
                )
              ) {
                deleteDraft(selectedDraft);
              }
            } else {
              alert("Please select a draft to delete.");
            }
          });
        }

        function loadDraftList() {
          const drafts = JSON.parse(
            localStorage.getItem("financialAdviceFormDrafts") || "{}",
          );
          draftSelector.innerHTML =
            '<option value="">Select a saved draft...</option>';

          Object.keys(drafts).forEach((draftName) => {
            const option = document.createElement("option");
            option.value = draftName;
            option.textContent = draftName;
            draftSelector.appendChild(option);
          });
        }

        // FIXED COMPREHENSIVE SAVE FUNCTION - Now properly saves tranching text
        function saveDraft(draftName, isAutoSave = false) {
          console.log("=== FIXED COMPREHENSIVE SAVE STARTING ===");

          const formData = {};

          // STEP 1: Save ALL form inputs without exception
          const allInputs = document.querySelectorAll("input, textarea, select");
          console.log("Total form elements found:", allInputs.length);

          allInputs.forEach((element) => {
            if (element.id && element.id.trim() !== "") {
              if (element.type === "checkbox" || element.type === "radio") {
                formData[element.id] = element.checked;
              } else {
                formData[element.id] = element.value || "";
              }
            }
          });

          // STEP 1.5: FORCE SAVE ALL TRANCHING TEXT FIELDS SPECIFICALLY
          console.log("=== FORCE SAVING TRANCHING TEXT ===");
          document.querySelectorAll('[id$="_tranching_text"]').forEach((textarea) => {
            if (textarea.id) {
              formData[textarea.id] = textarea.value || "";
              console.log(`FORCE SAVED TRANCHING TEXT ${textarea.id} = "${textarea.value}"`);
              
              // Also save a backup
              formData[textarea.id + "_BACKUP"] = textarea.value || "";
            }
          });

          // STEP 2: FORCE SAVE all other product-related data with specific patterns
          console.log("=== SAVING PRODUCT DATA ===");
          
          // Save ALL product names, investments, custom products, etc.
          document.querySelectorAll('[id*="_name"], [id*="_investment"], [id*="_custom"], [id*="_cash"]').forEach((element) => {
            if (element.id && !element.id.includes("_tranching_text")) { // Skip tranching text as we handled it above
              formData[element.id] = element.value || "";
              if (element.id.includes("_custom")) {
                console.log(`SAVED ${element.id} = "${element.value}"`);
              }
            }
          });

          // Save ALL MDA selections specifically
          document.querySelectorAll('[id*="_investment_option"]').forEach((select) => {
            if (select.id) {
              formData[select.id] = select.value || "";
              console.log(`SAVED MDA OPTION ${select.id} = "${select.value}"`);
            }
          });

          // STEP 2.5: SAVE PRODUCT COUNTS for each client type - CRITICAL FOR RECONSTRUCTION
          ['client1', 'client2', 'joint', 'smsf', 'trust', 'company', 'dependants'].forEach(clientId => {
            const container = document.getElementById(`${clientId}_products`);
            if (container) {
              const productCount = container.querySelectorAll(".product-item").length;
              formData[`${clientId}_product_count`] = productCount;
              console.log(`SAVED ${clientId} product count: ${productCount}`);
            }
          });

          // STEP 3: Save ALL toggle states and status spans
          document.querySelectorAll('[id$="_mda"], [id$="_tranching"]').forEach((toggle) => {
            if (toggle.id) {
              formData[toggle.id] = toggle.checked;
              
              // Also save the status span text
              const statusId = toggle.id + "_status";
              const statusSpan = document.getElementById(statusId);
              if (statusSpan) {
                formData[statusId + "_text"] = statusSpan.textContent;
              }
              
              console.log(`SAVED TOGGLE ${toggle.id} = ${toggle.checked}`);
            }
          });

          // STEP 4: Save ALL visibility states for sections
          const sectionsToSave = [
            '_mda_section',
            '_tranching_details', 
            '_custom_group',
            '_investment_options',
            'ProductRecommendationsSection'
          ];

          sectionsToSave.forEach(pattern => {
            document.querySelectorAll(`[id*="${pattern}"]`).forEach((section) => {
              if (section.id) {
                const isVisible = section.style.display !== "none" && section.style.display !== "";
                formData[section.id + "_visible"] = isVisible;
                console.log(`SAVED VISIBILITY ${section.id} = ${isVisible}`);
              }
            });
          });

          // STEP 5: Save client type states for rebuilding dynamic content
          formData["_clientTypes"] = {
            single: singleClientCheckbox.checked,
            couple: coupleClientCheckbox.checked,
            dependants: dependantsClientCheckbox.checked,
            entity: entityClientCheckbox.checked,
            smsf: entitySMSFCheckbox.checked,
            trust: entityTrustCheckbox.checked,
            company: entityCompanyCheckbox.checked,
          };

          formData["_clientStatus"] = {
            new: newClientRadio.checked,
            existing: existingClientRadio.checked,
          };

          // STEP 6: Save N/A states
          document.querySelectorAll(".checklist-item.na-active").forEach((item) => {
            const checkbox = item.querySelector('input[type="checkbox"]');
            if (checkbox && checkbox.id) {
              formData[checkbox.id + "_na_active"] = true;
            }
          });

          // Save MDA N/A state
          const mdaTextarea = document.getElementById("mdaDetails");
          if (mdaTextarea && mdaTextarea.classList.contains("strikethrough")) {
            formData["mdaDetails_na_active"] = true;
          }

          // STEP 7: Count what we're saving for verification
          const productFields = Object.keys(formData).filter(key => 
            key.includes("_name") || key.includes("_investment") || 
            key.includes("_custom") || key.includes("_mda") || 
            key.includes("_tranching")
          );
          
          const tranchingTextFields = Object.keys(formData).filter(key => 
            key.includes("_tranching_text") && !key.includes("_BACKUP")
          );
          
          console.log(`=== SAVE SUMMARY ===`);
          console.log(`Total fields saved: ${Object.keys(formData).length}`);
          console.log(`Product-related fields: ${productFields.length}`);
          console.log(`MDA options: ${Object.keys(formData).filter(k => k.includes("_investment_option")).length}`);
          console.log(`Custom products: ${Object.keys(formData).filter(k => k.includes("_custom") && !k.includes("_group")).length}`);
          console.log(`Tranching fields: ${Object.keys(formData).filter(k => k.includes("_tranching")).length}`);
          console.log(`Tranching TEXT fields: ${tranchingTextFields.length}`);
          console.log(`Product counts: ${Object.keys(formData).filter(k => k.includes("_product_count")).length}`);

          // Log all tranching text values for debugging
          tranchingTextFields.forEach(key => {
            console.log(`TRANCHING TEXT: ${key} = "${formData[key]}"`);
          });

          // STEP 8: Save to localStorage
          const drafts = JSON.parse(localStorage.getItem("financialAdviceFormDrafts") || "{}");
          drafts[draftName] = {
            data: formData,
            timestamp: new Date().toISOString(),
          };
          localStorage.setItem("financialAdviceFormDrafts", JSON.stringify(drafts));

          if (!isAutoSave) {
            loadDraftList();
          }

          console.log("=== COMPREHENSIVE SAVE COMPLETE ===");
        }

        // FIXED COMPREHENSIVE LOAD FUNCTION - Now reconstructs all added products
        function loadDraft(draftName) {
          const drafts = JSON.parse(localStorage.getItem("financialAdviceFormDrafts") || "{}");
          if (!drafts[draftName]) return;

          const formData = drafts[draftName].data;
          console.log("=== FIXED COMPREHENSIVE LOAD STARTING ===");
          console.log(`Loading ${Object.keys(formData).length} fields total`);

          // PHASE 1: Restore basic form state first to trigger rebuilds
          console.log("PHASE 1: Basic form restoration");
          Object.keys(formData).forEach((key) => {
            if (!key.startsWith("_") && !key.endsWith("_visible") && !key.endsWith("_text") && !key.endsWith("_na_active") && !key.endsWith("_product_count")) {
              const element = document.getElementById(key);
              if (element) {
                if (element.type === "checkbox" || element.type === "radio") {
                  element.checked = formData[key];
                  
                  // Update visual states for checkboxes
                  if (element.type === "checkbox") {
                    const item = element.closest(".checkbox-item");
                    if (item) {
                      item.classList.toggle("selected", element.checked);
                    }
                  }
                } else {
                  element.value = formData[key] || "";
                }
              }
            }
          });

          // Trigger form rebuild based on client selections
          updateFormBasedOnSelections();

          // PHASE 2: Wait for rebuild, then restore ALL dynamic content
          setTimeout(() => {
            console.log("PHASE 2: Dynamic content restoration");

            // PHASE 2.5: RECREATE ALL ADDITIONAL PRODUCTS FIRST
            console.log("PHASE 2.5: Recreating additional products");
            
            ['client1', 'client2', 'joint', 'smsf', 'trust', 'company', 'dependants'].forEach(clientId => {
              const savedCount = formData[`${clientId}_product_count`];
              const container = document.getElementById(`${clientId}_products`);
              
              if (savedCount && container && savedCount > 1) {
                console.log(`Recreating ${savedCount - 1} additional products for ${clientId}`);
                
                // Get client name for the function
                let clientName = clientId;
                if (clientId === 'client1') clientName = formData['clientName'] || 'Client 1';
                else if (clientId === 'client2') clientName = formData['partnerName'] || 'Client 2'; 
                else if (clientId === 'smsf') clientName = formData['smsfName'] || 'SMSF';
                else if (clientId === 'trust') clientName = formData['trustName'] || 'Trust';
                else if (clientId === 'company') clientName = formData['companyName'] || 'Company';
                else if (clientId === 'dependants') clientName = 'Dependants';
                else if (clientId === 'joint') clientName = 'Joint';
                
                // Add the additional products (savedCount - 1 because first one already exists)
                for (let i = 1; i < savedCount; i++) {
                  const newProductHTML = createProductRecommendation(clientId, clientName, i);
                  container.insertAdjacentHTML("beforeend", newProductHTML);
                  console.log(`Added product ${i} for ${clientId}`);
                }
              }
            });

            // Restore ALL form fields again (including newly created dynamic elements)
            Object.keys(formData).forEach((key) => {
              if (!key.startsWith("_") && !key.endsWith("_visible") && !key.endsWith("_text") && !key.endsWith("_na_active") && !key.endsWith("_product_count")) {
                const element = document.getElementById(key);
                if (element) {
                  if (element.type === "checkbox" || element.type === "radio") {
                    element.checked = formData[key];
                  } else {
                    element.value = formData[key] || "";
                  }
                  
                  // Special handling for product name changes
                  if (key.endsWith("_name") && element.value) {
                    console.log(`Triggering product selection for ${key} = ${element.value}`);
                    // FIXED: Don't trigger dropdown during load - just trigger the onChange logic
                    const productId = key.replace("_name", "");
                    const selectedProduct = element.value;
                    
                    // Manually trigger the product selection logic without showing dropdown
                    const customGroup = document.getElementById(`${productId}_custom_group`);
                    const mdaSection = document.getElementById(`${productId}_mda_section`);
                    
                    if (selectedProduct === "Custom") {
                      if (customGroup) customGroup.style.display = "block";
                      if (mdaSection) mdaSection.style.display = "none";
                    } else {
                      if (customGroup) customGroup.style.display = "none";
                      
                      // Show MDA section for applicable products
                      if (
                        selectedProduct.includes("BT Panorama") ||
                        selectedProduct.includes("Centric Super Choice") ||
                        selectedProduct === "Centric IDPS"
                      ) {
                        if (mdaSection) mdaSection.style.display = "block";
                      } else {
                        if (mdaSection) mdaSection.style.display = "none";
                      }
                    }
                  }
                }
              }
            });

            // Initialize all product features to set up event handlers
            initializeProductFeatures();
            setupProductRecommendationToggles();

            // PHASE 3: Restore toggles and their dependent sections
            setTimeout(() => {
              console.log("PHASE 3: Toggle and section restoration");

              // Restore product recommendation checkboxes and show their sections
              Object.keys(formData).forEach((key) => {
                if (key.endsWith("ProductRecsCheckbox") && formData[key]) {
                  const checkbox = document.getElementById(key);
                  if (checkbox) {
                    checkbox.checked = true;
                    
                    // Show the corresponding product section
                    const sectionMap = {
                      client1ProductRecsCheckbox: "client1ProductRecommendationsSection",
                      client2ProductRecsCheckbox: "client2ProductRecommendationsSection", 
                      jointProductRecsCheckbox: "jointProductRecommendationsSection",
                      smsfProductRecsCheckbox: "smsfProductRecommendationsSection",
                      trustProductRecsCheckbox: "trustProductRecommendationsSection",
                      companyProductRecsCheckbox: "companyProductRecommendationsSection",
                      dependantsProductRecsCheckbox: "dependantsProductRecommendationsSection"
                    };
                    
                    const sectionId = sectionMap[key];
                    const section = document.getElementById(sectionId);
                    if (section) {
                      section.style.display = "block";
                      console.log(`Showed product section: ${sectionId}`);
                    }
                  }
                }

                // Restore MDA toggles and their sections
                if (key.endsWith("_mda") && formData[key]) {
                  const toggle = document.getElementById(key);
                  if (toggle) {
                    toggle.checked = true;
                    
                    const productId = key.replace("_mda", "");
                    const status = document.getElementById(`${productId}_mda_status`);
                    const investmentOptions = document.getElementById(`${productId}_investment_options`);
                    
                    if (status) status.textContent = "Yes";
                    if (investmentOptions) {
                      investmentOptions.style.display = "block";
                      
                      // Populate and restore investment options
                      updateInvestmentOptions(productId);
                      
                      // Restore selected investment option
                      const optionKey = `${productId}_investment_option`;
                      if (formData[optionKey]) {
                        setTimeout(() => {
                          const select = document.getElementById(optionKey);
                          if (select) {
                            select.value = formData[optionKey];
                            console.log(`Restored MDA option: ${optionKey} = ${formData[optionKey]}`);
                          }
                        }, 100);
                      }
                    }
                    
                    console.log(`Restored MDA toggle: ${key}`);
                  }
                }

                // Restore tranching toggles and their sections
                if (key.endsWith("_tranching") && formData[key]) {
                  const toggle = document.getElementById(key);
                  if (toggle) {
                    toggle.checked = true;
                    
                    const productId = key.replace("_tranching", "");
                    const status = document.getElementById(`${productId}_tranching_status`);
                    const details = document.getElementById(`${productId}_tranching_details`);
                    
                    if (status) status.textContent = "Yes";
                    if (details) {
                      details.style.display = "block";
                      console.log(`Showed tranching details: ${productId}`);
                      
                      // IMMEDIATELY restore the tranching text for this product
                      const tranchingTextKey = `${productId}_tranching_text`;
                      if (formData[tranchingTextKey]) {
                        const tranchingTextarea = document.getElementById(tranchingTextKey);
                        if (tranchingTextarea) {
                          tranchingTextarea.value = formData[tranchingTextKey];
                          console.log(`IMMEDIATELY restored tranching text for ${productId}: "${formData[tranchingTextKey]}"`);
                        }
                      }
                    }
                  }
                }
              });

                // PHASE 3.5: FORCE RESTORE ALL TRANCHING TEXT FIELDS
                console.log("PHASE 3.5: Force restoring tranching text");
                
                Object.keys(formData).forEach((key) => {
                  if (key.endsWith("_tranching_text")) {
                    let textValue = formData[key];
                    
                    // Try backup if main value is empty
                    if (!textValue && formData[key + "_BACKUP"]) {
                      textValue = formData[key + "_BACKUP"];
                      console.log(`Using backup value for ${key}`);
                    }
                    
                    const element = document.getElementById(key);
                    if (element) {
                      element.value = textValue || "";
                      console.log(`FORCE RESTORED TRANCHING TEXT: ${key} = "${textValue}"`);
                    } else {
                      console.log(`WARNING: Could not find tranching text element: ${key}`);
                    }
                  }
                });

              // PHASE 4: Final restoration of all visibility states and special content
              setTimeout(() => {
                console.log("PHASE 4: Final visibility and content restoration");

                // Restore custom product group visibility
                Object.keys(formData).forEach((key) => {
                  if (key.endsWith("_visible") && formData[key]) {
                    const elementId = key.replace("_visible", "");
                    const element = document.getElementById(elementId);
                    if (element) {
                      element.style.display = "block";
                      if (elementId.includes("_custom_group")) {
                        console.log(`Restored custom group visibility: ${elementId}`);
                      }
                    }
                  }
                });

                // Restore status text for toggles
                Object.keys(formData).forEach((key) => {
                  if (key.endsWith("_text")) {
                    const statusId = key.replace("_text", "");
                    const statusElement = document.getElementById(statusId);
                    if (statusElement && formData[key]) {
                      statusElement.textContent = formData[key];
                    }
                  }
                });

                // Restore N/A states
                Object.keys(formData).forEach((key) => {
                  if (key.endsWith("_na_active") && formData[key]) {
                    const originalKey = key.replace("_na_active", "");
                    
                    if (originalKey === "mdaDetails") {
                      const mdaTextarea = document.getElementById("mdaDetails");
                      if (mdaTextarea) {
                        mdaTextarea.classList.add("strikethrough");
                        if (!mdaTextarea.value.includes("N/A")) {
                          mdaTextarea.value = "N/A\n" + mdaTextarea.value;
                        }
                      }
                    } else {
                      const element = document.getElementById(originalKey);
                      if (element) {
                        const item = element.closest(".checklist-item");
                        if (item) {
                          item.classList.add("na-active");
                          element.checked = false;
                        }
                      }
                    }
                  }
                });

                // PHASE 4.5: HIDE ALL DROPDOWNS after load is complete
                console.log("PHASE 4.5: Hiding all dropdowns");
                
                document.querySelectorAll('.dropdown-list').forEach(dropdown => {
                  dropdown.classList.remove('active');
                  console.log("Hidden dropdown during load");
                });

                // Final setup of auto-save and event listeners
                setupAutoSaveForNewElements();
                setupMDANAButton();

                console.log("=== COMPREHENSIVE LOAD COMPLETE ===");
                showAutoSaveIndicator("Draft loaded successfully!");
                
                // Verify what was loaded
                const loadedProducts = document.querySelectorAll('[id*="_name"]').length;
                const loadedMDA = document.querySelectorAll('[id*="_mda"]:checked').length;
                const loadedTranching = document.querySelectorAll('[id*="_tranching"]:checked').length;
                console.log(`Verification - Products: ${loadedProducts}, MDA toggles: ${loadedMDA}, Tranching: ${loadedTranching}`);
                
              }, 200); // Phase 4
            }, 300); // Phase 3  
          }, 500); // Phase 2
        }

        function deleteDraft(draftName) {
          const drafts = JSON.parse(
            localStorage.getItem("financialAdviceFormDrafts") || "{}",
          );
          delete drafts[draftName];
          localStorage.setItem(
            "financialAdviceFormDrafts",
            JSON.stringify(drafts),
          );
          loadDraftList();
          draftSelector.value = "";
          showAutoSaveIndicator("Draft deleted successfully!");
        }

        // Check for shared data in URL
        function checkForSharedData() {
          const urlParams = new URLSearchParams(window.location.search);
          const sharedData = urlParams.get("shared");

          if (sharedData) {
            try {
              // Decode the shared data
              const decodedData = JSON.parse(
                atob(decodeURIComponent(sharedData)),
              );

              // Show notification about shared form
              const clientName = decodedData.clientName || "Unknown Client";
              showAutoSaveIndicator(`Loading shared form: ${clientName}`);

              // Populate the form with shared data
              setTimeout(() => {
                populateFormData(decodedData);

                // Clean URL after loading (optional)
                const cleanUrl =
                  window.location.protocol +
                  "//" +
                  window.location.host +
                  window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);

                showAutoSaveIndicator("Shared form loaded successfully!");
              }, 500);
            } catch (error) {
              console.error("Error loading shared data:", error);
              showAutoSaveIndicator("Error loading shared form data");
            }
          }
        }

        // Auto-save functionality
        function setupAutoSave() {
          // Add auto-save to all form elements
          document
            .querySelectorAll("input, textarea, select")
            .forEach((element) => {
              if (element.type === "checkbox" || element.type === "radio") {
                element.addEventListener("change", triggerAutoSave);
              } else {
                element.addEventListener("input", triggerAutoSave);
                element.addEventListener("change", triggerAutoSave);
              }
            });
        }

        function setupAutoSaveForNewElements() {
          // Setup auto-save for dynamically added elements
          setTimeout(() => {
            // Get all inputs, textareas, and selects that don't have the autosave marker
            const newElements = document.querySelectorAll(
              "input:not([data-autosave]), textarea:not([data-autosave]), select:not([data-autosave])",
            );

            newElements.forEach((element) => {
              element.setAttribute("data-autosave", "true");
              if (element.type === "checkbox" || element.type === "radio") {
                element.addEventListener("change", triggerAutoSave);
              } else {
                element.addEventListener("input", triggerAutoSave);
                element.addEventListener("change", triggerAutoSave);
              }
            });

            // Setup N/A buttons for dynamically created compliance items (like Super Research)
            const newNAButtons = document.querySelectorAll(
              ".na-button:not([data-initialized])",
            );
            newNAButtons.forEach((button) => {
              button.setAttribute("data-initialized", "true");
              button.addEventListener("click", function () {
                const item = this.closest(".checklist-item");
                if (item) {
                  item.classList.toggle("na-active");
                  const checkbox = item.querySelector('input[type="checkbox"]');
                  if (checkbox && item.classList.contains("na-active")) {
                    checkbox.checked = false;

                    // Special handling for super research
                    if (checkbox.id === "superResearch") {
                      const contributionHistoryItem = document.getElementById(
                        "contributionHistoryItem",
                      );
                      if (contributionHistoryItem) {
                        contributionHistoryItem.style.display = "none";
                        contributionHistoryItem.classList.remove("na-active");
                        const contributionCheckbox = document.getElementById(
                          "contributionHistory",
                        );
                        if (contributionCheckbox) {
                          contributionCheckbox.checked = false;
                        }
                      }
                    }
                  }
                  triggerAutoSave();
                }
              });
            });

            // Also setup static N/A buttons (Pricing Calculator, Beneficiary Nomination)
            setupNAButtons();

            console.log(
              "Setup auto-save for",
              newElements.length,
              "new elements and",
              newNAButtons.length,
              "new N/A buttons",
            );

            // Also re-setup MDA N/A button in case it needs refreshing
            setupMDANAButton();
          }, 100);
        }

        function triggerAutoSave() {
          clearTimeout(autoSaveTimeout);
          autoSaveTimeout = setTimeout(() => {
            const clientName =
              document.getElementById("clientName").value || "Auto-Save";
            saveDraft(`${clientName} - Auto Save`, true); // Pass true for silent auto-save
            // Completely silent - no notifications, no dropdown updates
          }, 2000); // Auto-save after 2 seconds of inactivity
        }

        function showAutoSaveIndicator(message = "Auto-saved") {
          autoSaveIndicator.textContent = message;
          autoSaveIndicator.classList.add("show");
          setTimeout(() => {
            autoSaveIndicator.classList.remove("show");
          }, 2000);
        }

        function collectFormData() {
          const formData = {};

          // HYPER FORCE - Wait longer and collect more aggressively
          const allInputs = document.querySelectorAll(
            "input, textarea, select",
          );

          allInputs.forEach((element) => {
            if (element.id) {
              // Only collect elements with IDs
              if (element.type === "checkbox" || element.type === "radio") {
                formData[element.id] = element.checked;
              } else {
                formData[element.id] = element.value;
              }
            }
          });

          // MEGA FORCE - Find ALL tranching-related elements with ultra-aggressive search
          console.log("MEGA FORCE SEARCH for tranching elements...");

          // Search for ALL possible tranching element patterns
          const tranchingPatterns = [
            'textarea[id*="_tranching_text"]',
            'input[id*="_tranching"]',
            'span[id*="_tranching_status"]',
            'div[id*="_tranching_details"]',
          ];

          tranchingPatterns.forEach((pattern) => {
            const elements = document.querySelectorAll(pattern);
            console.log(
              `Found ${elements.length} elements for pattern: ${pattern}`,
            );

            elements.forEach((element) => {
              if (element.id) {
                if (element.type === "checkbox") {
                  formData[element.id] = element.checked;
                  console.log(
                    "MEGA FORCE saved checkbox:",
                    element.id,
                    "=",
                    element.checked,
                  );
                } else if (
                  element.tagName === "TEXTAREA" ||
                  element.tagName === "INPUT"
                ) {
                  formData[element.id] = element.value;
                  console.log(
                    "MEGA FORCE saved input/textarea:",
                    element.id,
                    "=",
                    element.value,
                  );

                  // Special handling for tranching text - make EXTRA sure it's saved
                  if (element.id.includes("_tranching_text")) {
                    formData[element.id + "_BACKUP"] = element.value;
                    console.log(
                      "MEGA FORCE backup save:",
                      element.id + "_BACKUP",
                      "=",
                      element.value,
                    );
                  }
                } else if (element.tagName === "SPAN") {
                  formData[element.id + "_text"] = element.textContent;
                  console.log(
                    "MEGA FORCE saved span text:",
                    element.id,
                    "=",
                    element.textContent,
                  );
                } else if (element.tagName === "DIV") {
                  formData[element.id + "_visible"] =
                    element.style.display !== "none";
                  console.log(
                    "MEGA FORCE saved div visibility:",
                    element.id,
                    "=",
                    element.style.display !== "none",
                  );
                }
              }
            });
          });

          // EXPLICITLY save ALL entity recommendations and risk profiles
          ["smsf", "trust", "company"].forEach((entityType) => {
            const entityRec = document.getElementById(
              `${entityType}Recommendations`,
            );
            const entityRisk = document.getElementById(
              `riskProfile${entityType}`,
            );

            if (entityRec) {
              formData[`${entityType}Recommendations`] = entityRec.value;
              console.log(
                `Saving ${entityType} recommendations:`,
                entityRec.value,
              );
            }

            if (entityRisk) {
              formData[`riskProfile${entityType}`] = entityRisk.value;
              console.log(
                `Saving ${entityType} risk profile:`,
                entityRisk.value,
              );
            }
          });

          // EXPLICITLY save contribution history checkbox state and visibility
          const contributionHistory = document.getElementById(
            "contributionHistory",
          );
          const contributionHistoryItem = document.getElementById(
            "contributionHistoryItem",
          );
          if (contributionHistory) {
            formData["contributionHistory"] = contributionHistory.checked;
            // Check if the item exists AND is visible (not display:none)
            formData["contributionHistoryItem_visible"] = !!(
              contributionHistoryItem &&
              contributionHistoryItem.style.display === "block"
            );
            console.log(
              "Saving contribution history:",
              contributionHistory.checked,
              "visible:",
              formData["contributionHistoryItem_visible"],
            );
          }

          // EXPLICITLY save super research state to ensure contribution history shows properly
          const superResearch = document.getElementById("superResearch");
          if (superResearch) {
            formData["superResearch"] = superResearch.checked;
            console.log("Saving super research state:", superResearch.checked);
          }

          // Save toggle switch status spans (for MDA, tranching, etc.)
          document.querySelectorAll('[id$="_status"]').forEach((span) => {
            if (span.id) {
              formData[span.id + "_text"] = span.textContent;
            }
          });

          // Save MDA section visibility states
          document
            .querySelectorAll('[id$="_mda_section"]')
            .forEach((section) => {
              if (section.id) {
                formData[section.id + "_visible"] =
                  section.style.display !== "none";
              }
            });

          // Save investment options visibility
          document
            .querySelectorAll('[id$="_investment_options"]')
            .forEach((section) => {
              if (section.id) {
                formData[section.id + "_visible"] =
                  section.style.display !== "none";
              }
            });

          // Save tranching details visibility - TRIPLE CHECK
          document
            .querySelectorAll('[id$="_tranching_details"]')
            .forEach((section) => {
              if (section.id) {
                formData[section.id + "_visible"] =
                  section.style.display !== "none";
                console.log(
                  "TRIPLE CHECK - Saving tranching details visibility:",
                  section.id,
                  "=",
                  section.style.display !== "none",
                );
              }
            });

          // Save N/A states for all checklist items
          document
            .querySelectorAll(".checklist-item.na-active")
            .forEach((item) => {
              const checkbox = item.querySelector('input[type="checkbox"]');
              if (checkbox && checkbox.id) {
                formData[checkbox.id + "_na_active"] = true;
              }
            });

          // Save MDA N/A state
          const mdaTextarea = document.getElementById("mdaDetails");
          if (mdaTextarea && mdaTextarea.classList.contains("strikethrough")) {
            formData["mdaDetails_na_active"] = true;
          }

          // Save Pricing Calculator N/A state
          const pricingCalculatorItem = document.getElementById(
            "pricingCalculatorItem",
          );
          if (
            pricingCalculatorItem &&
            pricingCalculatorItem.classList.contains("na-active")
          ) {
            formData["pricingCalculator_na_active"] = true;
          }

          // Save Beneficiary Nomination N/A state
          const beneficiaryNominationItem = document.getElementById(
            "beneficiaryNominationItem",
          );
          if (
            beneficiaryNominationItem &&
            beneficiaryNominationItem.classList.contains("na-active")
          ) {
            formData["beneficiaryNomination_na_active"] = true;
          }

          // Save product recommendation section visibility states
          document
            .querySelectorAll('[id$="ProductRecommendationsSection"]')
            .forEach((section) => {
              if (section.id) {
                formData[section.id + "_visible"] =
                  section.style.display === "block";
              }
            });

          // Save which client types are selected for rebuilding dynamic content
          formData["_clientTypes"] = {
            single: singleClientCheckbox.checked,
            couple: coupleClientCheckbox.checked,
            dependants: dependantsClientCheckbox.checked,
            entity: entityClientCheckbox.checked,
            smsf: entitySMSFCheckbox.checked,
            trust: entityTrustCheckbox.checked,
            company: entityCompanyCheckbox.checked,
          };

          // Save client status for rebuilding compliance requirements
          formData["_clientStatus"] = {
            new: newClientRadio.checked,
            existing: existingClientRadio.checked,
          };

          console.log(
            "FINAL - Saving form data with",
            Object.keys(formData).length,
            "fields total",
          );

          // Log all tranching-related keys for debugging
          const tranchingKeys = Object.keys(formData).filter((key) =>
            key.includes("tranching"),
          );
          console.log("FINAL - Tranching-related keys:", tranchingKeys);

          return formData;
        }

        function populateFormData(formData) {
          console.log("Loading form data:", formData); // Debug logging

          // First restore basic form fields
          Object.keys(formData).forEach((key) => {
            if (
              !key.startsWith("_") &&
              !key.endsWith("_na_active") &&
              !key.endsWith("_visible") &&
              !key.endsWith("_BACKUP")
            ) {
              const element = document.getElementById(key);
              if (element) {
                if (element.type === "checkbox" || element.type === "radio") {
                  element.checked = formData[key];
                  if (element.type === "checkbox") {
                    const item = element.closest(".checkbox-item");
                    if (item) {
                      item.classList.toggle("selected", element.checked);
                    }
                  }
                } else {
                  element.value = formData[key];
                }
              }
            }
          });

          // Rebuild form structure based on saved client types and status
          updateFormBasedOnSelections();

          // Wait for dynamic content to be rebuilt, then restore states in MULTIPLE phases
          setTimeout(() => {
            console.log("PHASE 1 - Basic restoration");

            // Phase 1: Restore all basic form fields (except investment options)
            Object.keys(formData).forEach((key) => {
              if (
                !key.startsWith("_") &&
                !key.endsWith("_na_active") &&
                !key.endsWith("_visible") &&
                !key.endsWith("_text") &&
                !key.endsWith("_investment_option") &&
                !key.endsWith("_BACKUP")
              ) {
                const element = document.getElementById(key);
                if (element) {
                  if (element.type === "checkbox" || element.type === "radio") {
                    element.checked = formData[key];
                  } else {
                    element.value = formData[key];
                  }
                }
              }
            });

            // Then re-initialize product features to ensure proper section visibility
            initializeProductFeatures();

            // Wait a bit more, then restore all states again including investment options
            setTimeout(() => {
              console.log(
                "PHASE 2 - Complete restoration with special handling",
              );

              // Restore form fields again (for any that were missed)
              Object.keys(formData).forEach((key) => {
                if (
                  !key.startsWith("_") &&
                  !key.endsWith("_na_active") &&
                  !key.endsWith("_visible") &&
                  !key.endsWith("_text") &&
                  !key.endsWith("_BACKUP")
                ) {
                  const element = document.getElementById(key);
                  if (element) {
                    if (
                      element.type === "checkbox" ||
                      element.type === "radio"
                    ) {
                      element.checked = formData[key];

                      // Handle product recommendation checkboxes specifically
                      if (key.endsWith("ProductRecsCheckbox")) {
                        const checkboxToSectionMap = {
                          client1ProductRecsCheckbox:
                            "client1ProductRecommendationsSection",
                          client2ProductRecsCheckbox:
                            "client2ProductRecommendationsSection",
                          jointProductRecsCheckbox:
                            "jointProductRecommendationsSection",
                          smsfProductRecsCheckbox:
                            "smsfProductRecommendationsSection",
                          trustProductRecsCheckbox:
                            "trustProductRecommendationsSection",
                          companyProductRecsCheckbox:
                            "companyProductRecommendationsSection",
                          dependantsProductRecsCheckbox:
                            "dependantsProductRecommendationsSection",
                        };

                        const sectionId = checkboxToSectionMap[key];
                        const section = document.getElementById(sectionId);
                        if (section) {
                          section.style.display = element.checked
                            ? "block"
                            : "none";
                        }
                      }
                    } else {
                      element.value = formData[key];

                      // Trigger product selection logic for product name fields
                      if (key.endsWith("_name") && element.value) {
                        const productId = key.replace("_name", "");
                        const selectedProduct = element.value;

                        // Show/hide sections based on product selection
                        const customGroup = document.getElementById(
                          `${productId}_custom_group`,
                        );
                        const mdaSection = document.getElementById(
                          `${productId}_mda_section`,
                        );

                        if (selectedProduct === "Custom") {
                          if (customGroup) customGroup.style.display = "block";
                          if (mdaSection) mdaSection.style.display = "none";
                        } else {
                          if (customGroup) customGroup.style.display = "none";

                          // Show MDA section for applicable products
                          if (
                            selectedProduct.includes("BT Panorama") ||
                            selectedProduct.includes("Centric Super Choice") ||
                            selectedProduct === "Centric IDPS"
                          ) {
                            if (mdaSection) {
                              mdaSection.style.display = "block";
                              console.log(
                                "Showing MDA section for product:",
                                selectedProduct,
                              );
                            }
                          }
                        }
                      }
                    }
                  }
                }
              });

              // ULTRA PHASE - Special handling for tranching elements
              setTimeout(() => {
                console.log("ULTRA PHASE - Tranching restoration");

                // Force restore all tranching states
                Object.keys(formData).forEach((key) => {
                  // Handle tranching toggles
                  if (key.endsWith("_tranching") && formData[key]) {
                    const element = document.getElementById(key);
                    if (element) {
                      element.checked = true;
                      const productId = key.replace("_tranching", "");
                      const status = document.getElementById(
                        `${productId}_tranching_status`,
                      );
                      const details = document.getElementById(
                        `${productId}_tranching_details`,
                      );

                      if (status) status.textContent = "Yes";
                      if (details) {
                        details.style.display = "block";
                        console.log(
                          "ULTRA PHASE - Showing tranching details for:",
                          productId,
                        );
                      }
                    }
                  }

                  // Handle MDA toggles
                  if (key.endsWith("_mda") && formData[key]) {
                    const element = document.getElementById(key);
                    if (element) {
                      element.checked = true;
                      const productId = key.replace("_mda", "");
                      const status = document.getElementById(
                        `${productId}_mda_status`,
                      );
                      const investmentOptions = document.getElementById(
                        `${productId}_investment_options`,
                      );
                      const investmentField = document.getElementById(
                        `${productId}_investment`,
                      );

                      if (status) status.textContent = "Yes";
                      if (investmentOptions) {
                        investmentOptions.style.display = "block";
                        console.log(
                          "Showing investment options for:",
                          productId,
                        );

                        // Populate investment options first
                        updateInvestmentOptions(productId);

                        // Then restore the selected investment option value
                        setTimeout(() => {
                          const investmentOptionKey = `${productId}_investment_option`;
                          if (formData[investmentOptionKey]) {
                            const investmentSelect =
                              document.getElementById(investmentOptionKey);
                            if (investmentSelect) {
                              investmentSelect.value =
                                formData[investmentOptionKey];
                              investmentSelect.dispatchEvent(
                                new Event("change"),
                              );
                              console.log(
                                "Restored investment option:",
                                productId,
                                formData[investmentOptionKey],
                              );
                            }
                          }
                        }, 100);
                      }

                      // Restore investment field
                      if (
                        investmentField &&
                        investmentField.value ===
                          "Refer to Investment option below"
                      ) {
                        updateInvestmentOptions(productId);
                      }
                    }
                  }

                  // FORCE restore tranching text with backup handling
                  if (key.endsWith("_tranching_text")) {
                    let textValue = formData[key];

                    // Try backup if main value is empty
                    if (!textValue && formData[key + "_BACKUP"]) {
                      textValue = formData[key + "_BACKUP"];
                      console.log("Using backup value for:", key);
                    }

                    const element = document.getElementById(key);
                    if (element && textValue) {
                      element.value = textValue;
                      console.log(
                        "ULTRA PHASE - Restored tranching text:",
                        key,
                        "=",
                        textValue,
                      );
                    }
                  }
                });

                // Restore all investment option values (final pass)
                setTimeout(() => {
                  Object.keys(formData).forEach((key) => {
                    if (key.endsWith("_investment_option") && formData[key]) {
                      const element = document.getElementById(key);
                      if (element) {
                        element.value = formData[key];
                        console.log(
                          "Final restore of investment option:",
                          key,
                          formData[key],
                        );
                      }
                    }
                  });
                }, 200);

                // Restore status text for toggle switches
                Object.keys(formData).forEach((key) => {
                  if (key.endsWith("_text")) {
                    const statusId = key.replace("_text", "");
                    const statusElement = document.getElementById(statusId);
                    if (statusElement) {
                      statusElement.textContent = formData[key];
                    }
                  }
                });

                // Restore section visibility states
                Object.keys(formData).forEach((key) => {
                  if (key.endsWith("_visible") && formData[key]) {
                    const sectionId = key.replace("_visible", "");
                    const section = document.getElementById(sectionId);
                    if (section) {
                      section.style.display = "block";
                      console.log("Restoring visibility for:", sectionId);
                    }
                  }
                });

                // Restore N/A states
                Object.keys(formData).forEach((key) => {
                  if (key.endsWith("_na_active") && formData[key]) {
                    const originalKey = key.replace("_na_active", "");
                    const element = document.getElementById(originalKey);
                    if (element) {
                      const item = element.closest(".checklist-item");
                      if (item) {
                        item.classList.add("na-active");
                        element.checked = false;

                        // Special handling for super research
                        if (originalKey === "superResearch") {
                          const contributionHistoryItem =
                            document.getElementById("contributionHistoryItem");
                          if (contributionHistoryItem) {
                            contributionHistoryItem.style.display = "none";
                            const contributionCheckbox =
                              document.getElementById("contributionHistory");
                            if (contributionCheckbox) {
                              contributionCheckbox.checked = false;
                            }
                          }
                        }
                      }
                    }
                  }
                });

                // Restore MDA N/A state
                if (formData["mdaDetails_na_active"]) {
                  const mdaTextarea = document.getElementById("mdaDetails");
                  if (mdaTextarea) {
                    mdaTextarea.classList.add("strikethrough");
                    if (!mdaTextarea.value.includes("N/A")) {
                      mdaTextarea.value = "N/A\n" + mdaTextarea.value;
                    }
                  }
                }

                // Restore Pricing Calculator N/A state
                if (formData["pricingCalculator_na_active"]) {
                  const pricingCalculatorItem = document.getElementById(
                    "pricingCalculatorItem",
                  );
                  if (pricingCalculatorItem) {
                    pricingCalculatorItem.classList.add("na-active");
                    const pricingCalculatorCheckbox =
                      document.getElementById("pricingCalculator");
                    if (pricingCalculatorCheckbox) {
                      pricingCalculatorCheckbox.checked = false;
                    }
                  }
                }

                // Restore Beneficiary Nomination N/A state
                if (formData["beneficiaryNomination_na_active"]) {
                  const beneficiaryNominationItem = document.getElementById(
                    "beneficiaryNominationItem",
                  );
                  if (beneficiaryNominationItem) {
                    beneficiaryNominationItem.classList.add("na-active");
                    const beneficiaryNominationCheckbox =
                      document.getElementById("beneficiaryNomination");
                    if (beneficiaryNominationCheckbox) {
                      beneficiaryNominationCheckbox.checked = false;
                    }
                  }
                }

                // Re-setup event listeners for all dynamic content
                setupAutoSaveForNewElements();
                setupProductRecommendationToggles();
                setupMDANAButton(); // Re-initialize MDA N/A button

                console.log(
                  "Form data restoration complete - all product toggles should be working",
                );
              }, 300); // Ultra phase restoration
            }, 200); // Second phase restoration
          }, 500); // First phase restoration
        }

        // Email Document functionality - simplified approach
        emailDocumentBtnBottom.addEventListener("click", function () {
          const clientName =
            document.getElementById("clientName").value || "Client";
          const xplanId = document.getElementById("xplanId").value;

          // Show popup reminder about PDF attachment
          const modal = document.createElement("div");
          modal.className = "modal";
          modal.style.display = "block";
          modal.innerHTML = `
            <div class="modal-content">
                <h3><i class="fas fa-info-circle"></i> Email Document Reminder</h3>
                <p><strong>Before sending the email:</strong></p>
                <ul style="margin: 15px 0; padding-left: 20px; text-align: left;">
                    <li>Please ensure you have downloaded the ARF PDF using "Export to PDF"</li>
                    <li>You will need to manually attach the PDF file to your email</li>
                    ${xplanId ? `<li style="background-color: yellow; padding: 5px; margin: 5px 0; border-radius: 3px;"><strong>IF YOU WANT TO SAVE TO XPLAN CC: ${xplanId.trim()}@findex.xplan.iress.com.au</strong></li>` : "<li>No Xplan ID entered - manually CC if saving to Xplan</li>"}
                </ul>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-success" id="proceedWithEmail">
                        <i class="fas fa-check"></i> OK - Open Email Client
                    </button>
                    <button type="button" class="btn btn-secondary" id="cancelEmail">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        `;
          document.body.appendChild(modal);

          // Handle proceed button
          modal
            .querySelector("#proceedWithEmail")
            .addEventListener("click", function () {
              modal.remove();
              openEmailClient(clientName, xplanId);
            });

          // Handle cancel button
          modal
            .querySelector("#cancelEmail")
            .addEventListener("click", function () {
              modal.remove();
            });

          // Handle clicking outside modal
          modal.addEventListener("click", function (e) {
            if (e.target === modal) {
              modal.remove();
            }
          });
        });

        // Function to open email client with proper CC - FIXED VERSION
        function openEmailClient(clientName, xplanId) {
          const subject = `Findex ARF for ${clientName}`;

          // Build CC email if Xplan ID is provided
          let ccEmail = "";
          let ccNote = "";
          if (xplanId && xplanId.trim()) {
            ccEmail = `${xplanId.trim()}@findex.xplan.iress.com.au`;
            ccNote = `**IF YOU WANT TO SAVE TO XPLAN CC ${ccEmail}**\n\n`;
          }

          const body = `${ccNote}Dear Team,

Please find attached the Financial Advice Request Form (ARF) for ${clientName}.

This document has been prepared for your acknowledgment and further processing.

If you have any questions or require additional information, please don't hesitate to contact me.

Best regards,
${document.getElementById("formCompletedBy").value || "[Your Name]"}`;

          // Create mailto link with proper encoding
          let mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

          // Try multiple approaches to open email client
          let emailOpened = false;

          // Method 1: Direct mailto (most reliable)
          try {
            window.location.href = mailtoLink;
            emailOpened = true;
          } catch (error) {
            console.error("Mailto failed:", error);
          }

          // Method 2: Try Outlook Web if on Windows (as backup)
          if (!emailOpened || navigator.platform.indexOf("Win") > -1) {
            setTimeout(() => {
              try {
                let outlookWebUrl = `https://outlook.office.com/mail/deeplink/compose?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.open(outlookWebUrl, "_blank");
              } catch (error) {
                console.error("Outlook web failed:", error);
              }
            }, 1000);
          }

          // Method 3: Try Outlook desktop protocol (Windows only)
          if (navigator.platform.indexOf("Win") > -1) {
            setTimeout(() => {
              try {
                let outlookDesktopUrl = `outlook:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = outlookDesktopUrl;
              } catch (error) {
                console.error("Outlook desktop failed:", error);
              }
            }, 2000);
          }

          // Show success message with CC info
          let message = "Email client opening...";
          if (ccEmail) {
            message += ` Remember to CC: ${ccEmail}`;
          } else {
            message += " (No Xplan ID - manual CC required if saving to Xplan)";
          }
          showAutoSaveIndicator(message);

          // Follow-up message
          setTimeout(() => {
            showAutoSaveIndicator(
              "If email client didn't open, please check your default email app settings.",
            );
          }, 3000);
        }

        // Export to Word functionality - ENHANCED with compliance sections and better UI
        exportWordBtn.addEventListener("click", function () {
          const clientName =
            document.getElementById("clientName").value || "Client";

          // Build comprehensive Word document content with better formatting
          let wordContent = `
        <div style="text-align: center; margin-bottom: 40px;">
            <h1 style="color: #2c3e50; font-size: 28pt; margin-bottom: 10px; font-weight: bold;">Statement of Advice Request Form</h1>
            <p style="color: #7f8c8d; font-size: 14pt; margin: 0;">Generated on ${new Date().toLocaleDateString()}</p>
        </div>
        `;

          // Process each visible section with enhanced formatting
          document.querySelectorAll(".section").forEach((section) => {
            if (section.style.display !== "none") {
              const h2 = section.querySelector("h2");
              if (h2) {
                // Clean section title (remove icon)
                const sectionTitle = h2.textContent.replace(/^\s*[^\w\s]\s*/, '').trim();
                wordContent += `
                <div style="margin-bottom: 30px; page-break-inside: avoid;">
                    <h2 style="color: #2c3e50; font-size: 20pt; margin-top: 30px; margin-bottom: 20px; 
                               border-bottom: 3px solid #3498db; padding-bottom: 8px; font-weight: bold;">
                        ${sectionTitle}
                    </h2>
                `;
              }

              // Handle dynamic recommendations content first
              const dynamicContainer = section.querySelector("#recommendationsSectionsContainer");
              if (dynamicContainer) {
                const processedProducts = new Set();

                const processProductSection = (sectionEl) => {
                  const title = sectionEl.querySelector("h4");
                  if (title) {
                    wordContent += `<h3 style="color: #34495e; font-size: 16pt; margin-top: 25px; margin-bottom: 15px; font-weight: bold;">${title.textContent}</h3>`;
                  }

                  sectionEl.querySelectorAll(".product-item").forEach((product) => {
                    if (product.style.display !== "none") {
                      const productHeader = product.querySelector("h5");
                      let hasProductContent = false;
                      let productContentHTML = "";

                      product.querySelectorAll("input, textarea, select").forEach((input) => {
                        if (input.value && input.value.trim() !== "" && input.style.display !== "none") {
                          const inputGroup = input.closest(".form-group");
                          const inputLabel = inputGroup ? inputGroup.querySelector("label") : null;

                          if (inputLabel) {
                            let value = input.value;
                            if (input.tagName === "SELECT") {
                              const selected = input.options[input.selectedIndex];
                              value = selected ? selected.text : "";
                            }
                            if (input.type === "checkbox") {
                              const statusSpan = input.parentElement.nextElementSibling;
                              value = statusSpan ? statusSpan.textContent : input.checked ? "Yes" : "No";
                            }
                            if (value && value !== "Select investment option" && value !== "" && value !== "Type to search products") {
                              hasProductContent = true;
                              productContentHTML += `
                                <div style="margin-left: 20px; margin-bottom: 10px;">
                                    <strong style="color: #2c3e50;">${inputLabel.textContent}</strong><br>
                                    <div style="background-color: #f8f9fa; padding: 8px; border-left: 3px solid #3498db; margin-top: 5px;">
                                        ${value}
                                    </div>
                                </div>
                              `;
                            }
                          }
                        }
                      });

                      if (hasProductContent && productHeader) {
                        wordContent += `
                          <h4 style="color: #34495e; font-size: 14pt; margin-top: 20px; margin-bottom: 15px; 
                                     background-color: #ecf0f1; padding: 10px; border-radius: 5px;">${productHeader.textContent}</h4>
                          ${productContentHTML}
                        `;
                      }
                    }
                  });
                };

                Array.from(dynamicContainer.children).forEach((child) => {
                  if (child.style.display === "none") return;

                  if (child.classList.contains("recommendation-section")) {
                    const textareaDiv = child.querySelector(".recommendation-textarea");
                    const riskDiv = child.querySelector(".risk-profile-inline");

                    if (textareaDiv) {
                      const label = textareaDiv.querySelector("label");
                      const textarea = textareaDiv.querySelector("textarea");

                      if (label && textarea && textarea.value && textarea.value.trim() !== "") {
                        wordContent += `
                          <div style="margin-bottom: 20px;">
                              <h4 style="color: #2c3e50; font-size: 14pt; margin-bottom: 10px;">${label.textContent}</h4>
                              <div style="border: 1px solid #bdc3c7; padding: 15px; background-color: #f8f9fa; 
                                          border-radius: 5px; white-space: pre-wrap; line-height: 1.6;">
                                  ${textarea.value}
                              </div>
                          </div>
                        `;
                      }
                    }

                    if (riskDiv) {
                      const riskLabel = riskDiv.querySelector("label");
                      const riskSelect = riskDiv.querySelector("select");

                      if (riskLabel && riskSelect && riskSelect.value && riskSelect.value.trim() !== "") {
                        const selected = riskSelect.options[riskSelect.selectedIndex];
                        if (selected && selected.text && selected.text !== "Select Risk Profile") {
                          wordContent += `
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #2c3e50;">${riskLabel.textContent}</strong>
                                <span style="background-color: #e8f5e8; padding: 5px 10px; border-radius: 3px; margin-left: 10px;">
                                    ${selected.text}
                                </span>
                            </div>
                          `;
                        }
                      }
                    }

                    const next = child.nextElementSibling;
                    if (next && next.classList.contains("product-recommendations") && next.style.display !== "none") {
                      processProductSection(next);
                      processedProducts.add(next);
                    }
                  } else if (child.classList.contains("product-recommendations") && !processedProducts.has(child)) {
                    processProductSection(child);
                  }
                });
              }

              // Process regular form groups with enhanced formatting
              section.querySelectorAll(".form-group").forEach((group) => {
                if (group.style.display !== "none" && !group.closest("#recommendationsSectionsContainer")) {
                  const label = group.querySelector("label");

                  // Process radio groups
                  const radioGroup = group.querySelector(".radio-group");
                  if (radioGroup) {
                    const checkedRadio = radioGroup.querySelector('input[type="radio"]:checked');
                    if (checkedRadio && label) {
                      wordContent += `
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #2c3e50; font-size: 12pt;">${label.textContent}</strong><br>
                            <div style="margin-left: 20px; margin-top: 8px;">
                      `;
                      const radioLabel = checkedRadio.nextElementSibling;
                      if (radioLabel) {
                        wordContent += `<span style="color: #27ae60;"> ${radioLabel.textContent}</span>`;
                      }
                      wordContent += `</div></div>`;
                    }
                  }

                  // Process checkbox groups
                  const checkboxGroup = group.querySelector(".checkbox-group");
                  if (checkboxGroup) {
                    const checkedBoxes = checkboxGroup.querySelectorAll('input[type="checkbox"]:checked');
                    if (checkedBoxes.length > 0 && label) {
                      wordContent += `
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #2c3e50; font-size: 12pt;">${label.textContent}</strong><br>
                            <div style="margin-left: 20px; margin-top: 8px;">
                      `;
                      checkedBoxes.forEach((checkbox) => {
                        const checkboxLabel = checkbox.nextElementSibling;
                        if (checkboxLabel) {
                          wordContent += `<div style="margin-bottom: 5px;"><span style="color: #27ae60;"></span> ${checkboxLabel.textContent}</div>`;
                        }
                      });
                      wordContent += `</div></div>`;
                    }
                  }

                  // Process regular inputs
                  group.querySelectorAll('input[type="text"], input[type="date"], input[type="number"], textarea, select').forEach((input) => {
                    if (input.style.display !== "none" && 
                        !input.closest(".checkbox-group") && 
                        !input.closest(".radio-group") && 
                        !input.closest(".btn-group") && 
                        !input.closest(".product-item") && 
                        !input.closest(".recommendation-header") && 
                        input.value && input.value.trim() !== "") {
                      
                      const inputLabelEl = input.closest(".form-group").querySelector("label");
                      let labelText = inputLabelEl ? inputLabelEl.textContent : "";
                      
                      if (labelText) {
                        let value = input.value;
                        if (input.tagName === "SELECT") {
                          const selected = input.options[input.selectedIndex];
                          value = selected ? selected.text : "";
                        }
                        if (value && value.trim() !== "" && value !== "Select a saved draft...") {
                          wordContent += `
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #2c3e50; font-size: 12pt;">${labelText}</strong><br>
                                <div style="border: 1px solid #bdc3c7; padding: 12px; background-color: #f8f9fa; 
                                            border-radius: 5px; margin-top: 8px; white-space: pre-wrap; line-height: 1.6;">
                                    ${value}
                                </div>
                            </div>
                          `;
                        }
                      }
                    }
                  });

                  // Process toggle switches
                  group.querySelectorAll(".yes-no-label").forEach((toggleGroup) => {
                    const toggleLabel = toggleGroup.querySelector("label");
                    const toggleInput = toggleGroup.querySelector('input[type="checkbox"]');
                    if (toggleLabel && toggleInput) {
                      const status = toggleInput.checked ? "Yes" : "No";
                      const statusColor = toggleInput.checked ? "#27ae60" : "#e74c3c";
                      wordContent += `
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #2c3e50; font-size: 12pt;">${toggleLabel.textContent}</strong>
                            <span style="background-color: ${statusColor}; color: white; padding: 4px 12px; 
                                         border-radius: 15px; margin-left: 15px; font-weight: bold;">
                                ${status}
                            </span>
                        </div>
                      `;
                    }
                  });
                }
              });

              // ALWAYS INCLUDE COMPLIANCE SECTIONS with comprehensive checklist display
              if (section.id === "checklistSection") {
                wordContent += `
                  <div style="margin-top: 25px;">
                      <h3 style="color: #e67e22; font-size: 16pt; margin-bottom: 15px; font-weight: bold;">
                          All Advice Documents
                      </h3>
                `;

                // Always show the static checklist items
                const staticItems = [
                  { id: "factFind", label: "Fact Find (dated within 12 months)" },
                  { id: "filenote", label: "Filenote" },
                  { id: "pricingCalculator", label: "Pricing Calculator" },
                  { id: "beneficiaryNomination", label: "Beneficiary nomination advice made (if relevant)" }
                ];

                staticItems.forEach(item => {
                  const checkbox = document.getElementById(item.id);
                  const checklistItem = checkbox ? checkbox.closest(".checklist-item") : null;
                  const isNA = checklistItem ? checklistItem.classList.contains("na-active") : false;
                  const isChecked = checkbox ? checkbox.checked : false;
                  
                  let status, statusColor, statusBg;
                  if (isNA) {
                    status = "N/A";
                    statusColor = "#95a5a6";
                    statusBg = "#ecf0f1";
                  } else if (isChecked) {
                    status = " Complete";
                    statusColor = "#27ae60";
                    statusBg = "#d5f4e6";
                  } else {
                    status = " Pending";
                    statusColor = "#e74c3c";
                    statusBg = "#fadbd8";
                  }

                  wordContent += `
                    <div style="display: flex; align-items: center; margin-bottom: 8px; padding: 8px; 
                                background-color: ${statusBg}; border-radius: 5px;">
                        <span style="color: ${statusColor}; font-weight: bold; margin-right: 10px; min-width: 100px;">
                            ${status}
                        </span>
                        <span style="color: #2c3e50;">${item.label}</span>
                    </div>
                  `;
                });

                wordContent += `
                  </div>
                  <div style="margin-top: 25px;">
                      <h3 style="color: #e67e22; font-size: 16pt; margin-bottom: 15px; font-weight: bold;">
                          Compliance Requirements
                      </h3>
                `;

                // Show compliance requirements based on client status
                const complianceContainer = document.getElementById("complianceRequirements");
                if (complianceContainer) {
                  complianceContainer.querySelectorAll(".checklist-item").forEach((item) => {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    const checkboxLabel = item.querySelector("label");
                    
                    if (checkbox && checkboxLabel) {
                      const isNA = item.classList.contains("na-active");
                      const isChecked = checkbox.checked;
                      
                      let status, statusColor, statusBg;
                      if (isNA) {
                        status = "N/A";
                        statusColor = "#95a5a6";
                        statusBg = "#ecf0f1";
                      } else if (isChecked) {
                        status = " Complete";
                        statusColor = "#27ae60";
                        statusBg = "#d5f4e6";
                      } else {
                        status = " Pending";
                        statusColor = "#e74c3c";
                        statusBg = "#fadbd8";
                      }

                      wordContent += `
                        <div style="display: flex; align-items: center; margin-bottom: 8px; padding: 8px; 
                                    background-color: ${statusBg}; border-radius: 5px;">
                            <span style="color: ${statusColor}; font-weight: bold; margin-right: 10px; min-width: 100px;">
                                ${status}
                            </span>
                            <span style="color: #2c3e50;">${checkboxLabel.textContent}</span>
                        </div>
                      `;
                    }
                  });
                } else {
                  wordContent += `
                    <div style="padding: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
                        <em style="color: #856404;">Compliance requirements will be determined based on client status selection.</em>
                    </div>
                  `;
                }

                wordContent += `</div>`;
              }

              wordContent += `</div>`;
            }
          });

          // Create enhanced Word document with better styling
          const html = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
            <head>
                <meta charset="utf-8">
                <title>Financial Advice Request Form - ${clientName}</title>
                <style>
                    body { 
                        font-family: 'Segoe UI', Calibri, Arial, sans-serif; 
                        line-height: 1.6; 
                        color: #2c3e50; 
                        margin: 30px; 
                        background: white;
                        font-size: 11pt;
                    }
                    h1 { 
                        font-size: 28pt; 
                        margin-bottom: 30pt; 
                        text-align: center;
                        color: #2c3e50;
                        font-weight: bold;
                    }
                    h2 { 
                        font-size: 20pt; 
                        margin-top: 30pt; 
                        margin-bottom: 20pt; 
                        color: #2c3e50;
                        border-bottom: 3px solid #3498db;
                        padding-bottom: 8pt;
                        font-weight: bold;
                    }
                    h3 { 
                        font-size: 16pt; 
                        margin-top: 25pt; 
                        margin-bottom: 15pt; 
                        color: #34495e;
                        font-weight: bold;
                    }
                    h4 { 
                        font-size: 14pt; 
                        margin-top: 20pt; 
                        margin-bottom: 15pt; 
                        color: #34495e;
                        font-weight: bold;
                    }
                    p { margin-bottom: 12pt; }
                    div { margin-bottom: 10pt; }
                    strong { color: #2c3e50; font-weight: bold; }
                    @page { 
                        margin: 1in; 
                        font-size: 11pt;
                    }
                    .status-complete { background-color: #d5f4e6; color: #27ae60; }
                    .status-pending { background-color: #fadbd8; color: #e74c3c; }
                    .status-na { background-color: #ecf0f1; color: #95a5a6; }
                </style>
            </head>
            <body>
                ${wordContent}
                <div style="margin-top: 40px; text-align: center; border-top: 2px solid #bdc3c7; padding-top: 20px;">
                    <p style="color: #7f8c8d; font-size: 10pt; margin: 0;">
                        Document generated on ${new Date().toLocaleString()} | Financial Advice Request Form
                    </p>
                </div>
            </body>
            </html>
        `;

          const blob = new Blob([html], { type: "application/msword" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `Financial_Advice_Request_Form_${clientName.replace(/[^a-zA-Z0-9]/g, "_")}.doc`;
          a.click();
          URL.revokeObjectURL(url);

          showAutoSaveIndicator("Enhanced Word document exported successfully!");
        });

        // Export to PDF functionality - FIXED to show ALL textarea content properly
        exportPdfBtn.addEventListener("click", function () {
          console.log("=== STARTING PDF EXPORT ===");

          // Step 1: Hide elements that shouldn't be in PDF
          const elementsToHide = document.querySelectorAll(
            ".draft-selector, .auto-save-indicator, .modal, .btn-group, .no-print",
          );
          const originalDisplays = [];

          elementsToHide.forEach((el) => {
            originalDisplays.push(el.style.display);
            el.style.display = "none";
          });

          // Step 2: AGGRESSIVE TEXTAREA EXPANSION - Make ALL textareas show full content
          const allTextareas = document.querySelectorAll("textarea");
          const originalTextareaStyles = [];

          console.log("Found", allTextareas.length, "textareas to expand");

          allTextareas.forEach((textarea, index) => {
            // Save ALL original styles
            originalTextareaStyles[index] = {
              height: textarea.style.height,
              minHeight: textarea.style.minHeight,
              maxHeight: textarea.style.maxHeight,
              overflow: textarea.style.overflow,
              resize: textarea.style.resize,
              boxSizing: textarea.style.boxSizing,
              padding: textarea.style.padding,
              border: textarea.style.border,
              lineHeight: textarea.style.lineHeight,
            };

            // FORCE reset to auto for accurate measurement
            textarea.style.height = "auto";
            textarea.style.minHeight = "auto";
            textarea.style.maxHeight = "none";
            textarea.style.overflow = "visible";
            textarea.style.resize = "none";
            textarea.style.boxSizing = "border-box";

            // Force a reflow to get accurate measurements
            textarea.offsetHeight;

            // Calculate the required height with extra padding for safety
            const scrollHeight = textarea.scrollHeight;
            const computedStyle = window.getComputedStyle(textarea);
            const paddingTop = parseInt(computedStyle.paddingTop);
            const paddingBottom = parseInt(computedStyle.paddingBottom);
            const borderTop = parseInt(computedStyle.borderTopWidth);
            const borderBottom = parseInt(computedStyle.borderBottomWidth);

            // Calculate total height needed (content + padding + borders + extra space)
            const totalHeight =
              scrollHeight +
              paddingTop +
              paddingBottom +
              borderTop +
              borderBottom +
              20;

            // Set the calculated height
            textarea.style.height = totalHeight + "px";
            textarea.style.minHeight = totalHeight + "px";

            console.log(
              `Expanded textarea ${index}: scrollHeight: ${scrollHeight}, totalHeight: ${totalHeight}px`,
            );
          });

          // Step 3: Hide empty form groups and sections to clean up the export
          const allFormGroups = document.querySelectorAll(".form-group");
          const hiddenFormGroups = [];

          allFormGroups.forEach((group, index) => {
            const inputs = group.querySelectorAll(
              'input[type="text"], input[type="date"], input[type="number"], textarea, select',
            );
            const checkboxes = group.querySelectorAll(
              'input[type="checkbox"]:checked',
            );
            const radios = group.querySelectorAll(
              'input[type="radio"]:checked',
            );

            let hasContent = false;

            // Check if any inputs have values
            inputs.forEach((input) => {
              if (
                input.value &&
                input.value.trim() !== "" &&
                input.value !== "Select a saved draft..."
              ) {
                hasContent = true;
              }
            });

            // Check if any checkboxes are checked
            if (checkboxes.length > 0) hasContent = true;

            // Check if any radios are checked
            if (radios.length > 0) hasContent = true;

            // Hide empty form groups (but keep important structural ones)
            if (
              !hasContent &&
              !group.querySelector(".radio-group") &&
              !group.querySelector(".checkbox-group") &&
              !group.querySelector("h3, h4")
            ) {
              hiddenFormGroups.push({
                element: group,
                originalDisplay: group.style.display,
              });
              group.style.display = "none";
            }
          });

          // Step 4: Add enhanced PDF-specific styles
          const pdfStyle = document.createElement("style");
          pdfStyle.id = "pdf-export-style";
          pdfStyle.textContent = `
            @media print {
                body { 
                    background: white !important; 
                    padding: 0 !important; 
                    font-size: 12pt !important;
                    color: black !important;
                }
                .container { 
                    box-shadow: none !important; 
                    max-width: 100% !important; 
                    margin: 0 !important; 
                    padding: 15px !important;
                    background: white !important;
                }
                .section { 
                    page-break-inside: avoid !important; 
                    margin-bottom: 15pt !important;
                    background: white !important;
                    box-shadow: none !important;
                }
                textarea {
                    border: 1px solid #333 !important;
                    background: white !important;
                    overflow: visible !important;
                    resize: none !important;
                    page-break-inside: avoid !important;
                    font-family: inherit !important;
                    font-size: 11pt !important;
                    line-height: 1.3 !important;
                    color: black !important;
                    white-space: pre-wrap !important;
                    word-wrap: break-word !important;
                }
                input[type="text"], input[type="date"], input[type="number"] {
                    border: 1px solid #333 !important;
                    background: white !important;
                    color: black !important;
                    font-size: 11pt !important;
                }
                select {
                    border: 1px solid #333 !important;
                    background: white !important;
                    color: black !important;
                    font-size: 11pt !important;
                }
                .product-item {
                    page-break-inside: avoid !important;
                    margin-bottom: 10pt !important;
                    border: 1px solid #333 !important;
                    background: white !important;
                }
                .checklist-item {
                    page-break-inside: avoid !important;
                    background: #f5f5f5 !important;
                }
                .no-print, .btn-group, .draft-selector, .auto-save-indicator {
                    display: none !important;
                }
                h1, h2, h3, h4 {
                    color: black !important;
                    page-break-after: avoid !important;
                }
                label {
                    color: black !important;
                    font-weight: bold !important;
                }
            }
        `;
          document.head.appendChild(pdfStyle);

          // Step 5: Set document title for PDF filename
          const originalTitle = document.title;
          const clientName =
            document.getElementById("clientName").value || "Client";
          document.title = `Financial_Advice_Request_Form_${clientName.replace(/[^a-zA-Z0-9]/g, "_")}`;

          console.log("PDF setup complete - triggering print dialog");

          // Step 6: Trigger print dialog with longer delay to ensure all rendering is complete
          setTimeout(() => {
            window.print();
          }, 1000);

          // Step 7: Comprehensive cleanup after print
          const cleanupAfterPrint = () => {
            console.log("=== CLEANING UP AFTER PDF EXPORT ===");

            // Remove PDF styles
            const pdfStyleElement = document.getElementById("pdf-export-style");
            if (pdfStyleElement) {
              pdfStyleElement.remove();
            }

            // Restore original title
            document.title = originalTitle;

            // Restore hidden elements
            elementsToHide.forEach((el, index) => {
              el.style.display = originalDisplays[index];
            });

            // RESTORE ALL TEXTAREA STYLES
            allTextareas.forEach((textarea, index) => {
              if (originalTextareaStyles[index]) {
                const originalStyles = originalTextareaStyles[index];
                textarea.style.height = originalStyles.height || "";
                textarea.style.minHeight = originalStyles.minHeight || "";
                textarea.style.maxHeight = originalStyles.maxHeight || "";
                textarea.style.overflow = originalStyles.overflow || "";
                textarea.style.resize = originalStyles.resize || "";
                textarea.style.boxSizing = originalStyles.boxSizing || "";
                textarea.style.padding = originalStyles.padding || "";
                textarea.style.border = originalStyles.border || "";
                textarea.style.lineHeight = originalStyles.lineHeight || "";
              }
              console.log(`Restored textarea ${index} to original styles`);
            });

            // Restore hidden form groups
            hiddenFormGroups.forEach(({ element, originalDisplay }) => {
              element.style.display = originalDisplay;
            });

            console.log("=== PDF EXPORT CLEANUP COMPLETE ===");
            showAutoSaveIndicator(
              "PDF export complete - all elements restored!",
            );
          };

          // Listen for print events
          window.addEventListener("afterprint", cleanupAfterPrint, {
            once: true,
          });

          // Fallback cleanup after 20 seconds (in case print dialog is cancelled)
          setTimeout(cleanupAfterPrint, 20000);
        });

        // Reset Form functionality
        resetBtn.addEventListener("click", function () {
          if (
            confirm(
              "Are you sure you want to reset the form? All entered data will be lost.",
            )
          ) {
            console.log("=== RESETTING FORM ===");

            // STEP 1: Reset ALL form fields
            document
              .querySelectorAll(
                'input[type="text"], input[type="date"], input[type="number"], textarea',
              )
              .forEach((field) => {
                field.value = "";
                if (field.tagName === "TEXTAREA") {
                  field.style.height = "auto";
                }
              });

            // STEP 2: Reset ALL checkboxes and radios
            document
              .querySelectorAll('input[type="checkbox"]')
              .forEach((checkbox) => {
                checkbox.checked = false;
              });

            document
              .querySelectorAll('input[type="radio"]')
              .forEach((radio) => {
                radio.checked = false;
              });

            // STEP 3: Reset ALL selects
            document.querySelectorAll("select").forEach((select) => {
              select.selectedIndex = 0;
            });

            // STEP 4: Reset ALL checkbox visual states
            document.querySelectorAll(".checkbox-item").forEach((item) => {
              item.classList.remove("selected");
            });

            // STEP 5: Reset ALL checklist N/A states
            document.querySelectorAll(".checklist-item").forEach((item) => {
              item.classList.remove("na-active");
            });

            // STEP 6: Reset MDA N/A state
            const mdaTextarea = document.getElementById("mdaDetails");
            if (mdaTextarea) {
              mdaTextarea.classList.remove("strikethrough");
            }

            // STEP 7: Hide ALL conditional sections completely
            partnerNameGroup.style.display = "none";
            entityNameGroup.style.display = "none";
            smsfNameGroup.style.display = "none";
            trustNameGroup.style.display = "none";
            companyNameGroup.style.display = "none";
            entitySelector.style.display = "none";

            // STEP 8: Hide ALL product recommendation sections
            document
              .querySelectorAll('[id$="ProductRecommendationsSection"]')
              .forEach((section) => {
                section.style.display = "none";
              });

            // STEP 9: COMPLETELY clear ALL dynamic content containers
            const recommendationsContainer = document.getElementById(
              "recommendationsSectionsContainer",
            );
            const dynamicFeesContainer = document.getElementById(
              "dynamicFeesContainer",
            );
            const complianceContainer = document.getElementById(
              "complianceRequirements",
            );

            if (recommendationsContainer) {
              recommendationsContainer.innerHTML = "";
              console.log("Cleared recommendations container");
            }
            if (dynamicFeesContainer) {
              dynamicFeesContainer.innerHTML = "";
              console.log("Cleared dynamic fees container");
            }
            if (complianceContainer) {
              complianceContainer.innerHTML = "";
              console.log("Cleared compliance container");
            }

            // STEP 10: Reset specific UI elements to defaults
            flowchartRequiredToggle.checked = false;
            flowchartStatus.textContent = "No";
            projectionDateLength.value = "lifeExpectancy";
            otherProjectionLength.style.display = "none";

            // STEP 11: Reset projection visibility to default state
            const customProjectionInstructions = document.getElementById(
              "customProjectionInstructions",
            );
            const projectionOptionsGroup = document.getElementById(
              "projectionOptionsGroup",
            );
            if (customProjectionInstructions)
              customProjectionInstructions.style.display = "block";
            if (projectionOptionsGroup)
              projectionOptionsGroup.style.display = "block";

            // STEP 12: Reset special checkboxes
            paraplannerCompareCheckbox.checked = false;
            alternativePlatformsTextarea.value = "";
            tmdInFilenoteCheckbox.checked = false;
            ongoingFeeReferCheckbox.checked = false;

            // STEP 13: Force update form to ensure clean state
            // This will rebuild everything from scratch based on the reset selections
            updateFormBasedOnSelections();

            console.log("=== FORM RESET COMPLETE ===");
            showAutoSaveIndicator("Form has been reset!");
          }
        });

        // Initial form update
        updateFormBasedOnSelections();

        // Setup auto-save for existing elements
        setupAutoSave();

        // Initialize MDA N/A button
        setupMDANAButton();

        // Setup N/A buttons for static elements
        setupNAButtons();
      });
    </script>
  </body>
</html>
